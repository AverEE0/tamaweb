const App={PI2:2*Math.PI,INF:999999999,deltaTime:0,lastTime:0,playTime:0,hour:12,accurateDeltaTime:0,mouse:{x:0,y:0,isInBounds:!1},userId:"_",userName:null,sessionId:Math.round(9999999999*Math.random()),ENV:5500==location.port?"dev":"prod",isOnItch:!1,isOnElectronClient:!1,isMiniApp:!("undefined"==typeof window||!window.Telegram||!window.Telegram.WebApp),shellBackground:"",deferredInstallPrompt:null,gameEventsHistory:{},misc:{},mods:[],records:{},temp:{},ownedFurniture:[],plants:[],animals:{treat:null,list:[],nextAttractMs:0,treatBiteCount:0},settings:{screenSize:1,playSound:!0,vibrate:!0,displayShell:!0,displayShellButtons:!0,displayShellLogo:!0,shellShape:6,backgroundColor:"#FFDEAD",backgroundPattern:"resources/img/ui/bg_pattern_01.png",notifications:!1,automaticAging:!0,sleepingHoursOffset:0,classicMainMenuUI:!1,isTester:!1,theme:!1,shellAdditionalSize:0,showWantName:!0,genderedPets:!1,playMusic:!0,skillsAffectingEvolution:!0,season:"auto"},constants:{ONE_HOUR:36e5,ONE_MINUTE:6e4,ONE_SECOND:1e3,AUTO_SAVE_INTERVAL_SECS:6,FOOD_SPRITESHEET:"resources/img/item/foods_on.png",FOOD_SPRITESHEET_DIMENSIONS:{cellNumber:1,cellSize:24,rows:33,columns:33},ITEM_SPRITESHEET:"resources/img/item/items.png",ITEM_SPRITESHEET_DIMENSIONS:{cellNumber:1,cellSize:22,rows:10,columns:10},PLANT_SPRITESHEET:"resources/img/item/plants.png",PLANT_SPRITESHEET_DIMENSIONS:{cellNumber:1,cellSize:24,rows:28,columns:28},MISC_SPRITESHEET:"resources/img/item/misc.png",MISC_SPRITESHEET_DIMENSIONS:{cellNumber:1,cellSize:24,rows:33,columns:33},MAX_ANIMALS:16,MAX_PLANTS:8,MIN_REVIVE_GOLDS:250,MAX_REVIVE_GOLDS:1e3,SKILL_EVOLUTION_EFFECTIVENESS:{bounds:30,ratings:{endurance:1,logic:2,expression:3}},SLEEP_START:21,SLEEP_END:8,PARENT_DAYCARE_START:8,PARENT_DAYCARE_END:18,MAX_SHELL_SHAPES:6,AFTERNOON_TIME:[12,17],EVENING_TIME:[17,20],NIGHT_TIME:[20,6],CHRISTMAS_TIME:{start:"12-14",end:"12-31",absDay:"12-25"},MANUAL_AGE_HOURS_BABY:1,MANUAL_AGE_HOURS_CHILD:9,MANUAL_AGE_HOURS_TEEN:12,MANUAL_AGE_HOURS_ADULT:72,AUTO_AGE_HOURS_BABY:24,AUTO_AGE_HOURS_CHILD:36,AUTO_AGE_HOURS_TEEN:48,AUTO_AGE_HOURS_ADULT:336,WANT_TYPES:{food:"food",playdate:"playdate",item:"item",minigame:"minigame",fulfilled:"fulfilled"},CHAR_UNLOCK_PREFIX:"ch_unl",FEEDING_PICKINESS:{refeedingTolerance:10,bufferSize:16},ONLINE_FOOD_ORDER_MARKUP:2,ACTIVE_PET_Z:5,NPC_PET_Z:4.6,MAX_PLACED_FURNITURE:6,POOP_POSITIONS:[{x:"75%",y:"78%",z:4.59},{x:"85%",y:"84%",z:4.592},{x:"25%",y:"80%",z:4.593},{x:"15%",y:"82%",z:4.594}],ACTIVE_ITEM_Z:4.595,CHRISTMAS_TREE_Z:4.58,BACKGROUND_Z:-10,INPUT_BASE_64:"0xffbx64",SCHOOL:{maxClassesPerDay:10,resetTime:{hour:7,minute:0,second:0}},MAX_OFFLINE_PROGRESSION_SECS:604800,GENDERS:["mars","venus","transgender","genderless","mercury","neuter","venus-mars"],UNDERWORLD_TREAT_CURRENCY:"spookandy",SPANS:{monster:'<div> <img class="icon" src="resources/img/misc/devil_icon.png"></img> <b style="color: red;">monster</b> </div>',angel:'<div> <img class="icon" src="resources/img/misc/angel_icon.png"></img> <b style="color: forestgreen;">angel</b> </div>'},SEASON_COLORS:{source:{shadow0:"#C016B2",shadow1:"#C017B2",base:"#EF1CDE",highlight:"#F248E4"},winter:["#C6DDFF","#E8F1FF","#FFFFFF"],autumn:["#CE4429","#ED782F","#FF9D60"],spring:["#63A04B","#7FD060","#96F271"]}},routes:{BLOG:"https://tamawebgame.github.io/blog/",ITCH_REVIEW:"https://samandev.itch.io/tamaweb/rate?source=game",DISCORD:"https://tamawebgame.github.io/discord"},async init(){this.registerLoadEvents(),-1!==location.host.indexOf("itch")&&(App.isOnItch=!0),"electron-client"==navigator?.userAgent&&(App.isOnElectronClient=!0),this.initSound(),App.drawer=new Drawer(document.querySelector(".graphics-canvas")),Object2d.setDrawer(App.drawer),moment.relativeTimeThreshold("m",59);const loadedData=await this.handleSequentiallyLoad([App.load]);if(console.log({loadedData:loadedData}),!loadedData)return;loadedData?.eventsHistory&&(App.gameEventsHistory=loadedData.eventsHistory),App.records=loadedData.records,this.setShellBackground(loadedData?.shellBackground),this.loadMods(loadedData.mods),loadedData.settings&&Object.assign(this.settings,loadedData.settings),this.applySettings(),loadedData.furniture&&(this.ownedFurniture=loadedData.furniture),loadedData.plants&&(this.plants=loadedData.plants.map(p=>new Plant(p))),loadedData.animals&&(this.animals={...loadedData.animals,list:loadedData.animals.list.map(a=>new AnimalDefinition(a))});const forPreload=[...SPRITES,...PET_ELDER_CHARACTERS,...PET_ADULT_CHARACTERS,...PET_TEEN_CHARACTERS,...PET_CHILD_CHARACTERS,...PET_BABY_CHARACTERS,...NPC_CHARACTERS,...ANIMAL_CHARACTERS];this.preloadedResources={};if((await this.preloadImages(forPreload)).forEach((resource,i)=>{const name=forPreload[i];this.preloadedResources[name]=resource}),App.background=new Object2d({image:null,x:0,y:0,width:96,height:96,z:App.constants.BACKGROUND_Z,noPreload:Boolean(App.mods.length),static:!0}),App.foods=new Object2d({image:App.preloadedResources[App.constants.FOOD_SPRITESHEET],x:10,y:10,width:12,height:12,scale:24,spritesheet:{cellNumber:2,cellSize:24,rows:33,columns:33},hidden:!0}),App.uiFood=document.createElement("c-sprite"),App.uiFood.setAttribute("width",24),App.uiFood.setAttribute("height",24),App.uiFood.setAttribute("index",0),App.uiFood.setAttribute("src",App.constants.FOOD_SPRITESHEET),App.uiFood.setAttribute("class","ui-food"),App.uiFood.style.visibility="hidden",document.querySelector(".graphics-wrapper").appendChild(App.uiFood),App.darkOverlay=new Object2d({img:"resources/img/background/house/dark_overlay.png",x:0,y:0,z:11,opacity:.85,composite:"source-atop",static:!0,opacity:0,isVisible:!1,onDraw:me=>{const targetOpacity=App.pet.stats.is_sleeping&&"sleeping"===App.pet.state?1:0,currentOpacity=lerp(me.opacity,targetOpacity,.015*App.deltaTime);me.opacity=clamp(currentOpacity,0,1),me.isVisible=me.opacity>.2}}),App.sky=new Object2d({image:App.preloadedResources["resources/img/background/sky/night.png"],x:0,y:0,z:99999,composite:"destination-over",static:!0}),App.skyOverlay=new Object2d({image:App.preloadedResources["resources/img/background/sky/night_overlay.png"],x:0,y:0,z:999,composite:"source-atop",opacity:1,static:!0}),App.skyWeather=new Object2d({image:App.preloadedResources["resources/img/background/sky/rain_01.png"],x:0,y:0,z:999.1,composite:"xor",static:!0,flipSpeed:200,onDraw:me=>{Object2d.animations.flip(me,me.flipSpeed)}}),App.petDefinition=new PetDefinition({name:getRandomName(),sprite:randomFromArray(PET_BABY_CHARACTERS)}).setStats({is_egg:!0}).loadStats(loadedData.pet).loadAccessories(loadedData.accessories),App.settings.automaticAging)for(;moment().isAfter(App.petDefinition.getNextAutomaticBirthdayDate());)App.petDefinition.ageUp(),App.sendAnalytics("auto_age_up",App.petDefinition.lifeStage);if(App.petDefinition.stats.is_sleeping||App.isTester()||(App.petDefinition.stats.is_sleeping=App.isSleepHour()&&!loadedData.pet?.stats?.is_egg),App.pet=App.createActivePet(App.petDefinition,{state:""}),loadedData.pet&&Object.keys(loadedData.pet).length||setTimeout(()=>{Activities.playEggUfoAnimation(()=>App.handlers.show_set_pet_name_dialog())},100),App.setScene(App.scene.home),this.applySky(),App.pet.stats.current_rabbit_hole.name&&Activities.goToCurrentRabbitHole(!1),loadedData.lastTime){let elapsedTime=Date.now()-loadedData.lastTime;"dev"!==App.ENV&&App.pet.simulateOfflineProgression(elapsedTime);let message,awaySeconds=Math.round(elapsedTime/1e3),awayMinutes=Math.round(awaySeconds/60),awayHours=Math.round(awayMinutes/60);message=awaySeconds<60?`${awaySeconds} seconds`:awayMinutes<60?`${awayMinutes} minutes`:`${awayHours} hours`,App.awayTime=message,awaySeconds>30&&"dev"!==App.ENV&&App.displayConfirm(`С возвращением!\n<b>${App.petDefinition.name}</b> скучал(а) по тебе всё это <b>${message}</b>`,[{name:"ok",onclick:()=>{}}])}Missions.init(loadedData.missions),this.applyRoomCustomizations(loadedData.roomCustomizations),App.pet.stats.is_at_parents&&Activities.stayAtParents(),App.pet.stats.is_at_vacation&&Activities.seaVacation(),this.handleInGameEvents(),App.runRandomEncounters(),App.registerInputUpdates(),setTimeout(()=>{UI.fadeOut(document.querySelector(".loading-text")),App.loadingEnded=!0},50),this.initRudderStack(),App.sendSessionEvent(!0),setInterval(()=>{App.save(!0)},1e3*App.constants.AUTO_SAVE_INTERVAL_SECS)},initRudderStack:function(){rudderanalytics.identify(App.userId,{username:App.userName,petName:App.petDefinition?.name,playTime:App.playTime,isOnItch:App.isOnItch})},registerInputUpdates:function(){const moveEventHandler=evt=>{const rect=App.drawer.canvas.getBoundingClientRect();let x,y;const target=evt.type.startsWith("touch")?evt.targetTouches[0]:evt;x=target.clientX-rect.left,y=target.clientY-rect.top,App.mouse.isInBounds=x>=0&&y>=0&&x<rect.width&&y<rect.height,x=Math.max(0,Math.min(x,rect.width)),y=Math.max(0,Math.min(y,rect.height)),App.mouse.x=x/2,App.mouse.y=y/2},mouseDownHandler=()=>{App.mouse.isDown=!0},mouseUpHandler=()=>{App.mouse.isDown=!1};document.addEventListener("mousemove",moveEventHandler),document.addEventListener("touchmove",moveEventHandler),document.addEventListener("mousedown",mouseDownHandler),document.addEventListener("mouseup",mouseUpHandler),document.addEventListener("touchstart",mouseDownHandler),document.addEventListener("touchend",mouseUpHandler),App.registerOnDrawEvent(()=>{if(!App.mouse.isDown)return App.mouse.isDownStartMs=0,void(App.mouse.isDownMs=0);App.mouse.isDown&&!App.mouse.isDownStartMs&&(App.mouse.isDownStartMs=App.time),App.mouse.isDownMs=App.time-App.mouse.isDownStartMs}),document.addEventListener("keydown",event=>{if("`"===event.key)App.takeScreenshot()})},registerLoadEvents:function(){document.addEventListener("DOMContentLoaded",function(event){App.targetFps=60,App.fpsInterval=1e3/App.targetFps,App.fpsLastTime=Date.now(),App.fpsStartTime=App.fpsLastTime,App.onFrameUpdate(0)}),window.onbeforeunload=function(){App.sendSessionEvent(!1)},navigator.storage&&"persist"in navigator.storage&&navigator.storage.persist().then(persistent=>{App.isStoragePersistent=persistent})},sendSessionEvent:function(login){if(login){const analyticsData={session_id:App.sessionId,play_time_mins:(Math.round(App.playTime)/1e3/60).toFixed(2),away:App.awayTime||-1,sprite:App.petDefinition?.sprite,is_egg:App.pet?.stats.is_egg,gold:App.pet?.stats.gold,ver:VERSION};App.sendAnalytics("login",JSON.stringify(analyticsData))}else{const analyticsData={session_id:App.sessionId,hunger:Math.round(App.pet?.stats.current_hunger),fun:Math.round(App.pet?.stats.current_fun),health:Math.round(App.pet?.stats.current_health),sleep:Math.round(App.pet?.stats.current_sleep),bladder:Math.round(App.pet?.stats.current_bladder),is_egg:App.pet?.stats.is_egg,has_poop_out:App.pet?.stats.has_poop_out,is_sleeping:App.pet?.stats.is_sleeping};App.sendAnalytics("logout",JSON.stringify(analyticsData))}},applySettings:function(){const graphicsWrapper=document.querySelector(".graphics-wrapper"),root=document.querySelector(".root");this.isMiniApp?(this.settings.displayShell=!1,this.settings.displayShellButtons=!1,this.settings.displayShellLogo=!1,graphicsWrapper.classList.add("miniapp"),root&&root.classList.add("miniapp"),window.Telegram&&window.Telegram.WebApp&&(window.Telegram.WebApp.ready(),window.Telegram.WebApp.expand())):(graphicsWrapper.classList.remove("miniapp"),root&&root.classList.remove("miniapp"));new URLSearchParams(location.search).has("fullscreen")&&graphicsWrapper.classList.add("fullscreen"),this.settings.theme&&(document.body.className=`theme-${this.settings.theme}`),document.documentElement.style.setProperty("--bg-color",this.settings.backgroundColor);const metaThemeColor=document.querySelector('meta[name="theme-color"]');metaThemeColor?.setAttribute("content",this.settings.backgroundColor);const bgPattern=document.querySelector(".bg-pattern");bgPattern&&(this.settings.backgroundPattern?(UI.show(bgPattern),bgPattern.style.background=`url(${this.settings.backgroundPattern})`):UI.hide(bgPattern)),this.settings.shellAdditionalSize=clamp(this.settings.shellAdditionalSize,-.5,5),this.settings.screenSize=clamp(this.settings.screenSize,.6,5),graphicsWrapper.style.transform=`scale(${this.settings.screenSize})`,document.querySelector(".dom-shell").style.transform=`scale(${this.settings.screenSize+this.settings.shellAdditionalSize})`;const domShell=document.querySelector(".dom-shell");domShell.style.display=App.settings.displayShell?"":"none",domShell.className=`dom-shell shell-shape-${this.settings.shellShape}`,document.querySelector(".shell-btn.main").style.display=App.settings.displayShellButtons?"":"none",document.querySelector(".shell-btn.right").style.display=App.settings.displayShellButtons?"":"none",document.querySelector(".shell-btn.left").style.display=App.settings.displayShellButtons?"":"none",document.querySelector(".dom-shell .logo").style.display=App.settings.displayShellLogo?"":"none";let classicMainMenuContainer=document.querySelector(".classic-main-menu__container");classicMainMenuContainer?.remove(),graphicsWrapper.classList.remove("classic-main-menu"),App.settings.classicMainMenuUI?(graphicsWrapper.classList.add("classic-main-menu"),classicMainMenuContainer=UI.create({componentType:"div",className:"classic-main-menu__container",parent:graphicsWrapper,parentInsertBefore:!0,children:App.definitions.main_menu.map(def=>({className:"classic-main-menu__item click-sound",innerHTML:def.name,onclick:def.onclick}))}),App.temp.defaultHomeSceneConfig||(App.temp.defaultHomeSceneConfig={petY:App.scene.home.petY,shadowOffset:App.scene.home.shadowOffset}),App.scene.home.petY="90%",App.scene.home.shadowOffset=-10):App.temp.defaultHomeSceneConfig&&(App.scene.home.petY=App.temp.defaultHomeSceneConfig.petY,App.scene.home.shadowOffset=App.temp.defaultHomeSceneConfig.shadowOffset);const currentSeason=App.getSeason(),currentSeasonColors=App.getSeasonColor(currentSeason);Object2d.setColorOverrides(currentSeasonColors),App.currentScene&&App.reloadScene(),document.querySelector(".logo").ondblclick=()=>App.takeScreenshot()},loadMods:function(mods){"object"==typeof mods&&mods&&mods.length&&(App.mods=mods,App.mods.forEach(mod=>{mod.replaced_resources&&mod.replaced_resources.forEach(([source,target])=>{App.resourceOverrides[source]=target})}))},handleFileLoad:function(inputElement,readType="readAsDataURL",onLoad){inputElement.onchange=()=>{const file=inputElement.files[0],reader=new FileReader;reader.addEventListener("load",()=>onLoad(reader.result),!1),file&&reader[readType](file)}},registeredDrawEvents:[],registerOnDrawEvent:function(fn){return this.registeredDrawEvents.push(fn)-1},unregisterOnDrawEvent:function(inp){const index="function"==typeof inp?this.registeredDrawEvents.indexOf(inp):inp;-1!==index&&(this.registeredDrawEvents[index]=null)},onFrameUpdate:function(time){App.date=new Date,App.hour=App.date.getHours(),App.fullTime=App.date.getTime(),requestAnimationFrame(App.onFrameUpdate);const fpsElapsedTime=App.fullTime-App.fpsLastTime;fpsElapsedTime>App.fpsInterval&&(App.time=time,App.accurateDeltaTime=time-App.lastTime,App.playTime+=App.accurateDeltaTime,App.lastTime=time,App.fpsLastTime=App.fullTime-fpsElapsedTime%App.fpsInterval,App.accurateDeltaTime>5e3&&App.pet?.simulateAwayProgression?.(App.accurateDeltaTime),App.deltaTime=clamp(App.accurateDeltaTime,0,100),App.drawer?.draw(),App.onDraw?.(),App.registeredDrawEvents.forEach(fn=>fn?.()))},onDraw:()=>{},preloadImages:function(urls){const promises=urls.map(url=>new Promise((resolve,reject)=>{const image=new Image;image.src=App.checkResourceOverride(url),image.onload=()=>resolve(image),image.onerror=()=>reject(`Image failed to load: ${url}`)}));return Promise.all(promises)},getPreloadedResource:url=>{const preloadedResource=App.preloadedResources[url];if(!preloadedResource){const image=new Image;return image.src=App.checkResourceOverride(url),image}return preloadedResource},resourceOverrides:{},checkResourceOverride:function(res){return res&&this.resourceOverrides[res.replace(location.href,"")]||res},isTester:function(){return!!App.settings.isTester},addEvent:function(name,payload,force){return!(App.gameEventsHistory[name]&&!force)&&(App.gameEventsHistory[name]=!0,payload?.(),!0)},getEvent:function(name){return App.gameEventsHistory[name]},addRecord:function(name,value=1,shouldReplaceValue){const currentValue=this.getRecord(name)||0;return this.records[name]=shouldReplaceValue?value:currentValue+value,this.records[name]},getRecord:function(name){return this.records[name]},handleInputCode:function(rawCode){const{addEvent:addEvent}=App;function showAlreadyUsed(){return App.displayPopup("Этот код можно использовать только один раз"),!1}0===rawCode.indexOf(App.constants.INPUT_BASE_64)&&(rawCode=atob(rawCode.replace(App.constants.INPUT_BASE_64,"")));let code=rawCode.toString().toUpperCase(),codeEventId=`input_code_event_${code}`;switch(code){case"ERROR":App.displayPopup("Ошибка выполнения"),undefinedFunction();break;case"XUZFWQ":if(!addEvent(codeEventId,()=>{App.pet.stats.gold+=250}))return showAlreadyUsed();App.displayPopup(`Поздравляем! ${App.petDefinition.name} получил(а) 250 монет!`,5e3);break;case"PRNCSS":if(!addEvent(codeEventId,()=>{App.displayPopup("Успех!",5e3,()=>{App.closeAllDisplays(),Activities.redecorRoom(),App.scene.home.image=App.definitions.room_background.princess.image})}))return showAlreadyUsed();break;case"HESOYAM":App.displayPopup("Нужно было только...",5e3,()=>{App.pet.stats.gold+=2500,App.pet.stats.current_care=App.pet.stats.max_care,App.pet.stats.current_health=App.pet.stats.max_health});break;case"UXTW77":if(!addEvent(codeEventId,()=>{App.displayPopup("Извини за неудобства! Вот 250 очков миссий и 400 монет!",5e3,()=>{App.pet.stats.gold+=400,Missions.currentPts+=250})}))return showAlreadyUsed();break;case"TAMAWEBGIFT":if(!addEvent(codeEventId,()=>{App.displayPopup("Получено <b>1000 монет</b>!<br><br>Спасибо за игру!",5e3,()=>{App.pet.stats.gold+=1e3})}))return showAlreadyUsed();break;case"PICKUP":case"HANGOUT":case"TOOTHBRUSH":if(!addEvent(codeEventId,()=>{App.pet.stats.gold+=200,Missions.currentPts+=50,App.displayPopup("Получено <b>200 монет</b>, <b>50 очков миссий</b>!",4e3)}))return showAlreadyUsed();break;case"JINIINTHEBOTTLE":if(!addEvent(codeEventId,()=>{App.pet.stats.gold+=3e3,Missions.currentPts+=500,App.displayPopup("Получено <b>3000 монет</b>, <b>500 очков миссий</b>!",4e3)}))return showAlreadyUsed();break;case"DISCORD5K":if(!addEvent(codeEventId,()=>{App.pet.stats.gold+=5e3,Missions.currentPts+=500,App.displayPopup("Получено <b>5000 монет</b>, <b>500 очков миссий</b>!",4e3)}))return showAlreadyUsed();break;default:const showInvalidError=()=>{App.displayPopup("Неверный код")},command=/(\S+?) *: *(.+)/g.exec(rawCode);if(!command){showInvalidError();break}switch([,commandType,commandPayload]=command,commandType){case"save":try{const b64=decodeURIComponent(atob(commandPayload.replace(":endsave","")));console.log(b64);let json=JSON.parse(b64);if(!json.pet||"object"!=typeof json.pet)throw"error";console.log(json);let petDef=json.pet,def=(new PetDefinition).loadStats(petDef);App.displayConfirm(`Загрузить <div style="font-weight: bold">${def.getCSprite()} ${def.name}?</div>`,[{name:"Да",onclick:()=>{App.displayConfirm(`Что сделать с ${def.name}?`,[{name:"Сделать питомцем",onclick:()=>(App.displayConfirm("Уверен? Текущий питомец будет <b>заменён</b>",[{name:"Да",onclick:()=>{App.displayPopup("Загрузка...",App.INF),App.loadFromJson(json,()=>{App.displayPopup(`${def.name} теперь твой питомец!`,App.INF),setTimeout(()=>{location.reload()},3e3)})}},{name:"Нет",onclick:()=>{}}]),!0)},{_ignore:json.user_id===App.userId,name:"Добавить в друзья",onclick:()=>(App.petDefinition.addFriend(def),App.closeAllDisplays(),App.displayPopup(`${def.name} добавлен(а) в список друзей!`,3e3))},{name:"Отмена",class:"back-btn",onclick:()=>{}}])}},{name:"Нет",class:"back-btn",onclick:()=>{}}])}catch(e){return console.error(e),App.displayPopup("Код персонажа повреждён")}break;case"setchar":const sprite=PetDefinition.generateFullCSprite(commandPayload);App.displayConfirm(`Сменить облик питомца на ${sprite}?`,[{name:"Да",onclick:()=>{App.petDefinition.sprite=commandPayload,App.save(),window.location.reload()}},{name:"Нет",onclick:()=>{}}]);break;case"settester":App.settings.isTester="1"===commandPayload,App.save(),App.displayPopup(`Тестер: ${App.settings.isTester}`,1e3,()=>window.location.reload());break;case"activity:reckoning":Activities.reckoning(!0);break;default:showInvalidError()}}},handleInGameEvents:function(){if(App.handlers.add_active_pet_to_collection(),!App.awayTime||-1===App.awayTime)return void App.handlers.show_onboarding();const{addEvent:addEvent}=App;App.userName?addEvent("update_24_notice",()=>{},!1)||addEvent("itch_rating_dialog",()=>{})||addEvent("discord_server_02_notice",()=>{}):App.handlers.show_set_username_dialog()},scene:{home:new Scene({image:"resources/img/background/house/02.png",petX:"50%",petY:"100%",onLoad:()=>{App.drawer.selectObjects("poop").forEach(p=>p.absHidden=!1),App.pet.staticShadow=!1,App.pet.sicknessOverlay&&(App.pet.sicknessOverlay.absHidden=!1),0==random(0,10)&&App.pet.showCurrentWant(),App.isDuringChristmas()&&(this.christmasTree=new Object2d({img:"resources/img/misc/xmas_tree_01.png",x:60,y:12,z:App.constants.CHRISTMAS_TREE_Z})),App.handleFurnitureSpawn(),App.handleAnimalsSpawn(!0)},onUnload:()=>{App.drawer.selectObjects("poop").forEach(p=>p.absHidden=!0),App.pet.staticShadow=!0,App.pet.sicknessOverlay&&(App.pet.sicknessOverlay.absHidden=!0),this.christmasTree?.removeObject(),App.handleFurnitureSpawn(null,!0),App.handleAnimalsSpawn(!1)}}),kitchen:new Scene({image:"resources/img/background/house/kitchen_03.png",foodsX:"50%",foodsY:44,petX:"75%",petY:"81%",noShadows:!0,onLoad:()=>{App.pet.staticShadow=!1},onUnload:()=>{App.pet.staticShadow=!0}}),park:new Scene({image:"resources/img/background/outside/park_02.png"}),mallWalkway:new Scene({image:"resources/img/background/outside/mall_walkway.png"}),walkway:new Scene({image:"resources/img/background/outside/walkway_01.png"}),office:new Scene({image:"resources/img/background/house/office_01.png"}),wedding:new Scene({petX:"50%",petY:"100%",image:"resources/img/background/house/wedding_01.png",noShadows:!0}),arcade:new Scene({image:"resources/img/background/house/arcade_01.png"}),arcade_game01:new Scene({image:"resources/img/background/house/arcade_02.png"}),market:new Scene({image:"resources/img/background/outside/market_01.png"}),bathroom:new Scene({image:"resources/img/background/house/bathroom_01.png"}),hospitalExterior:new Scene({image:"resources/img/background/outside/hospital_01.png"}),hospitalInterior:new Scene({image:"resources/img/background/house/clinic_01.png",onLoad:()=>{this.drSprite=new Object2d({image:App.preloadedResources["resources/img/misc/dr_sprite.png"],x:"80%",y:"77%",inverted:!0})},onUnload:()=>{this.drSprite?.removeObject()}}),parentsHome:new Scene({image:"resources/img/background/house/parents_house_01.png",onLoad:()=>{let parentDefs=App.petDefinition.getParents();this.parent=new Pet(randomFromArray(parentDefs),{y:65,z:4})},onUnload:()=>{this.parent?.removeObject()}}),seaVacation:new Scene({image:"resources/img/background/outside/vacation_sea_l_01.png",onLoad:()=>{this.seaCreatureObject=new Object2d({img:"resources/img/background/outside/vacation_sea_l_02.png",x:0,y:15,z:7,bobFloat:0,onDraw:me=>{Object2d.animations.bob(me,.001,.04)}}),this.boatObject=new Object2d({img:"resources/img/background/outside/vacation_sea_l_03.png",x:0,y:0,z:6,bobFloat:1}),this.overlay=new Object2d({img:"resources/img/misc/picture_overlay_01.png",x:0,y:0,z:1e3})},onUnload:()=>{this.seaCreatureObject.removeObject(),this.boatObject.removeObject(),this.overlay.removeObject()}}),graveyard:new Scene({image:"resources/img/background/outside/graveyard_01.png",noShadows:!0}),battle:new Scene({image:"resources/img/background/house/battle_01.png",noShadows:!0}),stand:new Scene({image:"resources/img/background/outside/stand_01.png"}),online_hub:new Scene({noShadows:!0,image:"resources/img/background/house/online_hub_01.png",onLoad:()=>{this.lightRays=new Object2d({img:"resources/img/misc/light_rays_02.png",opacity:.6,x:"50%",y:"50%",composite:"overlay",onDraw:me=>{me.rotation-=.005*App.deltaTime}}),this.platform=new Object2d({img:"resources/img/misc/online_hub_01_front.png",x:0,y:0})},onUnload:()=>{this.platform.removeObject(),this.lightRays.removeObject()}}),garden:new Scene({image:"resources/img/background/outside/garden_01.png",petY:"95%",shadowOffset:-5,onLoad:args=>{App.pet.staticShadow=!1,args?.noPetBowl||(App.temp.petBowlObject=new Object2d({img:"resources/img/misc/pet_bowl_01.png",x:"20%",y:"67%",width:22,height:22,onLateDraw:me=>{App.pet.setLocalZBasedOnSelf(me)}}),App.animals.treat&&(App.temp.animalTreatObject=new Object2d({img:App.constants.FOOD_SPRITESHEET,spritesheet:{...App.constants.FOOD_SPRITESHEET_DIMENSIONS,cellNumber:App.animals.treat+App.animals.treatBiteCount},x:App.temp.petBowlObject.x,y:"63%",onLateDraw:me=>{me.z=App.temp.petBowlObject.z,me.localZ=App.temp.petBowlObject.localZ+.001}}))),App.handleAnimalsSpawn(!0)},onUnload:()=>{App.pet.staticShadow=!0,App.temp.petBowlObject?.removeObject?.(),App.temp.animalTreatObject?.removeObject?.(),App.handleAnimalsSpawn(!1)}}),beach:new Scene({image:"resources/img/background/house/beach_01.png"}),skate_park:new Scene({image:"resources/img/background/outside/skatepark_01.png"}),fortune_teller:new Scene({image:"resources/img/background/house/fortune_teller_01.png",onLoad:()=>{const npcDef=new PetDefinition({sprite:"resources/img/character/chara_362b.png",accessories:["witch hat"]});this.fortuneTellerNpc=new Pet(npcDef),this.fortuneTellerNpc.stopMove(),this.fortuneTellerNpc.x="80%",this.fortuneTellerNpc.triggerScriptedState("idle",App.INF,!1,!0),this.underlay=new Object2d({img:"resources/img/background/house/fortune_teller_01_underlay.png",z:App.constants.BACKGROUND_Z-1,x:0,y:0})},onUnload:()=>{this.fortuneTellerNpc?.removeObject(),this.underlay?.removeObject()}}),garden_inner:new Scene({image:"resources/img/background/outside/garden_inner_01.png",petY:"55%",animalMinY:55,shadowOffset:-5,onLoad:()=>{App.handleGardenPlantsSpawn(!0),App.handleAnimalsSpawn(!0),App.pet.staticShadow=!0},onUnload:()=>{App.handleGardenPlantsSpawn(!1),App.handleAnimalsSpawn(!1),App.pet.staticShadow=!1}}),forest:new Scene({image:"resources/img/background/outside/transparent.png",petY:"94%",onLoad:()=>{},onUnload:()=>{}}),reviverDen:new Scene({image:"resources/img/background/house/reviver_01.png",noShadows:!0}),emptyOutside:new Scene({image:"resources/img/background/outside/transparent.png"}),genericOutside:new Scene({image:"resources/img/background/outside/activities_base_01.png"}),mallInterior:new Scene({image:"resources/img/background/house/mall_interior_01.png"}),animalBathroom:new Scene({image:"resources/img/background/house/animal_bathroom_01.png"}),classroom:new Scene({image:"resources/img/background/house/classroom_01.png",onLoad:()=>{App.pet.staticShadow=!1},onUnload:()=>{App.pet.staticShadow=!0}}),music_classroom:new Scene({image:"resources/img/background/house/music_classroom_01.png"}),homeworld_getaways:new Scene({image:"resources/img/background/house/homeworld_getaways_01.png",noShadows:!0}),devil_town_exterior:new Scene({image:"resources/img/background/house/devil_town_01.png",noShadows:!0,onLoad:()=>{App.pet.showOutline()},onUnload:()=>{App.pet.hideOutline()}}),devil_town_gathering:new Scene({image:"resources/img/background/house/devil_town_02.png",noShadows:!0,onLoad:()=>{App.pet.showOutline()},onUnload:()=>{App.pet.hideOutline()}}),angel_town_room:new Scene({image:"resources/img/background/house/angel_town_01.png",noShadows:!0}),restaurant:new Scene({image:"resources/img/background/house/restaurant_01.png",noShadows:!0}),full_grass:new Scene({image:"resources/img/background/outside/full_grass_01.png"})},setScene(scene,noPositionChange,onLoadArg){App.currentScene?.onUnload?.(scene),App.currentScene=scene,noPositionChange||(App.pet.x=scene.petX||"50%",App.pet.y=scene.petY||"100%"),scene.foodsX&&(App.foods.x=scene.foodsX),scene.foodsY&&(App.foods.y=scene.foodsY),App.background.setImg(scene.image),scene.onLoad&&scene.onLoad(onLoadArg),this.applySky()},reloadScene(noPositionChange){App.setScene(App.currentScene,noPositionChange)},isRoomFurnishable:()=>App.scene.home.image?.includes("furnishable/"),getFurnishableBackground:backgroundSrc=>backgroundSrc.replace("house/","house/furnishable/").replace("outside/","outside/furnishable/"),getFurnitureDefFromId:id=>App.definitions.furniture.find(current=>current.id===id),handleFurnitureSpawn(furnitureData=App.ownedFurniture,removeOnly){if(App.activeFurnitureObjects?.length&&App.activeFurnitureObjects.forEach(o=>o.removeObject()),App.activeFurnitureObjects=[],!removeOnly&&App.isRoomFurnishable())return furnitureData.forEach?.(furniture=>{if(!furniture.isActive)return;const furnitureDef=App.getFurnitureDefFromId(furniture.id);if(!furnitureDef)return console.log("furniture was not found",furniture);let lastY=0;const furnitureObject=new Object2d({img:furnitureDef.image,x:furniture.x||0,y:furniture.y||0,z:furniture.z||App.constants.BACKGROUND_Z+.1,def:furniture,onDraw:me=>{furnitureDef.onDraw?.(me),lastY!==me.y&&(lastY=me.y,me.z=App.constants.BACKGROUND_Z+.3+.01*(me.y+me.image.height))}});App.activeFurnitureObjects.push(furnitureObject)}),App.activeFurnitureObjects},editFurniture(gameObject,callbackFn){if(!gameObject)return!1;App.toggleGameplayControls(!1);const editDisplay=document.createElement("div");editDisplay.className="absolute-fullscreen",document.querySelector(".screen-wrapper").appendChild(editDisplay),editDisplay.close=()=>editDisplay.remove(),editDisplay.innerHTML='\n            <div class="directional-control__container">\n                <div class="controls-y">\n                    <div class="control" id="up"><i class="fa fa-angle-up"></i></div>\n                    <div class="controls-x">\n                        <div class="control" id="left"><i class="fa fa-angle-left"></i></div>\n                        <div class="control" id="right"><i class="fa fa-angle-right"></i></div>\n                    </div>\n                    <div class="bottom-container">\n                        <div class="control" id="cancel"><i class="fa fa-times"></i></div>\n                        <div class="control" id="down"><i class="fa fa-angle-down"></i></div>\n                        <div class="control" id="apply"><i class="fa fa-check"></i></div>\n                    </div>\n                </div>\n            </div>\n        ';let blinkerFloat=0;const onEditDrawEvent=()=>{blinkerFloat+=.0085*App.deltaTime,blinkerFloat%=App.PI2,gameObject.opacity=Math.max(.65,.65+.2*Math.sin(blinkerFloat))};App.registerOnDrawEvent(onEditDrawEvent);const objectInitialPosition={x:gameObject.x,y:gameObject.y,z:gameObject.z},leftButton=editDisplay.querySelector(".control#left"),rightButton=editDisplay.querySelector(".control#right"),upButton=editDisplay.querySelector(".control#up"),downButton=editDisplay.querySelector(".control#down");[leftButton,rightButton,upButton,downButton].forEach(button=>{button.onclick=()=>{moveObject(button)}});const moveObject=button=>{switch(button){case leftButton:gameObject.x-=2.4;break;case rightButton:gameObject.x+=2.4;break;case upButton:gameObject.y-=2.4;break;case downButton:gameObject.y+=2.4}App.playSound("resources/sounds/ui_click_04.ogg"),App.vibrate()},onEndFn=state=>{App.toggleGameplayControls(!0),editDisplay.close(),App.unregisterOnDrawEvent(onEditDrawEvent),gameObject.opacity=1,callbackFn?.(state)};return editDisplay.querySelector("#apply").onclick=()=>{App.playSound("resources/sounds/ui_click_03.ogg"),App.vibrate(),App.displayConfirm("Сохранить текущую расстановку?",[{name:"Да",onclick:()=>{gameObject.def.x=gameObject.x,gameObject.def.y=gameObject.y,gameObject.def.z=gameObject.z,onEndFn(!0)}},{name:"Нет",class:"back-btn",onclick:()=>{}}])},editDisplay.querySelector("#cancel").onclick=()=>{App.playSound("resources/sounds/ui_click_02.ogg"),App.vibrate(),App.displayConfirm("Отменить текущую расстановку?",[{name:"Да",onclick:()=>{gameObject.x=objectInitialPosition.x,gameObject.y=objectInitialPosition.y,gameObject.z=objectInitialPosition.z,onEndFn(!1)}},{name:"Нет",class:"back-btn",onclick:()=>{}}])},App.sendAnalytics("edit_furniture"),!0},handleGardenPlantsSpawn(shouldSpawn){if(this.spawnedPlants?.forEach(o=>o.removeObject()),!shouldSpawn)return!1;const getPlantPosition=i=>({x:i%4==0?2:2+i%4*23,y:40+20*Math.floor(i/4)});this.spawnedPlants=[];for(let i=0;i<App.constants.MAX_PLANTS;i++){let currentPlant=App.plants?.at(i);const position=getPlantPosition(i),patch=new Object2d({img:"resources/img/misc/garden_patch_01.png",x:position.x,y:position.y+12,noPreload:!0});currentPlant?.createObject2d(patch),this.spawnedPlants.push(patch)}},handleAnimalsSpawn(shouldSpawn){if(this.spawnedAnimals?.forEach?.(o=>o?.removeObject?.()),!shouldSpawn)return!1;this.spawnedAnimals=(App.currentScene===App.scene.home?App.animals.list?.filter(animalDef=>animalDef.spawnIndoors):App.animals.list)?.map(animalDef=>{const animal=new Animal(animalDef,{x:random(0,App.drawer.bounds.width)});return animal.y=animal.getValidRandomYPosition(),animal})},applySky(){const{AFTERNOON_TIME:AFTERNOON_TIME,EVENING_TIME:EVENING_TIME,NIGHT_TIME:NIGHT_TIME}=App.constants,date=new Date,h=App.clampWithin24HourFormat((new Date).getHours()+App.settings.sleepingHoursOffset),isOutside=-1!=App.background.imageSrc?.indexOf("outside/"),season=App.getSeason();App.skyWeather.z=isOutside?999.1:-998;let weatherEffectChance=random(3,10,date.getDate());App.isDuringChristmas()&&(weatherEffectChance+=25),App.isChristmasDay()&&(weatherEffectChance+=100),pRandom.save();const seed=h+date.getDate()+App.userId;pRandom.seed=seed;let sky,weatherEffect="rain";switch(season){case"spring":case"summer":break;case"autumn":weatherEffectChance+=5,weatherEffect=pRandomFromArray(["snow","rain","rain","rain"]);break;case"winter":weatherEffectChance+=15,weatherEffect="snow"}App.setWeather(weatherEffect),App.skyWeather.hidden=!pRandom.getPercent(weatherEffectChance),pRandom.load(),sky=h>=AFTERNOON_TIME[0]&&h<AFTERNOON_TIME[1]?"afternoon":h>=EVENING_TIME[0]&&h<EVENING_TIME[1]?"evening":h>=NIGHT_TIME[0]||h<NIGHT_TIME[1]?"night":"morning";let renderedSky=sky;if(!App.skyWeather.hidden){switch(App.skyWeather.name){case"rain":"afternoon"===sky&&(renderedSky="morning");break;case"snow":"afternoon"===sky&&(renderedSky="morning"),"night"===sky&&(renderedSky="night_cold"),"evening"===sky&&(renderedSky="evening_cold")}}App.sky.name=sky,App.sky.setImage(App.preloadedResources[`resources/img/background/sky/${renderedSky}.png`]),App.skyOverlay.setImage(App.preloadedResources[`resources/img/background/sky/${renderedSky}_overlay.png`]),setTimeout(()=>App.skyOverlay.hidden=!isOutside),"afternoon"!=sky&&"morning"!=sky||(App.skyOverlay.hidden=!0)},setWeather(type){switch(type){case"rain":App.skyWeather.image=App.preloadedResources["resources/img/background/sky/rain_01.png"],App.skyWeather.composite="xor",App.skyWeather.flipSpeed=200;break;case"snow":App.skyWeather.image=App.preloadedResources["resources/img/background/sky/snow_01.png"],App.skyWeather.composite="normal",App.skyWeather.flipSpeed=400}App.skyWeather.name=type},isWeatherEffectActive:()=>!App.skyWeather.hidden,applyRoomCustomizations(data){"object"==typeof data&&data&&(Object.keys(data).forEach(key=>{const scene=App.scene[key];if(!scene)return console.error("Invalid scene:",key);scene.image=data[key].image}),App.reloadScene())},getRandomAnimalDef:function(type){const animalGroups={};animalGroups.cat=ANIMAL_CHARACTERS.filter(char=>char.includes("cat")),animalGroups.dog=ANIMAL_CHARACTERS.filter(char=>char.includes("dog")),animalGroups.other=ANIMAL_CHARACTERS.filter(char=>!animalGroups.cat.includes(char)&&!animalGroups.dog.includes(char)),type&&!(type in animalGroups)&&(console.error("Invalid Animal Group type: ",type),type=null);const typesArray=type?[animalGroups[type]]:[animalGroups.cat,animalGroups.dog,animalGroups.cat,animalGroups.dog,animalGroups.cat,animalGroups.dog,animalGroups.other],sprite=randomFromArray(randomFromArray(typesArray));return new AnimalDefinition({name:getRandomName(!1,!0),sprite:sprite})},getRandomPetDef:function(age=PetDefinition.LIFE_STAGE.adult,seed){pRandom.save();let sprite,rndArrayFn=randomFromArray;switch(void 0!==seed&&(pRandom.seed=seed,rndArrayFn=pRandomFromArray),age){case PetDefinition.LIFE_STAGE.baby:sprite=rndArrayFn(PET_BABY_CHARACTERS);break;case PetDefinition.LIFE_STAGE.child:sprite=rndArrayFn(PET_CHILD_CHARACTERS);break;case PetDefinition.LIFE_STAGE.teen:sprite=rndArrayFn(PET_TEEN_CHARACTERS);break;case PetDefinition.LIFE_STAGE.elder:sprite=rndArrayFn(PET_ELDER_CHARACTERS);break;default:sprite=rndArrayFn(PET_ADULT_CHARACTERS)}let pet=new PetDefinition({sprite:sprite,name:getRandomName(seed||!1)});return pet.setStats({current_hunger:100,current_sleep:100,current_fun:100}),pRandom.load(),pet},getPetDefFromParents:function(parentA,parentB){parentA.stats.player_friendship=100,parentA.stats.is_player_family=!0,parentB.stats.player_friendship=80,parentB.stats.is_player_family=!0;const sprite=PetDefinition.getOffspringSprite(parentA,parentB);return newPetDefinition=new PetDefinition({name:getRandomName(),sprite:sprite}).setStats({is_egg:!0,is_ghost:parentB.stats.is_ghost}),newPetDefinition.friends=[parentA,parentB],newPetDefinition.family=[...parentA.family,[parentA,parentB].map(parent=>App.minimalizePetDef(parent))],newPetDefinition.inventory=parentA.inventory,newPetDefinition.stats.gold=parentA.stats.gold+random(50,150),newPetDefinition.stats.current_health=100,newPetDefinition},minimalizePetDef:function(petDef){return{sprite:petDef.sprite,name:petDef.name,birthday:petDef.birthday,accessories:petDef.accessories||[],lastBirthday:petDef.lastBirthday,stats:{is_ghost:petDef.stats.is_ghost}}},createActivePet:function(petDef,props={}){let registeredInteractionDetector;petDef.sprite&&App.handlers.add_active_pet_to_collection(petDef.sprite);const interactionHandler=()=>{if(App.pet.isInteractingWith||!(App.mouse.isDownMs<200)){if(App.pet.isInteractingWith||App.vibrate(),!App.mouse.isDown)return App.pet.isInteractingWith=!1,App.disableGameplayControls=!1,App.pet.handleDirectInteractionEnd(),App.unregisterOnDrawEvent(interactionHandler),void(registeredInteractionDetector=null);App.pet.isDuringScriptedState()?App.pet.isInteractingWith||(App.mouse.isDown=!1):(App.pet.handleDirectInteractionStart(),App.disableGameplayControls=!0)}};return new Pet(petDef,{z:App.constants.ACTIVE_PET_Z,scale:1,castShadow:!0,...props,onHover:me=>{registeredInteractionDetector||!App.mouse.isDown||App.currentScene!==App.scene.home||App.disableGameplayControls||App.haveAnyDisplays()||(registeredInteractionDetector=App.registerOnDrawEvent(interactionHandler))}})},_queueEventKeys:{},queueEvent:function(payloadFn,eventKey=App.time+Math.random()){if(this._queueEventKeys[eventKey])return!1;this._queueEventKeys[eventKey]=!0;const checkForDecentTime=()=>{App.pet.isDuringScriptedState()||App.haveAnyDisplays()||App.pet.stats.is_egg||App.pet.stats.is_dead||App.pet.stats.is_at_parents||App.currentScene!==App.scene.home||(App.unregisterOnDrawEvent(checkForDecentTime),payloadFn?.(),delete this._queueEventKeys[eventKey])};App.registerOnDrawEvent(checkForDecentTime)},runRandomEncounters:function(){if(App.pet.stats.is_egg||App.pet.stats.is_at_parents||App.pet.stats.is_at_vacation||App.pet.stats.is_dead)return;if(App.petDefinition.lifeStage>=PetDefinition.LIFE_STAGE.child&&App.petDefinition.lifeStage<=PetDefinition.LIFE_STAGE.teen&&!App.pet.stats.has_received_school_invite)return App.pet.stats.has_received_school_invite=!0,void setTimeout(()=>{App.queueEvent(()=>{Activities.getMail({onEndFn:()=>{App.handlers.show_letter({headline:"Official School Invitation",text:`Dear ${App.userName},<br>${App.petDefinition.name} is now old enough to start school.<br><br>Please make sure they show up to their classes every day, no skipping!`,sender:"School Administration"})},noSceneSwitch:!0})})},random(1e3,2e3));const newspaperDeliveryMs=App.getRecord("newspaper_delivery_ms")||0;if(moment().startOf("day").diff(moment(newspaperDeliveryMs),"days")>0&&!App.pet.stats.is_sleeping)return void setTimeout(()=>{App.queueEvent(()=>{Activities.getMail();const nextMs=Date.now();App.addRecord("newspaper_delivery_ms",nextMs,!0)})},random(1e3,2e3));if(App.pet.stats.is_revived_once&&13===random(0,1300))return Activities.reckoning();return 1===(App.pet.stats.is_revived_once?random(0,128):random(0,256))?Activities.encounter():random(0,100)<=10&&App.pet.stats.is_sleeping&&"night"===App.sky.name?Activities.getRobbed():void 0},handlers:{go_to_home:function(){App.temp[App.handlers.getOutsideActivityId()]=1,App.pet.x="0%",App.pet.targetX=50},go_to_park:function(){Activities.goToPark(!1,()=>App.handlers.open_activity_list(!0))},go_to_clinic:function(){Activities.goToClinic(()=>App.handlers.open_activity_list(!0))},show_attended_school_limit_message:function(){const formattedResetTime=moment(App.constants.SCHOOL.resetTime).format("h:mmA");return App.displayPopup(`<b>${App.petDefinition.name}</b> сегодня уже был(а) на всех занятиях!<br><br>Заходи завтра после <b>${formattedResetTime}</b>`,4e3)},go_to_school:function(){Activities.goToSchool(()=>App.handlers.open_activity_list(!0))},open_works_list:function(){return App.displayList([{name:"работа в ларьке",onclick:()=>{Activities.standWork()}},{name:"офисная работа",onclick:()=>{Activities.officeWork()}}],()=>{App.handlers.open_activity_list(!0)})},open_fortune_teller:function(){return App.displayList([{_disable:App.petDefinition.lifeStage===PetDefinition.LIFE_STAGE.elder,name:"Следующая эволюция",onclick:()=>App.displayConfirm(`Показать возможные <b>эволюции</b> ${App.petDefinition.name} в зависимости от <b>уровня ухода</b>?`,[{name:"Да ($100)",onclick:()=>{App.pay(100)&&(App.closeAllDisplays(),Activities.goToFortuneTeller())}},{name:"Нет",class:"back-btn",onclick:()=>{}}])},{_disable:App.petDefinition.lifeStage<PetDefinition.LIFE_STAGE.adult,name:"Потомок с ...",onclick:()=>(App.handlers.open_friends_list(friendDef=>App.displayConfirm(`Показать <b>потомка</b> ${friendDef.name} и ${App.petDefinition.name}?`,[{name:"Да ($100)",onclick:()=>{App.pay(100)&&(App.closeAllDisplays(),Activities.goToFortuneTeller(friendDef))}},{name:"Нет",class:"back-btn",onclick:()=>{}}]),petDefinition=>!petDefinition.stats.is_player_family&&petDefinition.lifeStage>=PetDefinition.LIFE_STAGE.adult&&App.petDefinition.lifeStage>=PetDefinition.LIFE_STAGE.adult),!0)}],()=>{App.handlers.open_activity_list(!0)})},open_hubchi_search:function(onAddCallback){const prompt=App.displayPrompt('\n                Введи имя пользователя друга (или UID): <small>(учитывается регистр)</small>\n                <button id="help" style="position: absolute; bottom: 0; right: 0" class="generic-btn stylized"><b>?</b></button>\n                ',[{name:'<i class="fa-solid fa-search icon"></i> Искать',onclick:query=>{if(!query.trim())return App.displayPopup("Введите корректное имя пользователя.");const searchingPopup=App.displayPopup(`Ищем «${query}»...`,App.INF);return App.apiService.getPetDef(query).then(data=>{if(App.sendAnalytics("username_search",JSON.stringify({status:data.status,username:query})),!data.status)return App.displayPopup("Пользователь не найден<br><small>(Ищи по id пользователя, не по имени питомца)</small>");if(0===App.userName.indexOf(query))return App.displayPopup("Что-то пошло не так!");prompt.close();try{const parsedJson=JSON.parse(data.data),def=new PetDefinition(parsedJson).setStats({is_ghost:parsedJson.is_ghost||0});App.displayConfirm(`Добавить ${def.getCSprite()} ${def.name} в список друзей?`,[{name:"Да",onclick:()=>{App.closeAllDisplays();return App.petDefinition.addFriend(def,1)?(App.displayPopup(`${def.getCSprite()} ${def.name} добавлен(а) в список друзей!`,3e3),App.apiService.addInteraction(def.ownerId),onAddCallback?.(def)):App.displayPopup(`Вы уже в друзьях с ${def.name}`,3e3),!1}},{name:"Нет",class:"back-btn",onclick:()=>{}}])}catch(e){App.displayPopup("Что-то пошло не так!")}}).finally(()=>searchingPopup.close()),!0}},{name:"Отмена",class:"back-btn",onclick:()=>{}}]);return prompt.querySelector("#help").onclick=()=>{App.displayConfirm(`\n                        <div> Друг должен загрузить персонажа в <b style="color: #ff00c6">Hubchi</b> </div>\n                        <br>\n                        <div> Ищи по его <b>UID</b> <small>(есть в разделе «Профиль»)</small>, а не по имени питомца </div>\n                        <br>\n                        <div> UID чувствителен к регистру </div>\n                        <br>\n                        <div> ${App.getUidUI()} </div>\n                    `,[{name:"Ок",onclick:()=>{}}])},prompt},show_rating_dialog:function(){return App.displayConfirm("Если игра нравится, поставь <b>оценку</b> на Itch. Твой отзыв очень поможет!",[{link:App.routes.ITCH_REVIEW,name:"Оценить!",onclick:()=>{App.sendAnalytics("rate_accept")}},{name:"Позже",class:"back-btn",onclick:()=>{App.sendAnalytics("rate_decline")}}])},show_onboarding:function(){const screenWrapper=document.querySelector(".screen-wrapper"),interval=setInterval(()=>{if(!App.pet.stats.is_egg){UI.show(document.querySelector(".tap-reminder"));const tapReminderRemoveHandler=()=>{UI.hide(document.querySelector(".tap-reminder")),screenWrapper.removeEventListener("click",tapReminderRemoveHandler)};screenWrapper.addEventListener("click",tapReminderRemoveHandler),clearInterval(interval)}},1e3)},show_set_pet_name_dialog:function(text="Назови своё новое яйцо:"){const{GENDERS:GENDERS}=App.constants,cycleBetweenGenders=evt=>{const nextIndex=(GENDERS.indexOf(App.pet.stats.gender)+1)%GENDERS.length;App.pet.stats.gender=GENDERS.at(nextIndex),evt.target.innerHTML=App.getIcon(App.pet.stats.gender,!0)},prompt=`\n                <span>${App.petDefinition.getFullCSprite()}<br>${text}</span>\n                ${App.settings.genderedPets?`<button \n                        style="position: absolute; bottom: 0; right: 0" \n                        class="generic-btn stylized" \n                        id='gender'\n                    >\n                        ${App.getIcon(App.pet.stats.gender,!0)}\n                    </button>`:""}\n            `,genderButton=App.displayPrompt(prompt,[{name:"Задать",onclick:value=>{if(!value)return!1;App.pet.petDefinition.name=value,App.save(),App.displayPopup(`Имя установлено: «${App.pet.petDefinition.name}»`)}}],App.pet.petDefinition.name||"").querySelector("#gender");genderButton&&(genderButton.onclick=cycleBetweenGenders)},show_set_username_dialog:function(){App.displayPrompt("Укажи имя питомца",[{name:"Задать",onclick:username=>(username=>!!username&&null!==username.match(/^[a-zA-Z0-9]+$/))(username=(username||"").toString().toLowerCase())?username.length<5?App.displayPopup("Имя не может быть короче 5 символов."):username.length>18?App.displayPopup("Имя не может быть длиннее 18 символов."):(App.userName=username,App.save(),void App.sendAnalytics("new_user",username)):App.displayPopup("Недопустимое имя. Используй латинские буквы A–Z и цифры.")}])},show_letter:function({headline:headline,text:text,sender:sender}){const container=App.displayEmpty("letter");container.innerHTML=`\n            <div class="flex flex-dir-col">\n                <h1>${App.getIcon("envelope")}</h1>\n                <h1>${headline}</h1>\n                <span>${text}</span>\n                <footer>${sender}</footer>\n                <hr>\n                <button style="margin: 10px; margin-top: 10px; flex: 1" class="generic-btn stylized back-btn">Ok</button>\n            </div>\n            `,container.querySelector(".back-btn").onclick=container.close},show_newspaper:function(headline,text){headline||text||([headline,text]=randomFromArray(App.definitions.mail.affirmations));const salesDaySection=App.isSalesDay()?'\n                <div>\n                    <b style="color: orangered;">Discount Day!</b>\n                    <br>\n                    Local shops are slashing prices for today only. Don\'t miss out on huge savings! Check them out and save big!\n                    <br><br><br>\n                </div>\n            ':"",christmasSection=App.isDuringChristmas()?"\n                <div>\n                    <b style=\"color: darkgreen;\">Happy Xmas!</b>\n                    <br>\n                    DayMail sends you warm holiday wishes and a joyous New Year!\n                    <br><br>\n                    <small>\n                        During xmas, you'll receive 2x rewards from opening mission chests, so don't forget to check them out!\n                    </small>\n                    <br><br><br>\n                </div>\n            ":"",container=App.displayEmpty("bg-white flex flex-dir-col");container.style="background: repeating-linear-gradient(0deg, white 0px, white 11px, rgb(201, 201, 201) 10px, white 12px) local; backdrop-filter: blur(100px)",container.innerHTML=`\n            <img class="width-full" src="resources/img/misc/newspaper_header_01.png"></img>\n            <div style="text-align: left;" class="inner-padding">\n                ${christmasSection}\n                ${salesDaySection}\n                <b>${headline}</b>\n                <hr style="background: #0000003d; display: none">\n                <br><br>\n                <span>${text}</span>\n                <br>\n                </div>\n            <button style="margin: 10px; margin-top: 10px; flex: 1" class="generic-btn stylized back-btn news-close">Ok</button>\n            <i style="position: absolute;top: 0;right: 0;padding: 10px;border-radius: 100%;width: 10px;height: 10px;display: inline-flex;align-items: center;justify-content: center;color: #000000;cursor: pointer;" class="fa-solid fa-times news-close"></i>\n            `,[...container.querySelectorAll(".news-close")].forEach(btn=>btn.onclick=container.close)},open_main_menu:function(){if(App.disableGameplayControls||App.settings.classicMainMenuUI)return void(App.gameplayControlsOverwrite&&(App.playSound("resources/sounds/ui_click_01.ogg",!0),App.gameplayControlsOverwrite(),App.vibrate()));UI.lastClickedButton=null,App.playSound("resources/sounds/ui_click_06.ogg",!0),App.vibrate(),void 0===App.temp.showStoragePersistentBadge&&(App.temp.showStoragePersistentBadge=!App.isStoragePersistent);const settingsBadge=App.temp.showStoragePersistentBadge?App.getBadge("","red circle"):"",renderingMainMenu=App.definitions.main_menu.map(item=>"settings"===item.id?{...item,name:`${item.name} ${settingsBadge}`,onclick:()=>{item.onclick(),App.temp.showStoragePersistentBadge=!1}}:item);App.displayGrid([...renderingMainMenu,{name:App.getIcon("arrow-left",!0),class:"back-sound",onclick:()=>{}}])},open_care_menu:function(){const disciplineEntry={type:"element",class:" flex flex-dir-col in-list-container flex-gap-05 inner-padding-sm",innerHTML:UI.create({children:[{domType:"span",innerHTML:`${App.getGenericCSprite(1,"resources/img/misc/misbehaving_01.png",{cellSize:9,rows:1},"x2 opacity-half ml-2 ")} Discipline`},{domType:"div",className:"flex-between flex-gap-05",children:[{componentType:"button",style:"color: #229d3c;",className:"generic-btn stylized m-0 flex-1 flex-center flex-dir-row",innerHTML:App.getIcon("face-laugh-beam")+App.getIcon("thumbs-up",!0),onclick:()=>{App.closeAllDisplays(),App.pet.praise()}},{componentType:"button",className:"generic-btn stylized m-0 flex-1 flex-center flex-dir-row "+(App.pet.stats.is_misbehaving?"attention":""),style:"color: #e74040;",innerHTML:App.getIcon("face-angry")+App.getIcon("thumbs-down",!0),onclick:()=>{App.closeAllDisplays(),App.pet.scold(),App.pet.stats.is_misbehaving&&(App.toggleGameplayControls(!1),setTimeout(()=>{App.toggleGameplayControls(!0),App.handlers.open_care_menu()},2e3))}}]}]})};App.displayList([{...disciplineEntry},{_mount:me=>{me.innerHTML=`Миссии ${Missions.hasUnclaimedRewards()?App.getBadge("!"):""}`},name:"",onclick:()=>(Missions.openMenu(),!0)},{name:`Сон ${App.isSleepHour()?App.getBadge('<div style="margin-left: auto; padding: 2px"> <i class="fa-solid fa-moon"></i> <small>время спать!</small> </div>',"night"):""}`,onclick:()=>{App.handlers.sleep()}},{name:"Двор",onclick:()=>{Activities.goToGarden()}},{name:"Сад",onclick:()=>{Activities.goToInnerGarden()}},{name:"Погладить",onclick:()=>{App.displayPopup(`Жми на экран, чтобы гладить <b>${App.petDefinition.name}</b><br><br>Не жми несколько секунд, чтобы остановиться`,2800,()=>{Activities.pet()})}},{_ignore:!App.petDefinition.getParents(),name:"остаться у родителей",onclick:()=>App.hour<App.constants.PARENT_DAYCARE_START||App.hour>=App.constants.PARENT_DAYCARE_END?App.displayPopup(`Оставить ${App.petDefinition.name} у родителей можно только с <b>${App.formatTo12Hours(App.constants.PARENT_DAYCARE_START)}</b> до <b>${App.formatTo12Hours(App.constants.PARENT_DAYCARE_END)}</b>`,4e3):(App.displayConfirm(`${App.petDefinition.name} останется у родителей с <b>${App.formatTo12Hours(App.constants.PARENT_DAYCARE_START)}</b> до <b>${App.formatTo12Hours(App.constants.PARENT_DAYCARE_END)}</b>. Всё верно?`,[{name:"Да",onclick:()=>{App.closeAllDisplays(),Activities.stayAtParents(),App.save()}},{name:"Нет",class:"back-btn",onclick:()=>{}}]),!0)},{_disable:!App.pet.stats.current_want.type,name:"Текущее желание",onclick:()=>{App.closeAllDisplays(),App.pet.showCurrentWant(App.settings.showWantName)}}],null,"Уход")},open_stuff_menu:function(){App.displayList([{name:"Предметы",onclick:()=>(App.handlers.open_item_list(),!0)},{name:"Аксессуары",onclick:()=>(App.handlers.open_accessory_list(),!0)},{name:"Мебель",onclick:()=>{if(!App.isRoomFurnishable())return App.displayConfirm("В комнате уже есть мебель.<br><br>Убрать стандартный набор и настроить по своему?",[{name:"Да",onclick:()=>{App.closeAllDisplays(),Activities.redecorRoom(()=>{App.handlers.open_active_furniture_list()}),App.scene.home.image=App.getFurnishableBackground(App.scene.home.image)}},{name:"Нет",onclick:()=>{},class:"back-btn"}]);App.closeAllDisplays(),App.handlers.open_active_furniture_list()}},{name:"Крафт",onclick:()=>(App.handlers.open_craftables_list(),!0)}],null,"Вещи")},open_bathroom_menu:function(){App.displayList([{name:"Искупать",onclick:()=>{Activities.bathe()}},{name:"На горшок",onclick:()=>{Activities.poop()}},{name:`Чистить зубы ${App.getBadge()}`,onclick:()=>{Activities.brushTeeth()}},{name:"Убрать в комнате",onclick:()=>{App.handlers.clean()}}],null,"Гигиена")},open_credits:function(){return App.displayList([{type:"text",name:`<small>developed by</small>\n                    <br>\n                    SamanDev\n                    <small>\n                        <a href="${App.routes.DISCORD}" target="_blank">discord</a>\n                        <a href="https://samandev.itch.io" target="_blank">itch</a>\n                    </small>\n                    `},{type:"text",name:'<small>art by</small>\n                        <br>\n                        <div class="credit-author">\n                            <a href="https://samandev.itch.io" target="_blank">\n                                SamanDev\n                            </a>\n                        </div>\n                        <div class="credit-author">\n                            <a href="https://sa311.tumblr.com/post/163140958242/about-me" target="_blank">\n                                Curlour\n                            </a>\n                            <small>(eternitchi)</small>\n                        </div>\n                        <div class="credit-author">\n                            <a href="https://www.tiktok.com/@prion_sigma" target="_blank">\n                                Prion Sigma\n                            </a>\n                        </div>\n                        <div class="credit-author">\n                            <a href="https://www.instagram.com/abysmdelirium" target="_blank">\n                                abysmDelirium\n                            </a>\n                        </div>\n                        <div class="credit-author">\n                            gawkyToaster\n                        </div>\n                        <div class="credit-author">\n                            <a href="https://www.artstation.com/pistispixel" target="_blank">\n                                Piixel_Nun\n                            </a>\n                        </div>\n                        <div class="credit-author">\n                            <a href="https://bsky.app/profile/teddieursa.bsky.social" target="_blank">\n                                Teddie\n                            </a>\n                        </div>\n                        <div class="credit-author">\n                            Thunderputz\n                        </div>\n                        <div class="credit-author">\n                            <a href="https://vairasmythe.carrd.co/" target="_blank">\n                                Vaira Smythe\n                            </a>\n                        </div>\n                    '},{type:"text",name:'<small>music/sfx by</small>\n                        <br>\n                        <div class="credit-author">\n                            <a href="https://samandev.itch.io" target="_blank">\n                                SamanDev\n                            </a>\n                        </div>\n                        <div class="credit-author">\n                            <a href="https://x.com/Eth_DNautiluss" target="_blank">\n                                Eth-D\'Nautiluss\n                            </a>\n                        </div>\n                    '}])},open_settings:function(){const ignoreFirstDivider=!(App.deferredInstallPrompt||!App.isOnItch);App.displayList([{_ignore:App.isStoragePersistent,name:`\n                        <span>\n                            <b class="blink" style="color: red;">Данные сохранений под угрозой.</b><br> Браузер может <b>удалить</b> их без предупреждения.\n                        </span>\n                        <div class="flex flex-dir-col mt-2">\n                            <button id="emergency-backup" class="generic-btn stylized primary solid"> ${App.getIcon("download")} Резервная копия </button>\n                        </div>\n                    `,type:"info",_mount:e=>{e.querySelector("#emergency-backup").onclick=evt=>{App.exportSaveCode(),App.isStoragePersistent=!0,evt.target.innerHTML=`${App.getIcon("check")} Экспортировано!`}}},{_ignore:!App.isTester(),name:`<span style="color:red;">devtools</span> ${App.getBadge("debug","neutral")}`,onclick:()=>App.displayList([{name:"eventshistory",onclick:()=>{const ui=UI.genericListContainer(),content=UI.empty();return ui.appendChild(content),content.innerHTML=JSON.stringify(App.gameEventsHistory,null,2),App.displayPopup("array? "+Array.isArray(App.gameEventsHistory)),!0}},{name:"user",onclick:()=>{const ui=UI.genericListContainer(),content=UI.empty();return ui.appendChild(content),content.innerHTML=`${navigator.userAgent}`,!0}}])},{name:`\n                        ${App.getIcon("floppy-disk")} \n                        <span class="flex flex-dir-col pointer-events-none">\n                            <span>Сохранить</span>\n                            <small style="font-size: x-small">автосохранение каждые ${App.constants.AUTO_SAVE_INTERVAL_SECS} сек</small> \n                        </span>\n                        `,onclick:me=>(App.save(),me.disabled=!0,me.querySelector("span").textContent="Сохранено!",!0)},{_ignore:!App.deferredInstallPrompt,name:"Установить приложение",onclick:()=>(App.installAsPWA(),!0)},{_ignore:!0,_mount:e=>e.innerHTML=`Уведомления: <i>${App.settings.notifications?"вкл":"выкл"}</i>`,name:"Уведомления",onclick:btn=>(App.settings.notifications?(App.settings.notifications=!1,btn._mount()):Notification.requestPermission().then(result=>{"granted"===result&&(App.settings.notifications=!0),btn._mount()}),!0)},{name:"Управление сохранениями",onclick:()=>App.displayList([{name:'<i class="fa-solid fa-download icon"></i> <label class="custom-file-upload"><input id="save-file" type="file"></input>Импорт</label>',_mount:element=>{const input=element.querySelector("#save-file");App.handleFileLoad(input,"readAsText",data=>(App.handleInputCode(data),input.files=(new DataTransfer).files,!0))},onclick:()=>!0},{name:'<i class="fa-solid fa-upload icon"></i> Экспорт',onclick:()=>App.exportSaveCode()},{name:'<i class="fa-solid fa-copy icon"></i> Копировать',onclick:async()=>{const loadingPopup=App.displayPopup("Загрузка..."),charCode=await App.getSaveCode();return loadingPopup.close(),App.displayConfirm("Здесь можно скопировать код сохранения и продолжить игру на другом устройстве",[{name:"Ок",onclick:()=>{App.displayConfirm("После копирования открой Tamaweb на другом устройстве и вставь код в <b>Настройки → Ввести код</b>",[{name:"Ок",onclick:()=>{try{if(App.isOnItch)throw"itch_clipboard";navigator.clipboard.writeText(charCode),console.log("save code copied",charCode),App.displayPopup("Код сохранения скопирован!",1e3)}catch(e){const input=App.displayPrompt('Скопируй код сохранения из поля ниже:<br><small><i class="fa-solid fa-info-circle"></i> начинается с <b>save:</b> и заканчивается на <b>:endsave</b></small>',[{name:"Скопировал",class:"back-btn",onclick:()=>{}}],charCode).querySelector("input");input.focus(),input.select()}}}])}}]),!0}}])},{_ignore:App.isOnItch,name:"Моды",onclick:()=>{const display=App.displayList([{name:`\n                                    <span>\n                                        Сделай резервную копию сохранения перед установкой модов.\n                                    </span>\n                                    <div class="flex flex-dir-col mt-2">\n                                        <button id="emergency-backup" class="generic-btn stylized primary solid"> ${App.getIcon("download")} Резервная копия </button>\n                                    </div>\n                                `,type:"info",_mount:e=>{e.querySelector("#emergency-backup").onclick=evt=>{App.exportSaveCode(),evt.target.innerHTML=`${App.getIcon("check")} Экспортировано!`}}},{name:'<label class="custom-file-upload"><input id="mod-file" type="file"></input>+ Добавить мод</label>',onclick:btn=>!0},{name:`Активные моды (${App.mods.length})`,onclick:()=>{if(!App.mods.length)return App.displayPopup("Моды не установлены");App.displayList(App.mods.map(modInfo=>({name:modInfo.name,onclick:()=>{App.displayList([{name:`${modInfo.name} <br> <small style="font-size: small">автор: ${modInfo.author}</small>`,type:"text",solid:!0,bold:!0},{_ignore:!modInfo.description,name:modInfo.description,type:"text"},{name:"Удалить",onclick:()=>(App.displayConfirm(`Удалить мод <b>${modInfo.name}</b>?`,[{name:"Да",onclick:()=>{App.mods.splice(App.mods.indexOf(modInfo),1),App.save(),App.sendAnalytics("mod_uninstall",modInfo.name),App.displayPopup(`<b>${modInfo.name}</b> удалён. Обновление...`,null,()=>location.reload())}},{name:"Нет",class:"back-btn",onclick:()=>{}}]),!0)}]);return!0}})));return!0}},{name:"Установка и удаление модов перезагружает игру.",type:"info"}]);return App.handleFileLoad(display.querySelector("#mod-file"),"readAsText",data=>{try{const json=JSON.parse(data);if(!json.name)throw"Invalid";const duplicateIndex=App.mods.findIndex(({id:id})=>id==json.id);-1!=duplicateIndex?(App.mods[duplicateIndex]=json,App.sendAnalytics("mod_update",json.name),App.displayPopup(`<b>${json.name}</b> обновлён!<br><br>Обновление...`,2e3,()=>{location.reload()})):(App.mods.push(json),App.sendAnalytics("mod_install",json.name),App.displayPopup(`<b>${json.name}</b> установлен! <br><br> Обновление...`,2e3,()=>{location.reload()})),App.save()}catch(e){console.log(e),App.displayPopup(`Ошибка: неверный пакет мода: ${e}`)}}),!0}},{type:"separator",_ignore:ignoreFirstDivider},{name:"Настройки геймплея",onclick:()=>{const getStateIcon=state=>`<div class="${state?"option on":"option off"}"></div>`;return App.displayList([{name:"Часы сна",onclick:e=>{const list=UI.genericListContainer(),content=UI.empty();content.innerHTML=`\n                                        <div class="inner-padding b-radius-10 surface-stylized">\n                                            <div class="inline-flex-between width-full items-center">\n                                                <button id="subtract" class="generic-btn stylized primary solid"> <i class="fa-solid fa-minus"></i> </button>\n                                                <div style="font-size: medium">\n                                                    <b id="amount">${App.settings.sleepingHoursOffset}</b>\n                                                </div>\n                                                <button id="add" class="generic-btn stylized"> <i class="fa-solid fa-plus"></i> </button>\n                                            </div>\n                                        </div>\n\n                                        <div id="info" class="inner-padding b-radius-10 solid-surface-stylized">\n                                        </div>\n                                    `;const amount=content.querySelector("#amount"),info=content.querySelector("#info"),updateUI=()=>{amount.textContent=App.settings.sleepingHoursOffset;const startTime=App.constants.SLEEP_START+App.settings.sleepingHoursOffset,endTime=App.constants.SLEEP_END+App.settings.sleepingHoursOffset,rangeStyle="display: flex;justify-content: space-between;";info.innerHTML=`\n                                            сон\n                                            <br>\n                                            <b> \n                                                <div style="${rangeStyle}">\n                                                    с <div>${App.clampWithin24HourFormat(startTime)}:00</div>\n                                                </div>\n                                                <div style="${rangeStyle}">\n                                                    до <div>${App.clampWithin24HourFormat(endTime)}:00</div>\n                                                </div>\n                                            </b>\n                                        `},updateOffset=amount=>{App.settings.sleepingHoursOffset=clamp(App.settings.sleepingHoursOffset+amount,-24,24),updateUI(),App.applySky()};return content.querySelector("#add").onclick=()=>updateOffset(1),content.querySelector("#subtract").onclick=()=>updateOffset(-1),updateUI(),list.appendChild(content),!0}},{_mount:e=>e.innerHTML=`${getStateIcon(App.settings.automaticAging)} Автовозраст: <i>${App.settings.automaticAging?"Вкл":"Выкл"}</i>`,onclick:e=>(App.settings.automaticAging?(App.settings.automaticAging=!1,App.displayPopup("Автовозраст выключен"),App.save()):App.displayConfirm("Включить? Питомцы будут автоматически взрослеть через определённое время.",[{name:"Да",onclick:()=>{App.settings.automaticAging=!0,App.displayPopup("Автовозраст включён"),e._mount(),App.save()}},{name:"Нет",class:"back-btn",onclick:()=>{}}]),e._mount(),!0)},{_ignore:!0,_mount:e=>e.innerHTML=`${getStateIcon(App.settings.season)} Сезон: <i>${App.settings.season}</i>`,onclick:e=>{const possibleOptions=["auto","spring","summer","autumn","winter"],currentSettingIndex=possibleOptions.indexOf(App.settings.season);return App.settings.season=possibleOptions[(currentSettingIndex+1)%possibleOptions.length],App.applySettings(),e._mount(),!0}},{_mount:e=>e.innerHTML=`${getStateIcon(App.settings.showWantName)} Показывать желание: <i>${App.settings.showWantName?"Вкл":"Выкл"}</i>`,onclick:item=>(App.settings.showWantName=!App.settings.showWantName,App.applySettings(),item._mount(),!0)},{_mount:e=>e.innerHTML=`${getStateIcon(App.settings.genderedPets)} Питомцы по полу: <i>${App.settings.genderedPets?"Вкл":"Выкл"}</i>`,onclick:item=>(App.settings.genderedPets=!App.settings.genderedPets,item._mount(),!0)},{_mount:e=>e.innerHTML=`\n                                ${getStateIcon(App.settings.skillsAffectingEvolution)} \n                                <div class="overflow-hidden flex">\n                                    <div class="marquee">\n                                        Навыки влияют на эволюцию: <i>${App.settings.skillsAffectingEvolution?"Вкл":"Выкл"}</i>\n                                    </div>\n                                </div>\n                                `,onclick:item=>(App.settings.skillsAffectingEvolution=!App.settings.skillsAffectingEvolution,item._mount(),!0)}])}},{name:"Системные настройки",onclick:()=>(App.displayList([{name:`Звуки: <i>${App.settings.playSound?"вкл":"выкл"}</i>`,onclick:item=>(App.settings.playSound=!App.settings.playSound,item.innerHTML=`Звуки: <i>${App.settings.playSound?"вкл":"выкл"}</i>`,!0)},{_mount:e=>e.innerHTML=`Фоновая музыка: <i>${App.settings.playMusic?"вкл":"выкл"}</i>`,onclick:item=>(App.settings.playMusic=!App.settings.playMusic,item._mount(),!0)},{name:`Вибрация: <i>${App.settings.vibrate?"вкл":"выкл"}</i>`,onclick:item=>(App.settings.vibrate=!App.settings.vibrate,item.innerHTML=`Вибрация: <i>${App.settings.vibrate?"вкл":"выкл"}</i>`,!0)},{_mount:e=>e.innerHTML=`Классическое меню: <i>${App.settings.classicMainMenuUI?"вкл":"выкл"}</i>`,onclick:item=>(App.settings.classicMainMenuUI=!App.settings.classicMainMenuUI,item._mount(),App.applySettings(),!0)},{name:"Цвет фона",onclick:()=>(App.displayList([{name:`<input type="color" value="${App.settings.backgroundColor}" id="background-color-picker"></input>`,onclick:()=>!0},{name:"Применить",onclick:()=>{let colorPicker=document.querySelector("#background-color-picker");return App.settings.backgroundColor=colorPicker.value,App.applySettings(),!0}},{name:"Сбросить",onclick:()=>{let colorPicker=document.querySelector("#background-color-picker");return colorPicker.value="#FFDEAD",App.settings.backgroundColor=colorPicker.value,App.applySettings(),!0}}]),!0)},{_mount:btn=>{const hasNew=App.definitions.background_pattern.some(entry=>{const isUnlocked=!entry.unlockKey||App.getRecord(entry.unlockKey);return entry.isNew&&isUnlocked});btn.innerHTML=`Узор фона ${hasNew?App.getBadge("новое!"):""}`},onclick:()=>(App.handlers.open_background_pattern_list(),!0)},{name:"+ размер экрана",onclick:()=>(App.settings.screenSize+=.1,App.applySettings(),!0)},{name:"- размер экрана",onclick:()=>(App.settings.screenSize-=.1,App.applySettings(),!0)},{name:"Сбросить размер экрана",onclick:()=>(App.settings.screenSize=1,App.applySettings(),!0)}]),!0)},{name:"Сменить тему",onclick:()=>{const newThemes=[];return App.displayList([...App.definitions.themes].sort((a,b)=>newThemes.includes(b)-newThemes.includes(a)).map(themeName=>({name:`${themeName.replace("color ","")} ${newThemes.includes(themeName)?App.getBadge("новое!"):""}`,onclick:()=>(App.settings.theme=themeName,App.applySettings(),!0)})))}},{name:"Настройки оболочки",onclick:()=>(App.displayList([{_mount:e=>e.innerHTML=`Показывать корпус: <i>${App.settings.displayShell?App.getIcon("eye"):App.getIcon("eye-slash")}</i>`,onclick:item=>(App.settings.displayShell=!App.settings.displayShell,App.applySettings(),item._mount(),!0)},{_mount:e=>e.innerHTML=`Кнопки корпуса: <i>${App.settings.displayShellButtons?App.getIcon("eye"):App.getIcon("eye-slash")}</i>`,onclick:item=>(App.settings.displayShellButtons=!App.settings.displayShellButtons,App.applySettings(),item._mount(),!0)},{_mount:e=>e.innerHTML=`Логотип на корпусе: <i>${App.settings.displayShellLogo?App.getIcon("eye"):App.getIcon("eye-slash")}</i>`,onclick:item=>(App.settings.displayShellLogo=!App.settings.displayShellLogo,App.applySettings(),item._mount(),!0)},{name:"+ размер корпуса",onclick:()=>(App.settings.shellAdditionalSize+=.1,App.applySettings(),!0)},{name:"- размер корпуса",onclick:()=>(App.settings.shellAdditionalSize-=.1,App.applySettings(),!0)},{name:"Сбросить размер корпуса",onclick:()=>(App.settings.shellAdditionalSize=0,App.applySettings(),!0)},{_mount:e=>e.innerHTML=`Форма корпуса: <i>${App.settings.shellShape}</i>`,onclick:item=>(App.settings.shellShape++,App.settings.shellShape>App.constants.MAX_SHELL_SHAPES&&(App.settings.shellShape=1),App.applySettings(),item._mount(),!0)},{_mount:e=>{const hasNew=App.definitions.shell_background.some(entry=>{const isUnlocked=!entry.unlockKey||App.getRecord(entry.unlockKey);return entry.isNew&&isUnlocked});e.innerHTML=`Сменить корпус ${hasNew?App.getBadge("новое!"):""}`},onclick:()=>(App.handlers.open_shell_background_list(),!0)},{name:"Свой корпус",onclick:()=>{let display=App.displayList([{name:'<label class="custom-file-upload"><input id="shell-image-file" type="file"></input>Browse</label>',onclick:btn=>!0},{name:"Ввести URL",onclick:()=>(App.displayPrompt("Введи URL:",[{name:"Задать",onclick:url=>(App.setShellBackground(url)&&App.displayPopup("Фон корпуса установлен"),!0)},{name:"Отмена",class:"back-btn",onclick:()=>{}}]),!0)},{_ignore:!App.isTester,name:"Из буфера обмена",onclick:async()=>{try{const item=(await navigator.clipboard.read())[0],type=item.types[0],blob=await item.getType(type),reader=new FileReader;reader.onload=event=>{App.setShellBackground(event.target.result)},reader.readAsDataURL(blob)}catch(e){console.error(e)}}}]);return App.handleFileLoad(display.querySelector("#shell-image-file"),"readAsDataURL",async data=>{const downscaledData=await downscaleImage(data,768,768,.5);return App.setShellBackground(downscaledData)&&App.displayPopup("Фон корпуса установлен"),!0}),!0}}]),!0)},{name:"Ввести код",onclick:()=>(App.displayPrompt("Введи код:",[{name:"Ввести",onclick:value=>(App.handleInputCode(value),!1)},{name:"Отмена",class:"back-btn",onclick:()=>{}}]),!0)},{type:"separator"},{name:"Сбросить данные питомца",onclick:()=>(App.displayConfirm("Удалить сохранённого питомца?",[{name:"Да (удалить)",onclick:async()=>(App.save(),App.save=()=>{},App.displayPopup("Сброс...",App.INF),window.localStorage?.removeItem("pet"),window.localStorage?.removeItem("last_time"),await window.idbKeyval.delMany(["last_time","pet"]),setTimeout(()=>{location.reload()},1e3),!1)},{name:"Нет",class:"back-btn",onclick:()=>{}}]),!0)},{name:"Полный сброс",onclick:()=>(App.displayConfirm("Полностью удалить все данные? Будут сброшены питомцы, достижения, онлайн-ID и всё остальное!",[{name:"Да",onclick:()=>{App.displayConfirm("Точно? Это нельзя отменить.",[{name:"Да (удалить)",onclick:async()=>(App.save=()=>{},App.displayPopup("Сброс...",App.INF),window.localStorage?.clear(),await window.idbKeyval.clear(),setTimeout(()=>{location.reload()},1e3),!1)},{name:"Нет",class:"back-btn",onclick:()=>{}}])}},{name:"Нет",class:"back-btn",onclick:()=>{}}]),!0)},{type:"separator",_ignore:!0},{_ignore:!0,name:"Благодарности",onclick:()=>App.handlers.open_credits()},{_ignore:!0,name:"Отправить отзыв",onclick:()=>App.displayPrompt("Что бы ты хотел увидеть в следующем обновлении?",[{name:"Отправить",onclick:data=>{if(!data)return!0;App.displayPopup("<b>Отзыв отправлен!</b><br> Спасибо за участие!",4e3),App.sendFeedback(data)}},{name:"Отмена",class:"back-btn",onclick:()=>{}}])},{_ignore:!0,link:App.routes.BLOG,name:"<b>История изменений</b>",onclick:()=>(App.sendAnalytics("go_to_blog"),!0)},{_ignore:!0,link:App.routes.DISCORD,name:'<b>Вступить в <span style="color:#7289da;text-shadow:none;">Discord</span></b>',onclick:()=>!0},{type:"separator",_ignore:!0},{_ignore:!0,_disable:!0,name:`Version ${VERSION||"???"}`,onclick:()=>!0}],null,"Настройки")},open_stats:function(){const getCareRatingIcons=(current=App.pet.stats.current_care,max=App.pet.stats.max_care,sizePx)=>new Array(max).fill("").map((_,i)=>`<img style="margin-top: 2px; ${`${i>=current?"opacity: 0.5; filter:grayscale();":"filter:hue-rotate(310deg);"} ${sizePx?`width: ${sizePx}px;`:""}`}" src="resources/img/misc/star_01.png"></img>`).join(" "),list=UI.genericListContainer(),content=UI.empty();content.innerHTML=`\n            <div class="tabs">\n                <div class="tab-titles">\n                    <div for="tab-1" class="tab-title">${App.getIcon("bar-chart",!0)}</div>\n                    <div for="tab-2" class="tab-title">${App.getIcon("star",!0)}</div>\n                </div>\n                <div class="tab-contents">\n                    <div id="tab-1" class="tab">\n                        <div class="tab-content">\n                            <div class="inner-padding b-radius-10 flex-gap-2 flex flex-dir-col m mt-6">\n                                <div class="relative flex flex-dir-row align-center flex-gap-1">\n                                    <div class="stats-label">Деньги</div>\n                                    <b class="outlined-icon flex flex-center" style="width: 18px;">${App.getIcon("special:gold",!0)}</b> \n                                    <b>$${App.pet.stats.gold}</b>\n                                </div>\n                                <div class="relative flex flex-dir-row align-center flex-gap-1">\n                                    <div class="stats-label">Голод</div>\n                                    <b class="outlined-icon flex flex-center" style="width: 18px;">${App.getIcon("special:food",!0)}</b> \n                                    ${App.createProgressbar(App.pet.stats.current_hunger/App.pet.stats.max_hunger*100).node.outerHTML}\n                                </div>\n                                <div class="relative flex flex-dir-row align-center flex-gap-1">\n                                    <div class="stats-label">Настроение</div>\n                                    <b class="outlined-icon flex flex-center" style="width: 18px;">${App.getIcon("special:fun",!0)}</b> \n                                    ${App.createProgressbar(App.pet.stats.current_fun/App.pet.stats.max_fun*100).node.outerHTML}\n                                </div>\n                                <div class="relative flex flex-dir-row align-center flex-gap-1">\n                                    <div class="stats-label">Сон</div>\n                                    <b class="outlined-icon flex flex-center" style="width: 18px;">${App.getIcon("special:sleep",!0)}</b> \n                                    ${App.createProgressbar(App.pet.stats.current_sleep/App.pet.stats.max_sleep*100).node.outerHTML}\n                                </div>\n                                <div class="relative flex flex-dir-row align-center flex-gap-1">\n                                    <div class="stats-label">Дисциплина</div>\n                                    <b class="outlined-icon flex flex-center" style="width: 18px;">${App.getIcon("special:discipline",!0)}</b> \n                                    ${App.createProgressbar(App.pet.stats.current_discipline/App.pet.stats.max_discipline*100).node.outerHTML}\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                    <div id="tab-2" class="tab">\n                        <div class="tab-content">\n                            <div class="inner-padding b-radius-10 flex-gap-2 flex flex-dir-col m mt-6">\n                                <div class="relative flex flex-dir-row align-center flex-gap-1">\n                                    <div class="stats-label">Эмоции</div>\n                                    <b class="outlined-icon flex flex-center" style="width: 18px;">${App.getIcon("special:expression",!0)}</b> \n                                    ${App.createProgressbar(App.pet.stats.current_expression/100*100).node.outerHTML}\n                                </div>\n                                <div class="relative flex flex-dir-row align-center flex-gap-1">\n                                    <div class="stats-label">Логика</div>\n                                    <b class="outlined-icon flex flex-center" style="width: 18px;">${App.getIcon("special:logic",!0)}</b> \n                                    ${App.createProgressbar(App.pet.stats.current_logic/100*100).node.outerHTML}\n                                </div>\n                                <div class="relative flex flex-dir-row align-center flex-gap-1">\n                                    <div class="stats-label">Выносливость</div>\n                                    <b class="outlined-icon flex flex-center" style="width: 18px;">${App.getIcon("special:endurance",!0)}</b> \n                                    ${App.createProgressbar(App.pet.stats.current_endurance/100*100).node.outerHTML}\n                                </div>\n                                <div class="flex-between align-center">\n                                    <b>Уход:</b> <div style="display: inline-flex; gap: 1px">${getCareRatingIcons()}</div>\n                                </div>\n                            </div>\n                            <div class="inner-padding b-radius-10 uppercase list-text surface-stylized ${App.settings.skillsAffectingEvolution?"":"hidden"}">\n                                <small>\n                                    <i class="fa-solid fa-info-circle"></i>\n                                    Достаточно высокие навыки заменяют уровень ухода выше 1 при эволюции.\n                                    <hr>\n                                    <div>\n                                        <span class="flex-between items-center no-width-children"> ${App.getIcon("special:endurance")}➜ ${getCareRatingIcons(1,void 0,16)} </span>\n                                        <span class="flex-between items-center no-width-children"> ${App.getIcon("special:logic")}➜ ${getCareRatingIcons(2,void 0,16)} </span>\n                                        <span class="flex-between items-center no-width-children"> ${App.getIcon("special:expression")}➜ ${getCareRatingIcons(3,void 0,16)} </span>\n                                    </div>\n                                </small>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n            `,App.initTab(content),list.appendChild(content)},open_food_stats:function(foodName){const food=App.definitions.food[foodName];if(!food)return!1;const list=UI.genericListContainer(null,foodName),content=UI.empty();content.innerHTML=`\n            <div class="inner-padding b-radius-10 m surface-stylized">\n                <div style="margin-bottom: 16px">\n                    <small>Восполнение показателей:</small>    \n                </div>\n                <div>\n                    <b>ГОЛОД:</b> ${App.createProgressbar(food.hunger_replenish||0/App.pet.stats.max_hunger*100).node.outerHTML}\n                </div>\n                <div>\n                    <b>СОН:</b> ${App.createProgressbar(food.sleep_replenish||0/App.pet.stats.max_sleep*100).node.outerHTML}\n                </div>\n                <div>\n                    <b>FUN:</b> ${App.createProgressbar(food.fun_replenish||0/App.pet.stats.max_fun*100).node.outerHTML}\n                </div>\n                <div>\n                    <b>ЗДОРОВЬЕ:</b> ${App.createProgressbar(food.health_replenish||0/App.pet.stats.max_health*100).node.outerHTML}\n                </div>\n            </div>\n            `,list.appendChild(content),list.style.zIndex=5},add_active_pet_to_collection:function(char=App.petDefinition.sprite){const eventId=`${App.constants.CHAR_UNLOCK_PREFIX}_${PetDefinition.getCharCode(char)}`;App.addEvent(eventId)},open_character_collection:function(){App.handlers.add_active_pet_to_collection();let unlockedCount=0;const allCharacters=[...PET_BABY_CHARACTERS,...PET_CHILD_CHARACTERS,...PET_TEEN_CHARACTERS,...PET_ADULT_CHARACTERS,...PET_ELDER_CHARACTERS],charactersDef=allCharacters.map(char=>{const charCode=PetDefinition.getCharCode(char),isUnlocked=App.getEvent(`${App.constants.CHAR_UNLOCK_PREFIX}_${charCode}`);return isUnlocked&&unlockedCount++,{componentType:"div",className:"collection__char "+(isUnlocked?"":"locked"),innerHTML:PetDefinition.generateFullCSprite(char),onclick:({target:target})=>{App.isTester()&&target.classList.remove("locked")},ondblclick:()=>{App.isTester()&&confirm("Set this as main character?")&&(App.petDefinition.sprite=char,App.save(),setTimeout(()=>window.location.reload(),1e3))}}}),list=UI.genericListContainer(null,`(${unlockedCount}/${allCharacters.length})`),content=UI.empty();content.classList.add("collection__container"),list.appendChild(content),charactersDef.forEach(def=>UI.create({...def,parent:content})),App.sendAnalytics("opened_character_collection")},open_family_tree:function(petDefinition,usePastTense){if(petDefinition||(petDefinition=App.petDefinition),!petDefinition.family.length){const parents=petDefinition.getParents();2==parents?.length&&(petDefinition.family=[parents.map(parent=>App.minimalizePetDef(parent))])}if(!petDefinition.family.length&&!usePastTense)return App.displayPopup(`${petDefinition.name} — первый в роду!<br> Заходи, когда семья разрастётся!`);const list=UI.genericListContainer(),content=UI.empty(),oldestAncestor=petDefinition.family.length?petDefinition.family[0][0]:petDefinition,infoPanelContent=usePastTense?`\n                        Род начался\n                        <br>\n                        <b>${moment(oldestAncestor.birthday).format("MMMM DD YYYY")}</b>\n                        <br>\n                        и насчитывает\n                        <br>\n                        <b>${petDefinition.family.length+1} поколений</b>\n                    `:`\n                        Род насчитывает\n                        <br>\n                        <b>${petDefinition.family.length+1} поколений</b>\n                        <br>\n                        с\n                        <br>\n                        <b>${moment(oldestAncestor.birthday).fromNow()}</b>\n                    `;content.innerHTML=`\n                <div class="b-radius-10 m surface-stylized flex-center height-auto inner-padding">\n                    ${petDefinition.family.map((partners,i)=>{const[a,b]=partners;return`\n                                <div class="family-tree__partners-container">\n                                    <div class="family-tree__gen-badge">${i+1}</div>\n\n                                    <div class="family-tree__member-container">\n                                        ${PetDefinition.generateFullCSprite(b.sprite,null,PetDefinition.getSpriteClassName(b))}\n                                        <small>${b.name}</small>\n                                    </div>\n\n                                    <div class="family-tree__vertical-line"></div>  \n\n                                    <div class="family-tree__member-container">\n                                        ${PetDefinition.generateFullCSprite(a.sprite,null,PetDefinition.getSpriteClassName(a))}\n                                        <small>${a.name}</small>\n                                    </div>\n                                </div>\n                                <div class="family-tree__horizontal-line"></div>\n                            `}).join("")}\n                    <div style="margin-left: 76px" class="family-tree__member-container">\n                        ${petDefinition.getFullCSprite()}\n                        <small>${petDefinition.name}</small>\n                    </div>\n                </div>\n\n                <div class="b-radius-10 m surface-stylized height-auto inner-padding">\n                    ${infoPanelContent}\n                </div>\n            `,list.appendChild(content),App.sendAnalytics("opened_family_tree")},open_food_list:function(props={}){const{buyMode:buyMode,activeIndex:activeIndex,filterType:filterType,sellMode:sellMode,useMode:useMode,useModeLabel:useModeLabel="Use",useAmount:useAmount=1,age:age=App.petDefinition.lifeStage,getListOnly:getListOnly,allowCookableOnly:allowCookableOnly,limitFilter:limitFilter,outOfStockPercent:outOfStockPercent=20,priceMult:priceMult=1}=props;let sliderInstance,list=[];const salesDay=App.isSalesDay();let index=-1;const getIsOutOfStock=App.getOutOfStockCounter(App.getDayId(!0)+25);for(let food of Object.keys(App.definitions.food)){let isDisabled=!1,current=App.definitions.food[food];const currentType=current.type||"food",ownedAmount=App.pet.inventory.food[food],isFree=0===current.price;if("age"in current&&!current.age.includes(age))continue;if(buyMode&&(isFree||!allowCookableOnly&&current.cookableOnly||current.unbuyable))continue;if(filterType&&currentType!==filterType)continue;if(limitFilter?.({...current,ownedAmount:ownedAmount})&&(isDisabled=!0),current.price&&!ownedAmount&&!buyMode)continue;!buyMode&&!isFree&&ownedAmount<useAmount&&(isDisabled=!0);const isOutOfStock=++index&&buyMode&&getIsOutOfStock(outOfStockPercent)&&"med"!==currentType;let price=current.price*priceMult;if(sellMode){if(isFree)continue;price=current.cookableOnly?Math.floor(1.5*price):Math.floor(.75*price)}salesDay&&(price=Math.round(price/2));const foodIcon=App.getFoodCSprite(current.sprite),foodDisplayName=App.definitions.foodNamesRu&&App.definitions.foodNamesRu[food]||food;list.push({disabled:Boolean(isOutOfStock||isDisabled),current:current,foodName:food,price:price,icon:foodIcon,shortName:`<div class="icon">${foodIcon}</div> <span class="ellipsis">${foodDisplayName}</span>`,name:`\n                        ${foodIcon} \n                        ${current.cookableOnly?"★ ":""}\n                        ${foodDisplayName} \n                        (x${ownedAmount>0?ownedAmount:current.price?0:"∞"})\n                        ${isOutOfStock?'<b class="red-label">НЕТ В НАЛИЧИИ</b>':`<b>\n                                ${buyMode||sellMode?`\n                                    ${sellMode?`<span class="opacity-half">$${current.price} <i class="fa-solid fa-angle-right"></i> </span>`:""}\n                                    <span class="${sellMode?"seller-analysis "+(current.cookableOnly?"positive":"negative"):""}">\n                                        $${price}\n                                    </span>\n                                `:""}\n                            </b>`}\n                        ${current.isNew?App.getBadge("new!"):""}\n                    `,onclick:(btn,list)=>{if(buyMode||sellMode){if(sellMode)App.pet.stats.gold+=price,App.addNumToObject(App.pet.inventory.food,food,-1);else{if(App.pet.stats.gold<price)return App.displayPopup("Недостаточно монет!"),!0;App.pet.stats.gold-=price,App.addNumToObject(App.pet.inventory.food,food,1),Missions.done(Missions.TYPES.buy_food)}return App.handlers.open_food_list({...props,activeIndex:sliderInstance?.getCurrentIndex()}),!1}const removeFoodFromInventory=(amount=useAmount)=>App.pet.inventory.food[food]>=amount&&(App.pet.inventory.food[food]-=amount,!0);if(useMode){return void(useMode(current)&&removeFoodFromInventory())}App.closeAllDisplays(),App.pet.feed(current.sprite,current.hunger_replenish??0,currentType,null,noLongerHungry=>{noLongerHungry&&"food"==currentType||(App.handlers.open_feeding_menu(),App.handlers.open_food_list({...props,activeIndex:sliderInstance?.getCurrentIndex()}))})&&(removeFoodFromInventory(),App.pet.stats.current_fun+=current.fun_replenish??0,App.pet.stats.current_sleep+=current.sleep_replenish??0,App.pet.stats.current_expression+=current.expression_increase??0,App.pet.stats.current_logic+=current.logic_increase??0,App.pet.stats.current_endurance+=current.endurance_increase??0,App.pet.stats.current_discipline+=current.discipline_increase??0,App.pet.hasMoodlet("healthy")&&"medicine"===food?App.pet.stats.current_health=.6*App.pet.stats.current_health:App.pet.stats.current_health+=current.health_replenish??0,current.payload&&App.queueEvent(current.payload))}})}if(getListOnly)return list;if(!list.length)return void App.displayPopup("Нет расходников. Купи их на рынке.",2e3);buyMode&&list.push(list.shift());let acceptLabel="Eat";return buyMode?acceptLabel="Purchase":sellMode?acceptLabel="Sell":useMode&&(acceptLabel=useModeLabel),sliderInstance=App.displaySlider(list.sort((a,b)=>(b?.current?.isNew||0)-(a?.current?.isNew||0)),activeIndex,{accept:acceptLabel},buyMode||sellMode?"$"+(App.pet.stats.gold+(salesDay?' <span class="sales-notice">DISCOUNT DAY!</span>':"")):null),sliderInstance},open_seed_list:function(buyMode,activeIndex,payloadFn){let sliderInstance,list=[];const salesDay=App.isSalesDay();let index=-1;const getIsOutOfStock=App.getOutOfStockCounter(App.getDayId(!0)+50);for(let plant of Object.keys(App.definitions.plant)){let current=App.definitions.plant[plant];if(buyMode&&0==current.price)continue;if(current.price&&!App.pet.inventory.seeds[plant]&&!buyMode)continue;const isOutOfStock=++index&&buyMode&&getIsOutOfStock(0);let price=current.price;salesDay&&(price=Math.round(price/2));const plantIcon=Plant.getCSprite(plant,Plant.AGE.grown,"seed-pack");list.push({disabled:isOutOfStock,shortName:`<div class="icon">${Plant.getCSprite(plant,Plant.AGE.grown)}</div> <span class="ellipsis">${plant.toUpperCase()}</span>`,name:`\n                        ${plantIcon} \n                        ${plant.toUpperCase()} seeds \n                        (x${App.pet.inventory.seeds[plant]>0?App.pet.inventory.seeds[plant]:current.price?0:"∞"}) \n                        ${isOutOfStock?'<b class="red-label">OUT OF STOCK</b>':`<b>${buyMode?`$${price}`:""}</b>`}\n                    `,onclick:(btn,list)=>{if(buyMode){if(App.pet.stats.gold<price)return App.displayPopup("Недостаточно монет!"),!0;App.pet.stats.gold-=price,App.addNumToObject(App.pet.inventory.seeds,plant,1);App.handlers.open_seed_list(!0,sliderInstance?.getCurrentIndex());return!1}const shouldRemove=payloadFn?.(plant,current);shouldRemove&&App.pet.inventory.seeds[plant]>0&&(App.pet.inventory.seeds[plant]-=1)}})}if(list.length)return buyMode&&list.push(list.shift()),sliderInstance=App.displaySlider(list,activeIndex,{accept:buyMode?"Purchase":"Plant"},buyMode?"$"+(App.pet.stats.gold+(salesDay?' <span class="sales-notice">DISCOUNT DAY!</span>':"")):null),sliderInstance;App.displayPopup("Нет семян. Купи их на рынке.",2e3)},open_feeding_menu:function(){App.displayList([{name:"Еда",onclick:()=>(App.handlers.open_food_list({filterType:"food"}),!0)},{name:"Лакомства",onclick:()=>(App.handlers.open_food_list({filterType:"treat"}),!0)},{name:"Лекарства",onclick:()=>(App.handlers.open_food_list({filterType:"med"}),!0)},{_disable:App.petDefinition.lifeStage<=PetDefinition.LIFE_STAGE.baby,name:"Готовка",onclick:()=>App.displayList([{name:"camera",onclick:()=>App.displayConfirm("Сделай 3 фото — они станут ингредиентами супа! Потом нажимай, чтобы помешивать.",[{name:"Начать",onclick:()=>Activities.cookingGame()},{name:"Отмена",class:"back-btn",onclick:()=>{}}])},{name:"harvests",onclick:()=>{let allPlants=[];return App.displayList([{name:`\n                                            <div class="flex-between flex-wrap" style="row-gap: 4px">\n                                                ${App.getHarvestInventoryUI(item=>!item.def.inedible)}\n                                            </div>\n                                            `,type:"text"},...Object.keys(App.definitions.food).map(foodName=>({...App.definitions.food[foodName],name:foodName})).filter(food=>!food.nonCraftable).map(food=>{const ingredients=(name=>{pRandom.save();const seed=hashCode(name),results=new Array(3).fill(null).map((_,i)=>{allPlants.length||(allPlants=Object.keys(App.definitions.plant).map(name=>({...App.definitions.plant[name],name:name})).filter(({inedible:inedible})=>!inedible).map(({name:name})=>name)),pRandom.seed=seed+321*(i+1)*seed;const item=pRandomFromArray(allPlants);return allPlants.splice(allPlants.indexOf(item),1),item});return pRandom.load(),results})(food.name),hasAllIngredients=ingredients.every(ingredientName=>App.pet.inventory.harvests[ingredientName]);return{...food,ingredients:ingredients,hasAllIngredients:hasAllIngredients}}).sort((a,b)=>(b.cookableOnly||!1)-(a.cookableOnly||!1)).sort((a,b)=>b.hasAllIngredients-a.hasAllIngredients).map(food=>({_disable:!food.hasAllIngredients,class:"flex-between",name:`\n                                                    ${App.getFoodCSprite(food.sprite)} = ${App.getHarvestIcons(food.ingredients)}\n                                                    ${food.cookableOnly?App.getBadge("★","gold"):""}\n                                                `,onclick:()=>{const effectsBtn=App.displayConfirm(`\n                                                        Cook <div>${App.getFoodCSprite(food.sprite)}</div> <b>${food.cookableOnly?"★ ":""}${food.name}</b>?\n                                                        <button id="effects" style="display: none; position: absolute; bottom: 0; right: 0" class="generic-btn stylized"><b>effects</b></button>\n                                                    `,[{name:"Да",onclick:()=>{food.ingredients.forEach(ingredient=>{App.pet.inventory.harvests[ingredient]>0&&(App.pet.inventory.harvests[ingredient]-=1)}),Activities.cookingGame({skipCamera:!0,resultFoodName:food.name,stirringSpeed:.0095})}},{name:"Нет",class:"back-btn",onclick:()=>{}}]).querySelector("#effects");return effectsBtn&&(effectsBtn.onclick=()=>App.handlers.open_food_stats(food.name)),!0}})),{name:"★ Symbol indicates the item is only obtainable from cooking and has special effect(s)",type:"info"}])}}])}],null,"Кормление")},open_stats_menu:function(){const hasNewlyUnlockedAchievements=App.handlers.open_achievements_list(!0);App.displayList([{name:"Статистика",onclick:()=>(App.handlers.open_stats(),!0)},{name:"Профиль",onclick:()=>App.userName?(App.handlers.open_profile(),!0):(App.handlers.show_set_username_dialog(),!0)},{name:"Семейное древо",onclick:()=>(App.handlers.open_family_tree(),!0)},{name:"Коллекция",onclick:()=>(App.handlers.open_character_collection(),!0)},{name:`Достижения ${hasNewlyUnlockedAchievements?App.getBadge("Награды!"):""}`,onclick:()=>(App.handlers.open_achievements_list(),!0)},{name:App.settings.genderedPets?"Имя и пол":"Прозвище",onclick:()=>{const prompt=App.settings.genderedPets?"Введи имя и выбери пол:":"Введи новое имя питомца:";return App.handlers.show_set_pet_name_dialog(prompt),!0}},{_disable:!App.petDefinition.deceasedPredecessors?.length,name:"Прошлые поколения",onclick:()=>{const generations=App.petDefinition.deceasedPredecessors.map(def=>{const petDefinition=new PetDefinition(def);return{name:`${petDefinition.getCSprite()} ${petDefinition.name}`,onclick:()=>(App.handlers.open_family_tree(petDefinition,!0),!0)}});return App.displayList([{name:"Выбери поколение",type:"text"},...generations]),!0}}],null,"Информация")},open_active_buffs:type=>{"string"!=typeof type&&(type=null);const activeBuffs=Object.values(App.definitions.gameplay_buffs).filter(buff=>!type||buff.type===type).filter(buff=>App.isGameplayBuffActive(buff.key)),buffsUI=activeBuffs.map(buff=>App.getGameplayBuffUI(buff)).join("<hr>");return App.displayList([{name:activeBuffs.length?buffsUI:App.getEmptyStateUI(`No ${type??"active"} buffs`),type:"text"},{name:"You can get buffs by adopting animals in the backyard!",type:"info"}])},open_profile:function(){const petTraitIcons=[{title:"Potty-trained",img:"resources/img/misc/poop.png",condition:App.pet.stats.is_potty_trained},{title:"Revived",img:"resources/img/misc/ghost_02.png",condition:App.pet.stats.is_revived_once},{title:"Immortal",img:"resources/img/misc/infinity_01.png",condition:App.pet.stats.is_ghost}],playTimeDuration=moment.duration(App.playTime),list=UI.genericListContainer(),content=UI.empty("flex flex-dir-col flex-1");content.innerHTML=`\n                <div class="flex-center flex-1 flex flex-gap-05 inner-padding surface-stylized height-auto relative">\n                    ${App.petDefinition.getCSprite(!0)}\n                    <b>\n                        <span>${App.settings.genderedPets?App.getIcon(App.pet.stats.gender,!0):""} ${App.petDefinition.name} </span>\n                        <br>\n                        <small>${App.petDefinition.getLifeStageLabel()} - gen ${App.petDefinition.family.length+1}</small>\n                    </b>\n                    ${App.pet.stats.is_ghost?`\n                        <b>\n                            ${App.pet.stats.is_ghost===PetDefinition.GHOST_TYPE.angel?App.constants.SPANS.angel:""}\n                            ${App.pet.stats.is_ghost===PetDefinition.GHOST_TYPE.devil?App.constants.SPANS.monster:""}\n                        </b>\n                        `:""}\n                    <span>\n                        Born ${moment(App.petDefinition.birthday).fromNow()}\n                    </span>\n                    <div class="pet-trait-icons-container">\n                    ${petTraitIcons.map(icon=>`<div onclick="App.displayPopup('<small>trait:</small> <br> <b>${icon.title}</b> <small>(${icon.condition?"active":"inactive"})</small>')" title="${icon.title}" class="pet-trait-icon ${icon.condition?"":"disabled"}">\n                            <img src="${icon.img}"></img>\n                        </div>`).join("")}\n                    </div>\n                </div>\n                <div class="user-id surface-stylized inner-padding text-transform-none">\n                    <div class="flex flex-dir-col">\n                        <small>play time:</small>\n                        <span>${Math.floor(playTimeDuration.asHours())} hours and ${playTimeDuration.minutes()} minutes</span>\n                    </div>\n                </div>\n                ${App.getUidUI()}\n            `,list.appendChild(content)},copyToClipboard:content=>{navigator.clipboard.writeText(content),App.displayPopup("Скопировано!")},open_plant_stats:function(plant){const list=UI.genericListContainer(),content=UI.empty(),{wateredDuration:wateredDuration,deathDuration:deathDuration,growthDelay:growthDelay}=plant.getStatDurations(),getTimeDisplay=(time,pastMessage)=>{const timeAsMoment=moment(time),text=App.getPreciseTimeFromNow(time);return timeAsMoment.isBefore(moment())?`<span class="overflow-hidden ellipsis" style="opacity: 0.7;text-decoration: line-through;display: block;">${pastMessage}</span>`:`<span">${text}</span>`},nextGrowthTime=plant.isDead?-1:plant.lastGrowthTime+growthDelay,deathTime=plant.lastWatered+deathDuration,hydratedTime=plant.lastWatered+wateredDuration;let innerContent=`\n                <div>\n                    <b>GROWS IN:</b>\n                    <div class="surface-stylized inner-padding">${getTimeDisplay(nextGrowthTime,"GROWN")}</div>\n                </div>\n                <div>\n                    <b>Dehydrates in:</b>\n                    <div class="surface-stylized inner-padding">${getTimeDisplay(hydratedTime,"DEHYDRATED")}</div>\n                </div>\n                <div>\n                    <b>DIES IN:</b>\n                    <div><small>(after dehydration)</small></div>\n                    <div class="surface-stylized inner-padding">${getTimeDisplay(deathTime,"DEAD")}</div>\n                </div>\n            `;content.innerHTML=`\n                <div class="inner-padding b-radius-10 m surface-stylized">\n                    ${innerContent}\n                </div>\n            `,list.appendChild(content)},open_achievements_list:function(checkIfHasNewUnlocks){const list=Object.keys(App.definitions.achievements).map(id=>{const{name:name,description:description,checkProgress:checkProgress,getReward:getReward}=App.definitions.achievements[id];return((id,name,description,condition,rewardFn)=>{const unlockEventName=`unlocked_${id}_achievement`,unlockEventState=App.getEvent(unlockEventName);let badge=App.getBadge("★","gray");return unlockEventState||(badge=App.getBadge("★")),{name:condition?`<small>${name}</small>${badge}`:`<small><i class="fa-solid fa-lock"></i> ${name}</small>`,_disable:!condition,isNewlyUnlocked:condition&&!unlockEventState,onclick:()=>!condition||(App.displayConfirm(`<b>${name}</b> <br><br> ${description}`,[{name:unlockEventState?"Награда получена":"Получить награду",class:unlockEventState&&"disabled",onclick:()=>{App.sendAnalytics("achievement_reward_collect",name),App.addEvent(unlockEventName),App.closeAllDisplays(),UI.lastClickedButton=null,App.handlers.open_stats_menu(),App.handlers.open_achievements_list(),rewardFn&&rewardFn()}},{name:"close",class:"back-btn",onclick:()=>{App.handlers.open_achievements_list()}}]),!1)}})(id,name,description,checkProgress(),getReward)}).sort((a,b)=>a._disable==b._disable?0:a._disable?1:-1).sort((a,b)=>a.isNewlyUnlocked==b.isNewlyUnlocked?0:a.isNewlyUnlocked?-1:1);return checkIfHasNewUnlocks?list.some(a=>a.isNewlyUnlocked):App.displayList(list,null,"Достижения")},open_item_list:function(buyMode,activeIndex,customPayload){let sliderInstance,list=[],salesDay=App.isSalesDay();for(let item of Object.keys(App.definitions.item)){if(!App.pet.inventory.item[item]&&!buyMode)continue;let current=App.definitions.item[item],price=current.price;salesDay&&(price=Math.round(price/2));const iconElement=App.getItemCSprite(current.sprite),itemDisplayName=App.definitions.itemNamesRu&&App.definitions.itemNamesRu[item]||item;list.push({isNew:!!current.isNew,shortName:`<div class="icon">${iconElement}</div> <span class="ellipsis">${itemDisplayName}</span>`,name:`\n                        ${iconElement} \n                        ${itemDisplayName} (x${App.pet.inventory.item[item]||0}) \n                        <b>${buyMode?`$${price}`:""}</b> \n                        ${current.isNew?App.getBadge("новое!"):""}\n                    `,onclick:(btn,list)=>{if(buyMode){if(!App.pay(price))return!0;App.temp.purchasedMallItem=!0,App.addNumToObject(App.pet.inventory.item,item,1);App.handlers.open_item_list(!0,sliderInstance?.getCurrentIndex());return!1}return customPayload?customPayload({...current,name:item}):"age"in current&&!current.age?.includes(App.petDefinition.lifeStage)?App.displayPopup(`Этот предмет не подходит по возрасту для ${App.petDefinition.name}!`):void Activities.useItem({...current,name:item})}})}if(list.length)return list=list.sort((a,b)=>b.isNew-a.isNew),sliderInstance=App.displaySlider(list,activeIndex,{accept:buyMode?"Купить":"Использовать"},buyMode?"$"+(App.pet.stats.gold+(salesDay?' <span class="sales-notice">ДЕНЬ СКИДОК!</span>':"")):null),sliderInstance;App.displayPopup("У тебя нет предметов. Купи их в ТЦ.",2e3)},open_craftables_list:function(){let sliderInstance;const{room_background:roomBackgroundDefs,accessories:accessoryDefs}=App.definitions,getCraftableUIDef=(current,type,owned)=>({current:current,isNew:!!current.isNew,shortName:`<span class="ellipsis">${current.name.toUpperCase()}</span>`,name:`\n                    ${current.icon??`<img style="\n                            width: min-content;\n                            align-self: center;\n                        " src="${App.checkResourceOverride(current.image)}"></img>`}\n                    ${current.name.toUpperCase()} \n                    <small>${type}</small>\n                    <b class="flex-center flex-dir-row">\n                    ${owned?"OWNED":App.getHarvestIcons(current.craftingRecipe,void 0,"opacity-half")}\n                    </b> \n                    ${current.isNew?App.getBadge("new!"):""}\n                `,onclick:()=>{if(owned)return App.displayPopup(`У тебя уже есть этот ${"furniture"===type?"предмет мебели":"предмет"}!`);if(!current.craftingRecipe.every(ingredientName=>App.pet.inventory.harvests[ingredientName]))return App.displayPopup("Не хватает ингредиентов для крафта");switch(current.craftingRecipe.forEach(ingredient=>{return name=ingredient,void(App.pet.inventory.harvests[name]>0&&(App.pet.inventory.harvests[name]-=1));var name}),App.displayPopup(`Создано x1 <b>${current.name}</b>!`),type){case"room":App.closeAllDisplays(),Activities.redecorRoom(),App.scene.home.image=App.checkResourceOverride(current.image);break;case"furniture":App.ownedFurniture.push({id:current.id,x:"50%",y:"50%",isActive:!1});break;case"accessory":App.pet.inventory.accessory[current.name]=!0}App.sendAnalytics("craft",current.name),App.pet.stats.current_expression+=2,App.pet.stats.current_logic+=3}}),list=[...Object.keys(roomBackgroundDefs).map(roomName=>({...roomBackgroundDefs[roomName],image:App.getFurnishableBackground(roomBackgroundDefs[roomName].image),name:roomName})).filter(room=>room.isCraftable).map(current=>getCraftableUIDef(current,"room",current.image===App.scene.home.image)),...App.definitions.furniture.filter(item=>item.isCraftable).map(current=>getCraftableUIDef(current,"furniture",!!App.ownedFurniture.find(f=>f.id===current.id))),...Object.keys(accessoryDefs).map(name=>({...accessoryDefs[name],name:name})).filter(current=>current.isCraftable).map(current=>getCraftableUIDef({...current,icon:App.getAccessoryCSprite(current.name)},"accessory"))].sort((a,b)=>b.isNew-a.isNew);if(App.isTester()){const ingredientUsageMap={};Object.keys(App.definitions.plant).forEach(ing=>{App.definitions.plant[ing].inedible&&App.addNumToObject(ingredientUsageMap,ing,0)}),list.forEach(item=>{item.current.craftingRecipe.forEach(ing=>App.addNumToObject(ingredientUsageMap,ing,1))}),console.log({ingredientUsageMap:ingredientUsageMap})}return sliderInstance=App.displaySlider(list,null,{accept:"Craft"}),sliderInstance},open_room_background_list:function(onlyFurnishables,filterFn){let sliderInstance,list=[],salesDay=App.isSalesDay();for(let room of Object.keys(App.definitions.room_background)){const absCurrent=App.definitions.room_background[room];if(filterFn&&!filterFn(absCurrent))continue;if(!filterFn&&absCurrent.isCraftable)continue;let current=onlyFurnishables?{...absCurrent,image:App.getFurnishableBackground(absCurrent.image)}:absCurrent;if(current.unlockKey&&!App.getRecord(current.unlockKey))continue;let price=current.price;onlyFurnishables&&(price/=1.5),salesDay&&(price/=2),price=Math.round(price);const roomType=current.type??"home",scene=App.scene[roomType];if(!scene)return console.error("Invalid scene:",{roomType:roomType,scene:scene});const defaultTypeImage=scene.image||App.scene.home.image,icon=current.icon||current.image;list.push({isNew:!!current.isNew,shortName:`<span class="ellipsis">${room.toUpperCase()}</span>`,name:`<img style="min-height: 64px" src="${App.checkResourceOverride(icon)}"></img> ${room.toUpperCase()} <b>$${price}</b> ${current.isNew?App.getBadge("new!"):""}`,onclick:(btn,list)=>current.image===defaultTypeImage?(App.displayPopup("You already own this room"),!0):!App.pay(price)||(App.closeAllDisplays(),App.setScene(scene,!0),Activities.redecorRoom(),scene.image=current.image,App.sendAnalytics("home_background_change",scene.image),!1)})}return list=list.sort((a,b)=>b.isNew-a.isNew),sliderInstance=App.displaySlider(list,null,{accept:"Purchase"},"$"+(App.pet.stats.gold+(salesDay?' <span class="sales-notice">DISCOUNT DAY!</span>':""))),sliderInstance},open_shell_background_list:function(){let sliderInstance;const list=App.definitions.shell_background.filter(current=>!(current.unlockKey&&!App.getRecord(current.unlockKey))).sort((a,b)=>b.isNew-a.isNew).map(current=>({name:`<img src="${current.image}"></img>${current.isNew?App.getBadge("new!"):""}`,onclick:(btn,list)=>(App.setShellBackground(current.image),!0)}));return sliderInstance=App.displaySlider(list,null,{accept:"Set"}),sliderInstance},open_background_pattern_list:function(){let sliderInstance;const list=App.definitions.background_pattern.filter(current=>!(current.unlockKey&&!App.getRecord(current.unlockKey))).sort((a,b)=>b.isNew-a.isNew).map(current=>({name:`\n                        <img style="box-shadow: inset 0 0 0 100vw #0000009e;" src="${current.image}"></img>\n                        ${current.isNew?App.getBadge("new!"):""}\n                        <div>\n                            ${current.name}\n                        </div>\n                    `,onclick:()=>(App.settings.backgroundPattern===current.image?App.settings.backgroundPattern=!1:App.settings.backgroundPattern=current.image,App.applySettings(),App.save(),!0)}));return sliderInstance=App.displaySlider(list,null,{accept:"Toggle"}),sliderInstance},open_accessory_list:function(props={}){const{buyMode:buyMode,activeIndex:activeIndex,accessShop:accessShop,onClose:onClose}=props;let sliderInstance,list=[],salesDay=App.isSalesDay();for(let accessoryName of Object.keys(App.definitions.accessories)){if(!App.pet.inventory.accessory[accessoryName]&&!buyMode)continue;let current=App.definitions.accessories[accessoryName];if(buyMode&&(current.isCraftable||-1===current.price))continue;if(buyMode&&accessShop!==current.accessShop)continue;if(current.unlockKey&&!App.getRecord(current.unlockKey))continue;let price=current.price;salesDay&&(price=Math.round(price/2));const equipped=App.petDefinition.accessories.includes(accessoryName),owned=App.pet.inventory.accessory[accessoryName],reopen=buyMode=>(buyMode||App.handlers.open_stuff_menu(),App.handlers.open_accessory_list({...props,activeIndex:sliderInstance?.getCurrentIndex()}),!1),accessoryIcon=App.getAccessoryCSprite(accessoryName);list.push({isNew:!!current.isNew,shortName:`<span class="ellipsis">${accessoryName.toUpperCase()}</span>`,name:`\n                        ${accessoryIcon}\n                        ${accessoryName.toUpperCase()} \n                        <b>\n                        ${buyMode?owned?"OWNED":`$${price}`:equipped?"EQUIPPED":"NOT EQUIPPED"}\n                        </b> \n                        ${current.isNew?App.getBadge("new!"):""}\n                    `,onclick:(btn,list)=>{if(buyMode)return App.pet.inventory.accessory[accessoryName]?(App.displayPopup("You already own this accessory"),!0):!App.pay(price)||(App.temp.purchasedMallItem=!0,App.pet.inventory.accessory[accessoryName]=!0,reopen(buyMode));equipped?App.petDefinition.accessories.splice(App.petDefinition.accessories.indexOf(accessoryName),1):App.petDefinition.accessories.push(accessoryName),Activities.getDressed(()=>App.pet.equipAccessories(),reopen,!equipped),App.sendAnalytics("accessory",`${accessoryName} (${!equipped})`)}})}if(list.length)return list=list.sort((a,b)=>b.isNew-a.isNew),sliderInstance=App.displaySlider(list,activeIndex,{accept:buyMode?"Purchase":"Toggle"},buyMode?"$"+(App.pet.stats.gold+(salesDay?' <span class="sales-notice">DISCOUNT DAY!</span>':"")):null),sliderInstance;App.displayPopup("Нет аксессуаров. Купи в ТЦ.",2e3)},open_furniture_list:function(activeIndex){let sliderInstance,list=[],salesDay=App.isSalesDay();return App.definitions.furniture.forEach(current=>{if(current.isCraftable)return;let price=current.price??1;salesDay&&(price=Math.round(price/2));const owned=!!App.ownedFurniture.find(f=>f.id===current.id),name=`\n                <img style="min-height: 64px; object-fit: contain;" src="${App.checkResourceOverride(current.image)}"></img> \n                ${current.name.toUpperCase()} \n                <b>\n                ${owned?"OWNED":`$${price}`}\n                </b> \n                ${current.isNew?App.getBadge("new!"):""}\n                `;list.push({isNew:!!current.isNew,shortName:`<span class="ellipsis">${current.name.toUpperCase()}</span>`,name:name,onclick:(btn,list)=>owned?App.displayPopup("У тебя уже есть эта мебель!"):!App.pay(price)||(App.temp.purchasedMallItem=!0,App.ownedFurniture.push({id:current.id,x:"50%",y:"50%",isActive:!1}),App.handlers.open_furniture_list(sliderInstance?.getCurrentIndex()),!1)})}),list=list.sort((a,b)=>b.isNew-a.isNew),sliderInstance=App.displaySlider(list,activeIndex,{accept:"Purchase"},"$"+(App.pet.stats.gold+(salesDay?' <span class="sales-notice">DISCOUNT DAY!</span>':""))),sliderInstance},open_active_furniture_list:function(){const list=[...App.activeFurnitureObjects.map(savedFurniture=>{const furnitureDef=App.getFurnitureDefFromId(savedFurniture.def.id),persona=App.getPersona(furnitureDef.name,furnitureDef.image);return{name:persona,onclick:()=>App.displayList([{name:`<div class="flex flex-center height-auto">${persona}</div>`,type:"text"},{name:"Изменить положение",onclick:()=>{App.closeAllDisplays(),App.editFurniture(savedFurniture,()=>{App.handlers.open_active_furniture_list()})}},{name:"Убрать",class:"back-btn",onclick:()=>App.displayConfirm("Убрать эту мебель из комнаты?",[{name:"Да",onclick:()=>{savedFurniture.def.isActive=!1,App.handleFurnitureSpawn(),App.closeAllDisplays(),App.handlers.open_active_furniture_list()}},{name:"Нет",class:"back-btn",onclick:()=>{}}])}])}})],occupiedLength=list.length;for(let i=0;i<App.constants.MAX_PLACED_FURNITURE-occupiedLength;i++)list.push({name:'<div class="width-full flex-center"> + </div>',onclick:()=>{const list=App.ownedFurniture?.filter(f=>!f.isActive).slice().reverse().map(furniture=>{const def=App.getFurnitureDefFromId(furniture.id);return{_ignore:!def,name:App.getPersona(def?.name,def?.image),onclick:()=>{furniture.isActive=!0,App.closeAllDisplays();const currentObject=App.handleFurnitureSpawn().find(f=>f.def.id===def.id);App.editFurniture(currentObject,state=>{state||(furniture.isActive=!1),App.handleFurnitureSpawn(),App.handlers.open_active_furniture_list()})}}});return App.ownedFurniture?.length&&list.length?App.displayList(list,null,"Добавить мебель"):App.displayPopup("Нет мебели. Купи в ТЦ.")}});return App.displayList([...list])},getOutsideActivityId:function(id="default"){return`_outsideActivity_${id}`},open_activity_list:function(noIndexReset){return noIndexReset||(App.temp[App.handlers.getOutsideActivityId()]=1),Activities.goToActivities({activities:[...App.definitions.outside_activities]})},open_devil_town_activity_list:function(noIndexReset){const id="devilTown";return noIndexReset||(App.temp[App.handlers.getOutsideActivityId(id)]=1),Activities.goToActivities({activities:[{name:"Overworld Entrance",image:"resources/img/misc/activity_building_devil_home.png",onEnter:()=>App.handlers.open_underworld_menu(),isHome:!0},{name:"Gathering",image:"resources/img/misc/activity_building_devil_gathering.png",onEnter:()=>Activities.goToDevilTownGathering(),isHome:!0},{name:"Clothing Store",image:"resources/img/misc/activity_building_devil_clothing_store.png",onEnter:()=>(App.handlers.open_accessory_list({buyMode:!0,accessShop:"devilsTown"}),!0),skipUnloading:!0}],floorImage:"resources/img/misc/devil_walkway_02.png",scene:App.scene.devil_town_exterior,id:id})},open_underworld_menu:function(){const CURRENCY_NAME=App.constants.UNDERWORLD_TREAT_CURRENCY,CURRENCY_ICON=App.getFoodCSprite(App.definitions.food[CURRENCY_NAME]?.sprite),payWithCustomCurrency=amt=>amt>(App.pet.inventory.food[CURRENCY_NAME]||0)?(App.displayPopup(`Недостаточно ${CURRENCY_NAME}!`),!1):(App.addNumToObject(App.pet.inventory.food,CURRENCY_NAME,-amt),!0),openPurchasableList=activeIndex=>{let sliderInstance;const candyAmount=App.pet.inventory.food[CURRENCY_NAME]||0,allItems=[...[...[{name:"underworld tickets",icon:App.getGenericCSprite(1,App.constants.MISC_SPRITESHEET,App.constants.MISC_SPRITESHEET_DIMENSIONS),price:50,ownedAmount:App.pet.inventory.misc["underworld tickets"],onclick:()=>!payWithCustomCurrency(50)||(App.addNumToObject(App.pet.inventory.misc,"underworld tickets",3),openPurchasableList(sliderInstance?.getCurrentIndex()),!1)}],...["life essence","potion of aging up","potion of fulfillment","potion of misbehaving","potion of well behaving","potion of neglect","expression skill potion","logic skill potion","endurance skill potion"].map(name=>{const item=App.definitions.food[name];return{...item,name:name,icon:App.getFoodCSprite(item.sprite),price:200,ownedAmount:App.pet.inventory.food[name],onclick:()=>!payWithCustomCurrency(200)||(App.addNumToObject(App.pet.inventory.food,name,1),openPurchasableList(sliderInstance?.getCurrentIndex()),!1)}})]].map(current=>({...current,shortName:`<div class="icon">${current.icon}</div> <span class="ellipsis">${current.name?.toUpperCase()}</span>`,name:`\n                            ${current.icon} \n                            ${current.name?.toUpperCase()} \n                            (x${current.ownedAmount||0})\n                            <b class="flex align-center flex-gap-025 justify-center">\n                                ${CURRENCY_ICON} <span>X${current.price||0}</span> \n                            </b>\n                            ${current.isNew?App.getBadge("new!"):""}\n                        `}));return sliderInstance=App.displaySlider(allItems,activeIndex,{accept:"Purchase"},`\n                        <div class="flex align-center flex-gap-025">\n                            ${CURRENCY_ICON} x${candyAmount}\n                        </div>\n                    `),sliderInstance};return App.displayList([{name:"Enter Underworld",onclick:()=>{const ownedTickets=App.pet.inventory.misc["underworld tickets"]||0,ticketSpan=`<div class="flex align-center justify-center flex-gap-1 bold">${App.getGenericCSprite(1,App.constants.MISC_SPRITESHEET,App.constants.MISC_SPRITESHEET_DIMENSIONS)} Ticket</div>`;return ownedTickets?App.displayConfirm(`Отправиться в Подземный мир? Это будет стоить x1 ${ticketSpan}`,[{name:"Да",onclick:()=>{App.closeAllDisplays(),App.addNumToObject(App.pet.inventory.misc,"underworld tickets",-1),App.handlers.open_devil_town_activity_list(),App.sendAnalytics("enter_underworld")}},{name:"Нет",class:"back-btn",onclick:()=>{}}]):App.displayConfirm(`\n                                You don't have a \n                                ${ticketSpan}\n                                purchase some from the shop using\n                                <div class="flex align-center justify-center flex-gap-1 bold">${CURRENCY_ICON} ${CURRENCY_NAME}</div>\n                                `,[{name:"Открыть магазин",onclick:()=>{openPurchasableList()}},{name:"close",class:"back-btn",onclick:()=>{}}])}},{name:`Trick or Treat ${App.getBadge(CURRENCY_ICON,"transparent")}`,onclick:()=>App.displayPopup(`Double jump to get all <br> ${CURRENCY_ICON} <br> while avoiding <br> <img src="resources/img/misc/bat_01.png"></img>`,!1,()=>Activities.trickOrTreatGame(App.handlers.open_underworld_menu))},{name:"Магазин",onclick:openPurchasableList}],()=>{App.handlers.open_activity_list(!0)})},open_rabbitholes_list:function(){App.temp.rabbitholeTraveledFriends||(App.temp.rabbitholeTraveledFriends=[]);return App.displayList([...App.definitions.rabbit_hole_activities.sort((a,b)=>b.isNew||0-a.isNew||0).map(hole=>({name:`\n                            <span class="ellipsis">${hole.name}<span>\n                            ${App.getBadge(`${hole.isNew?"New!":""} <span> <i class="fa-solid fa-clock fa-xs"></i> ${Math.ceil(hole.duration/1e3/60)}</span>`,!hole.isNew&&"neutral")}\n                        `,onclick:()=>{const confirmFn=otherPet=>{App.displayConfirm(`Точно идти в <b>${hole.name}</b>${otherPet?` с <i>${otherPet.name}</i>`:""}? <br><br> ${App.petDefinition.name} уйдёт на <b>${moment(hole.duration+Date.now()).toNow(!0)}</b>`,[{name:"Да",onclick:()=>{App.pet.stats.current_rabbit_hole={name:hole.name,endTime:Date.now()+hole.duration},Activities.goToHomePlanet(otherPet),App.save(),App.closeAllDisplays(),App.sendAnalytics("rabbit_hole",hole.name)}},{name:"Нет",class:"back-btn",onclick:()=>{}}])};App.displayList([{name:`${hole.name} ${hole.isNew?App.getBadge("new!"):""}`,icon:"lemon",type:"info"},{name:"Один(а)",onclick:()=>(confirmFn(),!0)},{name:"С другом",onclick:()=>(App.handlers.open_friends_list(selectedFriend=>{confirmFn(selectedFriend)}),!0)}],void 0,"Назад");return!0}})),{type:"info",name:`${App.petDefinition.name} отправится на родную планету в одно из занятий <i>Побега с родной планеты</i>`}],()=>{App.handlers.open_activity_list(!0)})},open_friends_list:function(onClickOverride,customFilter,additionalButtons=[]){const friends=customFilter?App.petDefinition.friends.filter(customFilter):App.petDefinition.friends;if(!friends.length&&!additionalButtons.length)return void App.displayPopup(`У ${App.petDefinition.name} пока нет друзей.<br><br><small>Сходи в парк, чтобы найти друзей</small>`,4e3);const monsterIcon='<img class="icon" src="resources/img/misc/devil_icon.png"></img>',angelIcon='<img class="icon" src="resources/img/misc/angel_icon.png"></img>',monsterSpan=App.constants.SPANS.monster,angelSpan=App.constants.SPANS.angel;let friendsList;const mappedFriendsList=friends.map((friendDef,index)=>{const name=friendDef.name||"Unknown",icon=friendDef.getCSprite(),getInteractionSet=(set,condition)=>condition?set:[],monsterInteractions=[{name:"Scare",onclick:()=>(Activities.demon_scare(friendDef),!0)},{name:"Whisper",onclick:()=>(Activities.demon_whisper(friendDef),!0)},{name:"Place curse",onclick:()=>App.pet.stats.current_hunger<App.pet.stats.max_hunger/2?App.displayPopup("You don't have enough energy to do this."):(App.displayConfirm(`<b>${friendDef.name}</b> превратится в ${monsterSpan}. Продолжить?`,[{name:"Да",onclick:()=>{Activities.ghost_convertOtherPet(friendDef,PetDefinition.GHOST_TYPE.devil)}},{name:"Нет",class:"back-btn",onclick:()=>{}}]),!0)}].map(entry=>({...entry,name:`${monsterIcon} <span style="color: red;">${entry.name}</span>`})),angelInteractions=[{name:"Bless",onclick:()=>(Activities.angel_bless(friendDef),!0)},{name:"Grant Wish",onclick:()=>(Activities.angel_grantWish(friendDef),!0)},{name:"Gift Divinity",onclick:()=>App.pet.stats.current_hunger<App.pet.stats.max_hunger/2?App.displayPopup("You don't have enough energy to do this."):(App.displayConfirm(`<b>${friendDef.name}</b> превратится в ${angelSpan}. Продолжить?`,[{name:"Да",onclick:()=>{Activities.ghost_convertOtherPet(friendDef,PetDefinition.GHOST_TYPE.angel)}},{name:"Нет",class:"back-btn",onclick:()=>{}}]),!0)}].map(entry=>({...entry,name:`${angelIcon} <span style="color: forestgreen;">${entry.name}</span>`}));return{name:`${icon} ${name}`,onclick:()=>{const isMonsterGhost=friendDef.stats.is_ghost===PetDefinition.GHOST_TYPE.devil,isAngelGhost=friendDef.stats.is_ghost===PetDefinition.GHOST_TYPE.angel;if(onClickOverride)return onClickOverride(friendDef);const friendActivitiesList=App.displayList([{name:"Инфо",onclick:()=>{const list=UI.genericListContainer();return UI.genericListContainerContent(`\n                                        <div class="inner-padding uppercase surface-stylized b-radius-10 flex flex-dir-col flex-gap-2">\n                                            <div class="flex flex-dir-col flex-gap-05">\n                                                <div>${icon} ${friendDef.name}</div>\n                                                <small>(${friendDef.getLifeStageLabel()})</small>\n                                                <small>\n                                                    ${isMonsterGhost?monsterSpan:""}\n                                                    ${isAngelGhost?angelSpan:""}\n                                                </small>\n                                            </div>\n                                            <div></div>\n                                            <div class="relative flex flex-dir-row align-center flex-gap-1">\n                                                <div class="stats-label">Дружба</div>\n                                                <b class="outlined-icon flex flex-center" style="width: 18px;">${App.getIcon("smile",!0)}</b> \n                                                ${App.createProgressbar(friendDef.getFriendship()/100*100).node.outerHTML}\n                                            </div>\n\n                                        </div>\n                                    `,list),!0}},{_ignore:!friendDef.stats.is_ghost||friendDef.stats.is_ghost===App.pet.stats.is_ghost,name:`${isMonsterGhost?monsterIcon:angelIcon} <span style="color: ${isMonsterGhost?"red":"forestgreen"};">Превратить</span>`,onclick:()=>friendDef.stats.player_friendship<=98?App.displayPopup(`\n                                            Нужна максимальная дружба с \n                                            <b>${friendDef.name}</b>, \n                                            чтобы просить превращение в\n                                            <div>\n                                                ${isMonsterGhost?monsterSpan:angelSpan}\n                                            </div>\n                                        `,3500):App.displayConfirm(`Твой питомец превратится в ${isMonsterGhost?monsterSpan:angelSpan}. Продолжить?`,[{name:"Да",onclick:()=>{Activities.ghost_beConverted(friendDef,friendDef.stats.is_ghost)}},{name:"Нет",class:"back-btn",onclick:()=>{}}])},...getInteractionSet(monsterInteractions,App.pet.stats.is_ghost===PetDefinition.GHOST_TYPE.devil&&friendDef.stats.is_ghost!==App.pet.stats.is_ghost),...getInteractionSet(angelInteractions,App.pet.stats.is_ghost===PetDefinition.GHOST_TYPE.angel&&friendDef.stats.is_ghost!==App.pet.stats.is_ghost),{_ignore:App.petDefinition.lifeStage<PetDefinition.LIFE_STAGE.adult||friendDef.lifeStage<PetDefinition.LIFE_STAGE.adult||friendDef.stats.is_player_family,name:"На свидание",onclick:()=>friendDef.getFriendship()<60?App.displayPopup(`Дружба ${App.petDefinition.name} и ${friendDef.name} слишком слабая — на свидание не согласны.`,5e3):(App.displayConfirm(`Сходить на свидание с <div>${icon} ${friendDef.name}</div>?`,[{name:"Да",onclick:()=>{Activities.goOnDate(friendDef)}},{name:"Отмена",class:"back-btn",onclick:()=>{}}]),!0)},{name:`Потусить ${App.getBadge()}`,onclick:()=>{const handleHangout=(scene,isPlayerHost=!1)=>{App.closeAllDisplays(),Activities.talkingSequence({scene:scene,otherPetDef:friendDef,isPlayerHost:isPlayerHost})},getFriendsHomeScene=backgroundOverride=>{if(backgroundOverride)return new Scene({image:backgroundOverride});if(friendDef.stats.is_player_family)return new Scene({image:App.scene.parentsHome.image});pRandom.save(),pRandom.seed=320*parseInt(`${PetDefinition.getCharCode(friendDef.sprite)}${App.userId}`);const sceneBackground=pRandomFromArray(Object.keys(App.definitions.room_background).map(roomName=>App.definitions.room_background[roomName].image)),scene=new Scene({image:sceneBackground});return pRandom.load(),scene};return App.displayList([{type:"text",name:"Where to hang out?"},{name:`friend's home ${App.getBadge()}`,onclick:()=>handleHangout(getFriendsHomeScene())},{name:`your home ${App.getBadge()}`,onclick:()=>handleHangout(App.scene.home,!0)},{name:`the mall ${App.getBadge()}`,onclick:()=>handleHangout(getFriendsHomeScene(App.scene.mallInterior.image),Boolean(random(0,1)))},{name:`the beach ${App.getBadge()}`,onclick:()=>handleHangout(getFriendsHomeScene(App.scene.beach.image),Boolean(random(0,1)))}])}},{name:"Пригласить",onclick:()=>{App.closeAllDisplays(),Activities.invitePlaydate(friendDef)}},{_disable:App.petDefinition.lifeStage<=PetDefinition.LIFE_STAGE.baby,name:"Парк",onclick:()=>{App.closeAllDisplays(),Activities.goToPark(friendDef)}},{_disable:App.petDefinition.lifeStage<=PetDefinition.LIFE_STAGE.child,name:"Подарок",onclick:()=>(App.displayConfirm(`Подарить подарок ${icon} ${name}?`,[{name:"Да",onclick:()=>(App.closeAllDisplays(),App.handlers.open_item_list(null,null,item=>{App.pet.inventory.item[item.name]-=1,friendDef.increaseFriendship(Math.floor(item.price/2.7)),Activities.inviteGiveGift(friendDef)}),!0)},{name:"Нет",class:"back-btn",onclick:()=>{}}]),!0)},{name:"Удалить из друзей",onclick:()=>(App.displayConfirm(`Удалить из друзей ${icon} ${name}?`,[{name:"Да",onclick:()=>{friendsList.close(),friendActivitiesList.close(),App.petDefinition.friends.splice(index,1),App.handlers.open_friends_list()}},{name:"Нет",class:"back-btn",onclick:()=>{}}]),!0)}]);return!0}}});friendsList=App.displayList([...mappedFriendsList,...additionalButtons])},open_phone:function(){App.displayList([{_disable:App.petDefinition.lifeStage<=PetDefinition.LIFE_STAGE.baby||!navigator?.onLine,name:`<span style="color: #ff00c6"><i class="icon fa-solid fa-globe"></i> hubchi</span> ${navigator?.onLine?"":App.getBadge("offline","gray")}`,onclick:()=>App.petDefinition.lifeStage<=PetDefinition.LIFE_STAGE.baby?App.displayPopup(`${App.petDefinition.name} ещё слишком мал(а) для Hubchi!`):App.userName?App.pet.stats.current_sleep<10?App.displayPopup(`${App.petDefinition.name} слишком хочет спать для Hubchi!`):App.displayConfirm("Войти в Hubchi?",[{name:"Да",onclick:async()=>{App.closeAllDisplays(),Activities.onlineHubTransition(async fadeOverlay=>{setTimeout(()=>App.playSound("resources/sounds/task_complete.ogg",!0));const popup=App.displayPopup("Connecting...",App.INF);if(App.temp.online={},App.temp.online.hasUploadedPetDef=await App.apiService.getPetDef(),App.temp.online.randomPetDefs=await App.apiService.getRandomPetDefs(7),popup.close(),App.closeAllDisplays(),fadeOverlay.direction=!1,!App.temp.online?.randomPetDefs)return App.displayPopup("Error! Cannot connect."),App.setScene(App.scene.home),App.toggleGameplayControls(!0),!1;setTimeout(()=>App.playSound("resources/sounds/task_complete_02.ogg",!0)),Activities.goToOnlineHub()}),App.sendAnalytics("go_to_online_hub")}},{name:"Нет",class:"back-btn",onclick:()=>{}}]):(App.handlers.show_set_username_dialog(),!0)},{_disable:App.petDefinition.lifeStage<=PetDefinition.LIFE_STAGE.baby,name:'<span style="color: mediumvioletred"> <i class="fa-solid fa-burger icon"></i> SnapMeal </span>',onclick:()=>{let list=[...App.handlers.open_food_list({buyMode:!0,getListOnly:!0,filterType:"food",age:PetDefinition.LIFE_STAGE.adult}),...App.handlers.open_food_list({buyMode:!0,getListOnly:!0,filterType:"treat",age:PetDefinition.LIFE_STAGE.adult}),...App.handlers.open_food_list({buyMode:!0,getListOnly:!0,filterType:"food",allowCookableOnly:!0,age:PetDefinition.LIFE_STAGE.adult}).filter(item=>item.current.cookableOnly)].filter(item=>item.disabled).map(food=>({current:{...food.current,price:food.current.cookableOnly?Math.floor(10*food.current.price):Math.floor(food.current.price*App.constants.ONLINE_FOOD_ORDER_MARKUP)},foodName:food.foodName}));if(list.length%2==0&&(list=list.slice(0,-1)),!list.length)return App.displayPopup("Sorry but <b>Snapmeal</b> is out of operation today!<br> <small>Please comeback tomorrow!</small>",5e3);const getOrders=()=>list.filter(item=>item.current.orderAmount>0),getTotalPrice=()=>getOrders().reduce((acc,{current:current})=>acc+current.price*current.orderAmount,0),parentContainer=UI.genericListContainer();UI.create({className:"flex-grid-2x",parent:parentContainer,children:[...list.map(({current:current,foodName:foodName})=>({_mount:me=>{me.innerHTML=`\n                                                <div class="pointer-events-none">\n                                                    <div class="x2"> ${App.getFoodCSprite(current.sprite)} </div>\n                                                    <div class="flex-grid-2x__content ${current.orderAmount?"":"opacity-half"}">\n                                                        <span>X</span>\n                                                        <span id="order-amount">${current.orderAmount||0}</span>\n                                                    </div>\n                                                    <div class="flex-grid-2x__title">\n                                                        <small>\n                                                            <i>$${current.price}</i>\n                                                            ${current.cookableOnly?"★":""}\n                                                        </small>\n                                                    </div>\n                                                </div>\n                                            `},componentType:"button",className:"generic-btn stylized",onClick:me=>{const newOrderAmount=((current.orderAmount||0)+1)%4;current.orderAmount=newOrderAmount,me._mount(),parentContainer.querySelector("#submit-order")._mount()}})),{innerHTML:App.getIcon("spinner fa-spin-pulse",!0),_mount:me=>{const totalPrice=getTotalPrice();me.disabled=!totalPrice,me.innerHTML=`\n                                            <div class="x2"> \n                                                ${App.getIcon("basket-shopping",!0)}\n                                            </div>\n                                            <div class="flex-grid-2x__content">\n                                                $${totalPrice}\n                                            </div>\n                                        `,totalPrice&&(me.innerHTML+=App.getBadge("Order!"))},componentType:"button",className:"generic-btn stylized primary solid",id:"submit-order",disabled:!0,onClick:()=>{const totalPrice=getTotalPrice();return App.displayConfirm(`Оформить заказ на <b>$${getTotalPrice()}</b>?`,[{name:"Да",onclick:()=>{if(!App.pay(totalPrice))return!1;App.sendAnalytics("online_food_order",totalPrice),getOrders().forEach(order=>{App.addNumToObject(App.pet.inventory.food,order.foodName,order.current.orderAmount),Missions.done(Missions.TYPES.order_food)}),App.displayPopup(`${App.getIcon("check-circle",!0)} <br> Thanks for ordering! <br> <small>Your order will arrive shortly!</small>`,2500,()=>{App.closeAllDisplays(),Activities.receiveOrderedFood()})}},{name:"Нет",class:"back-btn",onclick:()=>{}}])}}]});return!0}},{name:`friends ${App.getBadge()}`,onclick:()=>(App.handlers.open_friends_list(null,null,[{name:'<i class="fa-solid fa-plus icon"></i> Add Friend',onclick:()=>App.handlers.open_hubchi_search()}]),!0)},{_ignore:App.petDefinition.lifeStage>=PetDefinition.LIFE_STAGE.elder,name:"День рождения",onclick:()=>{let nextBirthday=App.petDefinition.getNextBirthdayDate();if(moment().isBefore(nextBirthday))return App.displayPopup(`${App.petDefinition.name} ещё не вырос(ла) для перехода в следующий возраст.<br><br>Заходи <b>${moment(nextBirthday).fromNow()}</b>`,5e3);App.displayConfirm(`Перевести ${App.petDefinition.name} в следующий возраст?`,[{name:"Да",onclick:()=>{Activities.birthday()}},{name:"Нет",class:"back-btn",onclick:()=>{}}])}},{_ignore:!0,name:"К врачу",onclick:()=>{Activities.inviteDoctorVisit()}},{_disable:App.petDefinition.lifeStage<=PetDefinition.LIFE_STAGE.child,name:"social media",onclick:()=>(App.handlers.open_social_media(),!0)},{_disable:App.petDefinition.lifeStage<=PetDefinition.LIFE_STAGE.baby,name:"go on vacation",onclick:()=>{const{goToVacation:goToVacation}=Activities;return App.displayConfirm(`Отправить ${App.petDefinition.name} в отпуск?<br>Стоимость: $250. Питомец будет там, пока ты не завершишь отпуск.<hr><b>В отпуске потребности не падают.</b>`,[{name:"Да ($250)",onclick:()=>{const commitFn=()=>{goToVacation(Activities.seaVacation),App.sendAnalytics("go_on_vacation"),App.definitions.achievements.go_to_vacation_x_times.advance(),App.save()};App.pay(250)&&(App.animals?.list?.length?App.displayPopup("За животными присмотрят, пока ты в отпуске!",5e3,commitFn):commitFn())}},{name:"Нет",class:"primary solid",onclick:()=>{}}]),!0}},{name:"Коды друзей",onclick:()=>(App.displayList([{name:"Получить код",onclick:async()=>{const loading=App.displayPopup("Loading...",App.INF),pet=await window.idbKeyval.get("pet");loading.close();let charCode="friend:"+btoa(encodeURIComponent(JSON.stringify({user_id:App.userId,pet:pet})));return navigator.clipboard.writeText(charCode),console.log(charCode),App.displayConfirm("Код друга скопирован в буфер обмена!",[{name:"Далее",onclick:()=>{App.displayConfirm(`Передай код другу — он сможет добавить ${App.petDefinition.name} в друзья через <b>Коды друзей → Ввести код</b>`,[{name:"Ок",onclick:()=>{}}])}}]),!0}},{name:"Ввести код",onclick:()=>(App.displayPrompt("Введи свой код друга:",[{name:"Ввести",onclick:rawCode=>{if(-1==rawCode.indexOf("friend:"))return App.displayPopup("Неверный код друга!");let b64=rawCode.replace("friend:","");try{b64=decodeURIComponent(atob(b64));let json=JSON.parse(b64);if(!json.pet)throw"error";if(json.user_id===App.userId)return App.displayPopup("Нельзя добавить себя в друзья!");let petDef=json.pet,def=(new PetDefinition).loadStats(petDef);App.displayConfirm(`Добавить <div style="font-weight: bold">${def.getCSprite()} ${def.name}?</div> в друзья?`,[{name:"Да",onclick:()=>(App.petDefinition.addFriend(def),App.closeAllDisplays(),App.displayPopup(`${def.name} добавлен(а) в список друзей!`,3e3))},{name:"Нет",class:"back-btn",onclick:()=>{}}])}catch(e){return App.displayPopup("Неверный код друга!")}}},{name:"Отмена",class:"back-btn",onclick:()=>{}}]),!0)}]),!0)}],null,"Телефон")},open_social_media:function(){function showPost(petDefinition,noMood,noNextBtn){if(++App.temp.seenSocialMediaPosts>=12&&!noNextBtn)return App.displayPopup("There are no more social media posts, comeback later!");Missions.done(Missions.TYPES.check_social_post);let post=document.querySelector(".cloneables .post-container").cloneNode(!0);document.querySelector(".screen-wrapper").appendChild(post),post.style.display="",document.querySelector(".post-profile-icon").innerHTML=`${petDefinition.getCSprite()}`;let postDrawer=new Drawer(post.querySelector(".post-canvas"),96,96),postText=post.querySelector(".post-text"),drawer=setInterval(()=>{postDrawer.draw()},32),close=()=>{clearInterval(drawer),App.toggleGameplayControls(!0),post.remove()};App.toggleGameplayControls(!1,close),post.querySelector(".post-close").onclick=close,post.querySelector(".post-next").onclick=()=>{close(),showRandomPost()},noNextBtn&&post.querySelector(".post-next").remove();let homeBackground=App.scene.home.image;petDefinition!==App.petDefinition&&(homeBackground=randomFromArray(Object.keys(App.definitions.room_background).map(roomName=>App.definitions.room_background[roomName].image)));const background=new Object2d({drawer:postDrawer,img:homeBackground,x:0,y:0,width:96,height:96}),character=new Object2d({drawer:postDrawer,spritesheet:{...petDefinition.spritesheet,cellNumber:randomFromArray([1,11,14,8,2,12])},image:App.preloadedResources[petDefinition.sprite],x:randomFromArray(["50%","20%","80%"]),y:55+(2*petDefinition.spritesheet.offsetY||0)});post.querySelector(".post-header").innerHTML=petDefinition.name,App.pet.state;{const[text,pose,backgroundImg,backgroundSpritesheetDef]=randomFromArray(App.definitions.tweets.generic);postText.innerHTML=text,pose&&(character.spritesheet.cellNumber=pose),backgroundImg&&background.setImg(backgroundImg),backgroundSpritesheetDef&&(background.spritesheet=backgroundSpritesheetDef)}noMood||(App.pet.hasMoodlet("hungry")&&(postText.innerHTML="Can go for a bite #hungy",character.spritesheet.cellNumber=4,background.setImg(homeBackground)),App.pet.hasMoodlet("sleepy")&&(postText.innerHTML="battery low, need a nap!",character.spritesheet.cellNumber=4,background.setImg(homeBackground)),App.pet.hasMoodlet("bored")&&(postText.innerHTML="Anyone wanna talk? #bored",character.spritesheet.cellNumber=4,background.setImg(homeBackground)),App.pet.hasMoodlet("sick")&&(postText.innerHTML="Not feeling too good... #tummyache",character.spritesheet.cellNumber=4,background.setImg(homeBackground)))}App.temp.seenSocialMediaPosts||(App.temp.seenSocialMediaPosts=0);const showRandomPost=()=>{switch(App.petDefinition.stats.current_fun+=random(0,5),random(0,2,3)){case 0:App.pet.stats.current_expression+=.5;break;case 1:App.pet.stats.current_endurance+=.5;break;case 2:App.pet.stats.current_logic+=.5}let otherPetDef;otherPetDef=App.petDefinition.friends&&App.petDefinition.friends.length?randomFromArray(App.petDefinition.friends):App.getRandomPetDef(),showPost(otherPetDef,!0)};App.displayList([{name:"Создать пост",onclick:()=>(App.petDefinition.stats.current_fun+=random(1,5),App.pet.stats.current_expression+=.5,showPost(App.petDefinition,null,!0),!0)},{name:"Лента",onclick:()=>(showRandomPost(),!0)},{name:"Найти друзей",onclick:()=>{const seed=App.getDayId(!0);let potentialFriends=new Array(8).fill(void 0).map((spot,i)=>App.getRandomPetDef(App.petDefinition.lifeStage,seed+128*i));return App.displayGrid([...potentialFriends.map(otherPetDef=>({name:`${otherPetDef.getFullCSprite()}`,class:"bg-bef-1",onclick:()=>(App.displayConfirm(`Отправить заявку в друзья<br><b>${otherPetDef.getCSprite()} ${otherPetDef.name}?</b>`,[{name:"Да",onclick:()=>{1==random(0,1)?App.petDefinition.addFriend(otherPetDef)?(App.displayPopup(`${otherPetDef.name} <b style="color: #87cf00">принял(а)</b> заявку в друзья от ${App.petDefinition.name}!`),App.pet.stats.current_expression+=2):App.displayPopup(`${App.petDefinition.name} уже в друзьях с ${otherPetDef.name}!`):App.displayPopup(`${otherPetDef.name} <b style="color: #ff6e74">отклонил(а)</b> заявку в друзья от ${App.petDefinition.name}`)}},{name:"Нет",class:"back-btn",onclick:()=>{}}]),!0)})),{name:'<i class="fa-solid fa-arrow-left back-sound"></i>',class:"back-sound",onclick:()=>{}}]),!0}},{name:"send message",onclick:()=>(App.handlers.open_friends_list(friendDef=>{friendDef.sentMessage?App.displayPopup(`${App.petDefinition.name} не стоит спамить в переписку с ${friendDef.name}!`,3e3):(App.displayPopup(`Сообщение отправлено ${friendDef.name}!`,3e3),friendDef.increaseFriendship(10),friendDef.sentMessage=!0,App.pet.stats.current_expression+=.5)}),!0)}])},open_school_activity_list:function(){const getFlipCardsDifficulty=stat=>stat<6?{activeCards:1,maxCards:4,maxAttempts:2}:stat<15?{activeCards:1,maxCards:8,maxAttempts:3}:stat<=30?{activeCards:1,maxCards:12,maxAttempts:3}:stat<=60?{activeCards:2,maxCards:12}:{activeCards:3,maxCards:12,maxAttempts:5},startClassGame=(text,payload)=>{App.displayPopup(text,2e3,()=>(payload=>App.pet.stats.schoolClassesToday>=App.constants.SCHOOL.maxClassesPerDay?(App.handlers.show_attended_school_limit_message(),!0):(App.pet.stats.schoolClassesToday+=1,console.log(App.pet.stats.schoolClassesToday),App.pet.stats.current_discipline+=random(1,4),payload()))(payload))},flipCardsDescription=`Keep track of cards with the ${App.getIcon("star",!0)} symbol and select them after the shuffle!`;return App.displayList([{name:`${App.getIcon("special:expression")} Expression`,onclick:()=>App.displayList([{name:"Tune Practice",onclick:()=>{startClassGame("Remember the order the blocks light up, and recreate it when the light turns on!",()=>Activities.school_ExpressionGame({onEndFn:pts=>{App.pet.stats.current_expression+=pts}}))}},{name:"Flip Cards",onclick:()=>startClassGame(flipCardsDescription,()=>Activities.school_CardShuffleGame({...getFlipCardsDifficulty(App.pet.stats.current_expression),skillIcon:"special:expression",onEndFn:pts=>{App.pet.stats.current_expression+=pts}}))}])},{name:`${App.getIcon("special:logic")} Logic`,onclick:()=>App.displayList([{name:"Отслеживать",onclick:()=>startClassGame(`Keep track of the card with the ${App.getIcon("star",!0)} symbol and select it after the shuffle!`,()=>Activities.school_CardShuffleGame({activeCards:1,maxCards:4,swapDelay:200,maxSwaps:10,maxAttempts:1,skillIcon:"special:logic",onEndFn:pts=>{App.pet.stats.current_logic+=pts}}))},{name:"Flip Cards",onclick:()=>startClassGame(flipCardsDescription,()=>Activities.school_CardShuffleGame({...getFlipCardsDifficulty(App.pet.stats.current_logic),skillIcon:"special:logic",onEndFn:pts=>{App.pet.stats.current_logic+=pts}}))}])},{name:`${App.getIcon("special:endurance")} Endurance`,onclick:()=>App.displayList([{name:"Skipping Rope",onclick:()=>{startClassGame("Jump at the perfect time to avoid touching the rope!",()=>Activities.school_EnduranceGame({onEndFn:pts=>{App.pet.stats.current_endurance+=pts}}))}},{name:"Flip Cards",onclick:()=>startClassGame(flipCardsDescription,()=>Activities.school_CardShuffleGame({...getFlipCardsDifficulty(App.pet.stats.current_endurance),skillIcon:"special:endurance",onEndFn:pts=>{App.pet.stats.current_endurance+=pts}}))}])}],()=>{App.handlers.open_activity_list(!0)})},open_mall_activity_list:function(){const hasNewMainDecor=Object.keys(App.definitions.room_background).some(key=>{const room=App.definitions.room_background[key];if(room.type)return!1;const isUnlocked=!room.unlockKey||App.getRecord(room.unlockKey);return room.isNew&&isUnlocked&&!room.isCraftable}),hasNewKitchenDecor=Object.keys(App.definitions.room_background).some(key=>{const room=App.definitions.room_background[key];if("kitchen"!==room.type)return!1;const isUnlocked=!room.unlockKey||App.getRecord(room.unlockKey);return room.isNew&&isUnlocked&&!room.isCraftable}),hasNewBathroomDecor=Object.keys(App.definitions.room_background).some(key=>{const room=App.definitions.room_background[key];if("bathroom"!==room.type)return!1;const isUnlocked=!room.unlockKey||App.getRecord(room.unlockKey);return room.isNew&&isUnlocked&&!room.isCraftable}),hasNewAccessory=Object.keys(App.definitions.accessories).some(key=>{const accessory=App.definitions.accessories[key],isUnlocked=!accessory.unlockKey||App.getRecord(accessory.unlockKey),accessShopExclusive=accessory.accessShop;return accessory.isNew&&isUnlocked&&!accessory.isCraftable&&!accessShopExclusive}),hasNewItem=Object.keys(App.definitions.item).some(key=>{const isUnlocked=!App.definitions.item[key].unlockKey||App.getRecord(App.definitions.item[key].unlockKey);return App.definitions.item[key].isNew&&isUnlocked}),hasNewFurniture=Object.keys(App.definitions.furniture).some(key=>{const furniture=App.definitions.furniture[key],isUnlocked=!furniture.unlockKey||App.getRecord(furniture.unlockKey);return furniture.isNew&&isUnlocked&&!furniture.isCraftable});App.displayList([{name:`buy items ${hasNewItem?App.getBadge("new!"):""}`,onclick:()=>(App.handlers.open_item_list(!0),!0)},{name:`buy accessories ${hasNewAccessory?App.getBadge("new!"):""}`,onclick:()=>(App.handlers.open_accessory_list({buyMode:!0}),!0)},{name:`redécor room ${hasNewMainDecor?App.getBadge("new!"):""}`,onclick:()=>{const createFilterFn=type=>e=>e.type===type&&!e.isCraftable;return App.displayList([{name:`main room ${hasNewMainDecor?App.getBadge("new!"):""}`,onclick:()=>App.displayList([{name:`Pre-furnished ${hasNewMainDecor?App.getBadge("new!"):""}`,onclick:()=>App.handlers.open_room_background_list(!1,createFilterFn())},{name:`Customizable ${hasNewMainDecor?App.getBadge("new!"):""}`,onclick:()=>App.handlers.open_room_background_list(!0,createFilterFn())},{type:"info",name:"Place up to 5 furniture items of your choosing in customizable rooms."}])},{name:`bathroom ${hasNewBathroomDecor?App.getBadge("new!"):""}`,onclick:()=>App.handlers.open_room_background_list(!1,createFilterFn("bathroom"))},{name:`kitchen ${hasNewKitchenDecor?App.getBadge("new!"):""}`,onclick:()=>App.handlers.open_room_background_list(!1,createFilterFn("kitchen"))}])}},{name:`Buy furniture ${hasNewFurniture?App.getBadge("new!"):""}`,onclick:()=>(App.handlers.open_furniture_list(),!0)}],()=>{App.temp.purchasedMallItem?(App.temp.purchasedMallItem=!1,App.closeAllDisplays(),Activities.receivePurchasedItems(()=>App.handlers.open_activity_list(!0))):App.handlers.open_activity_list(!0)})},open_market_menu:function(){const hasNewFood=Object.keys(App.definitions.food).some(key=>{const definition=App.definitions.food[key];if(!definition.type)return definition.isNew}),hasNewTreat=Object.keys(App.definitions.food).some(key=>{const definition=App.definitions.food[key];if("treat"===definition.type)return definition.isNew}),hasNewMed=Object.keys(App.definitions.food).some(key=>{const definition=App.definitions.food[key];if("med"===definition.type)return definition.isNew});App.displayList([{name:`purchase food ${hasNewFood?App.getBadge("new!"):""}`,onclick:()=>(App.handlers.open_food_list({buyMode:!0,filterType:"food"}),!0)},{name:`purchase snacks ${hasNewTreat?App.getBadge("new!"):""}`,onclick:()=>(App.handlers.open_food_list({buyMode:!0,filterType:"treat"}),!0)},{name:`purchase meds ${hasNewMed?App.getBadge("new!"):""}`,onclick:()=>(App.handlers.open_food_list({buyMode:!0,filterType:"med"}),!0)},{name:"purchase seeds",onclick:()=>(App.handlers.open_seed_list(!0),!0)},{name:"sell",onclick:()=>(App.handlers.open_sell_list(),!0)},{name:"Shop stock changes daily, so check back often for new offers!",type:"info"}],()=>{App.handlers.open_activity_list(!0)})},open_sell_list:function(){App.displayList([{name:"Еда",onclick:()=>(App.handlers.open_food_list({sellMode:!0}),!0)},{name:"You can sell special items (★) for more than the market price",type:"info"}])},open_game_list:function(){App.displayList([{_disable:App.petDefinition.lifeStage<PetDefinition.LIFE_STAGE.child,name:"flags",onclick:()=>(App.displayPopup('Нажимай, когда оба флага опущены! \n                        <div class="flex justify-center">\n                            <img src="resources/img/ui/flags.png"></img>\n                        </div>\n                        ',2e3,()=>Activities.flagsGame()),!1)},{name:"crop match",onclick:()=>(App.displayPopup("Запомни порядок появления растений!",2e3,()=>Activities.plantMatchingGame()),!1)},{_disable:App.petDefinition.lifeStage<PetDefinition.LIFE_STAGE.child,name:"pet grooming",onclick:()=>(App.displayPopup('Нажимай на иконку мытья <i class="fa-solid fa-hands-wash"></i> как можно чаще до конца таймера!',2e3,()=>Activities.dogWashingGame()),!1)},{name:"mimic",onclick:()=>{const imgPath="resources/img/ui/",images=`\n                        <div class="flex justify-center">\n                            <img src="${imgPath}facing_left.png"></img>\n                            <img src="${imgPath}facing_center.png"></img>\n                            <img src="${imgPath}facing_right.png"></img>\n                        </div>\n                        `;return App.displayPopup(`Угадай следующую позу соперника ${images} и повтори её!`,2e3,()=>Activities.opponentMimicGame()),!1}},{name:"catch",onclick:()=>(App.displayPopup('Лови <img src="resources/img/misc/heart_particle_01.png"></img> и избегай <img src="resources/img/misc/falling_poop.png"></img>',2e3,()=>Activities.fallingStuffGame()),!1)},{_disable:App.petDefinition.lifeStage<PetDefinition.LIFE_STAGE.child,name:"Рыбалка",onclick:()=>(App.displayPopup("Останови указатель в нужный момент!",2e3,()=>Activities.barTimingGame()),!1)}],()=>{App.handlers.open_activity_list(!0)})},open_battle_screen:function(){Battle.start()},shell_button:function(){if(App.disableGameplayControls&&App.gameplayControlsOverwrite)return void(App.haveAnyDisplays()||(App.gameplayControlsOverwrite(),App.vibrate()));if(App.disableGameplayControls)return;let disallow=!1;[...document.querySelectorAll(".display")].forEach(display=>{display.closest(".cloneables")||(display.classList.contains("popup")&&(disallow=!0),display.classList.contains("confirm")&&(disallow=!0),display.classList.contains("prompt")&&(disallow=!0))}),disallow||(App.setScene(App.scene.home),App.haveAnyDisplays()?App.closeAllDisplays():App.handlers.open_main_menu(),App.vibrate())},sleep:function(){App.pet.sleep(),App.save()},clean:function(){App.pet.stopMove(),App.pet.triggerScriptedState("idle",App.INF,!1,!0),App.pet.x=20,App.pet.y=App.scene.home.petY,App.toggleGameplayControls(!1),Missions.done(Missions.TYPES.clean_room);const getDraggedWithMop=(object2d,size)=>{object2d.x<=mop.x+mop.width?(object2d.x=mop.x+mop.width,object2d._dragStart||(object2d._dragStart=App.time),object2d.setState?.(App.time-object2d._dragStart<500?"shocked":App.pet.stats.has_poop_out?"idle":"mild_uncomfortable")):delete object2d._dragStart},poopObjects=App.drawer.selectObjects("poop"),mop=new Object2d({image:App.preloadedResources["resources/img/misc/cleaner.png"],x:-100,y:0,z:100,rotation:-90,width:96,height:96,onDraw:function(me){Object2d.animations.flip(me),this.x+=1,getDraggedWithMop(App.pet,App.petDefinition.spritesheet.cellSize),poopObjects.forEach(poop=>getDraggedWithMop(poop)),App.spawnedAnimals?.forEach(animal=>getDraggedWithMop(animal)),this.x>=mop.width/1.5&&(me.hidden=!0,App.pet.setState("idle"),App.fadeScreen({middleFn:()=>{App.pet.stopScriptedState(),App.drawer.removeObject(this),App.toggleGameplayControls(!0),App.pet.x="50%",App.pet.playCheeringAnimationIfTrue(App.pet.stats.has_poop_out,()=>{}),App.pet.stats.has_poop_out=!1,poopObjects.forEach(poop=>poop.removeObject()),App.spawnedAnimals?.forEach(animal=>animal.x=`${random(20,80)}%`)}}))}})}},toggleGameplayControls:function(state,onclick){App.disableGameplayControls=!state,App.gameplayControlsOverwrite=onclick,App.disableGameplayControls&&!onclick?App.drawer.canvas.style.cursor="not-allowed":App.drawer.canvas.style.cursor="pointer",App.settings.classicMainMenuUI&&(state?document.querySelector(".classic-main-menu__container").classList.remove("disabled"):document.querySelector(".classic-main-menu__container").classList.add("disabled"))},getGameplayControlsState:function(){return{state:!App.disableGameplayControls,onclick:App.gameplayControlsOverwrite}},createProgressbar:function(percent){let progressbar=document.querySelector(".cloneables .progressbar").cloneNode(!0),rod=progressbar.querySelector(".progressbar-rod"),background=progressbar.querySelector(".progressbar-background"),colors_green=["#04E762","#93C48B"],colors_red=["#ED254E","#ED254E"],colors_yellow=["#FDBA70","#FF8300"];function setPercent(percent){rod.style.width=`${percent}%`;let colorSet=colors_green;percent<30?colorSet=colors_red:percent<60&&(colorSet=colors_yellow);let rodColor=`linear-gradient(90deg, ${colorSet[0]}, ${colorSet[1]})`;rod.style.background=rodColor,background.style.background=`repeating-linear-gradient(90deg, ${colorSet[1]} 5px, ${colorSet[1]} 7px, transparent 6px, transparent 10px)`}return setPercent(percent),{node:progressbar,setPercent:setPercent}},createStepper:function(maxSteps,currentStep){const element=document.createElement("div");return element.className="stepper",element.innerHTML=`\n            ${new Array(maxSteps).fill(void 0).map((_,i)=>`\n                <div \n                    class="stepper__step ${i+1<=currentStep?"active":""}"\n                >\n                    <span class="stepper__text">\n                    <i class="fa fa-solid fa-check"></i>\n                    </span>\n                </div>\n            `).join("\n")}\n        `,{node:element}},closeAllDisplays:function(){[...document.querySelectorAll(".display")].forEach(display=>{display.closest(".cloneables")||(display.close?display.close():display.remove())})},haveAnyDisplays:function(){return!![...document.querySelectorAll(".screen-wrapper .display")].length},initTab:function(element){if(!element.querySelector(".tabs"))return;const tabTitles=[...element.querySelectorAll(".tab-title")],tabContents=[...element.querySelectorAll(".tab")];tabTitles.forEach(tabTitle=>{const forWhichElement=tabTitle.getAttribute("for"),correspondingContent=tabContents.find(t=>t.id===forWhichElement);tabTitle.onclick=()=>{[...tabTitles,...tabContents].forEach(e=>e.classList.remove("active")),tabTitle.classList.add("active"),correspondingContent.classList.add("active")}}),tabTitles.at(0).click()},displayList:function(listItems,backFn,backFnTitle){const list=UI.genericListContainer(backFn,backFnTitle);return list._listItems=listItems,listItems.forEach((item,i)=>{if(item._ignore)return;let element,defaultClassName;switch(item.name||(item.name=""),item.type){case"empty":element=document.createElement("p"),element.innerHTML=item.name,defaultClassName="";break;case"info":case"text":element=document.createElement("p"),element.innerHTML=item.name,defaultClassName=`inner-padding b-radius-10 uppercase list-text ${item.solid?"solid-":""}surface-stylized ${item.bold?"text-bold":""}`,"info"===item.type&&(element.innerHTML=`\n                            <small>\n                                ${App.getIcon(item.icon||"info-circle",!0)}\n                                ${item.name}\n                            </small>\n                        `);break;case"separator":element=document.createElement("hr"),defaultClassName="content-separator";break;case"element":element=item.innerHTML,defaultClassName="";break;default:element=document.createElement(item.link?"a":"button"),item.link&&(element.href=item.link,element.target="_blank"),item.icon&&(item.name=`<i class="fa-solid fa-${item.icon} corner-icon"></i> ${item.name}`),i==listItems.length-2&&(element.className+=" last-btn"),-1==item.name.indexOf("<")&&-1==item.name.indexOf("/")&&(item.name=ellipsis(item.name,item.ellipsisLength)),element.innerHTML=item.name,element.disabled=item._disable,element.style=`--child-index:${Math.min(i,10)+1}`,element.onclick=()=>{App.playSound("resources/sounds/ui_click_01.ogg",!0),UI.lastClickedButton=element,item.onclick(element,list)||list.close()},defaultClassName="generic-btn stylized mute"}element.className=defaultClassName+(item.class?" "+item.class:""),item.style&&(element.style=item.style),item.id&&(element.id=item.id),item._mount?.(element),element._mount=()=>item._mount?.(element),list.appendChild(element)}),document.querySelector(".screen-wrapper").appendChild(list),list},displayGrid:function(listItems){let list=document.querySelector(".cloneables .generic-grid-container").cloneNode(!0);return list.close=function(){list.remove()},listItems.forEach(item=>{let button=document.createElement("button");button.className="grid-item "+(item.class?item.class:""),button.innerHTML=item.name,button.onclick=()=>{item.onclick(button,list)||list.close()},list.appendChild(button)}),document.querySelector(".screen-wrapper").appendChild(list),list},display2xGrid:function(listItems){const list=document.querySelector(".cloneables .generic-grid-container").cloneNode(!0);return list.classList.add("flex-wrap","flex-gap-1"),list.close=function(){list.remove()},listItems.forEach(item=>{let button=document.createElement("button");button.className="grid-item-2x generic-btn stylized "+(item.class?item.class:""),button.innerHTML=item.name,button.onclick=()=>{item.onclick(button,list)||list.close()},list.appendChild(button)}),document.querySelector(".screen-wrapper").appendChild(list),list},displaySlider:function(listItems,activeIndex,options,additionalText){const hasIndexMenu=listItems.some(item=>item?.shortName);let list=document.querySelector(".cloneables .generic-slider-container").cloneNode(!0);0===activeIndex||activeIndex||list.classList.add("menu-animation");let maxIndex=listItems.length,currentIndex=Math.min(activeIndex,listItems.length-1)||0,contentElement=list.querySelector(".content"),acceptBtn=list.querySelector("#accept-btn"),cancelBtn=list.querySelector("#cancel-btn");list.close=function(){list.remove()},cancelBtn.innerHTML=options?.cancel||'<i class="fa-solid fa-arrow-left"></i>',acceptBtn.innerHTML=options?.accept||"Accept";const defaultAcceptButtonLabel=acceptBtn.innerHTML;list.getCurrentIndex=()=>currentIndex,cancelBtn.onclick=()=>{options?.onCancel?.(),list.close()},changeIndex=(diff=0,asAbsoluteIndex)=>{currentIndex+=diff,currentIndex>=maxIndex?currentIndex=0:currentIndex<0&&(currentIndex=maxIndex-1),asAbsoluteIndex&&(currentIndex=diff);let item=listItems[currentIndex],itemContent=document.createElement("div");itemContent.className="slider-item"+(item.class?item.class:""),itemContent.innerHTML=item.name,itemContent.setAttribute("data-index",currentIndex),acceptBtn.innerHTML=item.acceptLabel||defaultAcceptButtonLabel,acceptBtn.disabled=item.disabled,acceptBtn.onclick=()=>{item.onclick(itemContent,list)||list.close()};let animationStart=diff<0?"slider-item-anim-in-left":"slider-item-anim-in-right";itemContent.style.animation=`${diff?animationStart:""} 0.1s linear forwards`,contentElement.innerHTML="",contentElement.appendChild(itemContent)};const displayItemsList=()=>{App.displayList(listItems?.map((item,index)=>({_disable:item.disabled,name:item.shortName,class:index===currentIndex?"active":"",onclick:()=>{changeIndex(index,!0)}})),null,"Назад")};if(list.querySelector(".slide-left").onclick=()=>{contentElement.querySelector(".slider-item").style.animation="slider-item-anim-out-right 0.1s linear forwards",setTimeout(()=>changeIndex(-1),150),App.playSound("resources/sounds/ui_click_01.ogg",!0)},list.querySelector(".slide-right").onclick=()=>{contentElement.querySelector(".slider-item").style.animation="slider-item-anim-out-left 0.1s linear forwards",setTimeout(()=>changeIndex(1),150),App.playSound("resources/sounds/ui_click_01.ogg",!0)},additionalText?list.querySelector(".top-slot.left").innerHTML=additionalText:list.querySelector(".top-slot.left").remove(),hasIndexMenu){const rightSlot=list.querySelector(".top-slot.right");rightSlot.innerHTML=`<div class="pointer-events-none">${App.getIcon("list",!0)}</div>`,rightSlot.classList.add("cursor-pointer","click-sound"),rightSlot.onclick=displayItemsList}else list.querySelector(".top-slot.right").remove();return 1===maxIndex&&(list.querySelector(".slide-left").classList.add("disabled"),list.querySelector(".slide-right").classList.add("disabled")),changeIndex(),document.querySelector(".screen-wrapper").appendChild(list),list},displayMessageBubble:function(content,icon=""){let splitContent=content;containsHtmlTags(content)||(splitContent=content.split("").map((letter,index)=>`<span style="animation-delay: ${.05*index}s">${letter}</span>`).join(""));const display=App.displayEmpty("bg-transparent pointer-events-none");display.close=()=>{UI.fadeOut(display.querySelector(".message-bubble")),setTimeout(()=>display.remove(),1e3)};const iconContent=icon?`<div class="message-bubble_icon">${icon}</div>`:"";return display.innerHTML=`<div class="message-bubble">${iconContent}${splitContent}</div>`,display.classList.remove("display"),display},displayPopup:function(content,ms,onEndFn,isReveal){let popup=document.querySelector(".cloneables .generic-list-container").cloneNode(!0);return popup.classList.add("popup"),isReveal&&popup.classList.add("revealing"),popup.innerHTML=`\n                <div class="uppercase flex-center">\n                    <div class="inner-padding b-radius-10 surface-stylized">\n                        ${content}\n                    </div>\n                </div>\n            `,popup.style["z-index"]=3,popup.style.background="var(--background-c)",popup.close=()=>{popup.remove(),onEndFn&&onEndFn()},UI.attachScrollableIndicator(popup),setTimeout(()=>{popup.close()},ms||2e3),document.querySelector(".screen-wrapper").appendChild(popup),popup},displayConfirm:function(text,buttons){let list=document.querySelector(".cloneables .generic-list-container").cloneNode(!0);list.classList.add("confirm","inline-flex-between"),list.innerHTML=`\n                <div class="uppercase flex-center flex-1 height-auto">\n                    <div class="inner-padding b-radius-10 surface-stylized">\n                        ${text}\n                    </div>\n                </div>\n                <div class="buttons-container"></div>\n            `,list.style["z-index"]=3,list.style.background="var(--background-d)",list.close=function(){list.remove()},UI.attachScrollableIndicator(list);const btnContainer=list.querySelector(".buttons-container");return buttons.forEach(def=>{if(def._ignore)return;const btn=document.createElement(def.link?"a":"button");def.link&&(btn.href=def.link,btn.target="_blank"),btn.innerHTML=def.name,btn.className=`generic-btn stylized ${def.class||""}`,btn.disabled=def._disable,"back"==def.name&&(btn.className+=" back-btn"),btn.onclick=()=>{def.onclick()||list.close()},btnContainer.appendChild(btn)}),document.querySelector(".screen-wrapper").appendChild(list),list},displayPrompt:function(text,buttons,defaultValue){let list=document.querySelector(".cloneables .generic-list-container").cloneNode(!0);list.classList.add("prompt"),list.innerHTML=`\n                <div class="uppercase flex-center">\n                    <div class="inner-padding b-radius-10 surface-stylized">\n                        ${text}\n                    </div>\n                </div>\n                <div class="buttons-container"></div>\n            `,list.style["z-index"]=3,list.close=function(){list.remove()},UI.attachScrollableIndicator(list);const btnContainer=list.querySelector(".buttons-container");let input=document.createElement("input");return input.setAttribute("spellcheck",!1),void 0!==defaultValue&&(input.value=defaultValue),list.insertBefore(input,btnContainer),buttons.forEach(def=>{if(def._ignore)return;const btn=document.createElement("button");btn.innerHTML=def.name,btn.className=`generic-btn stylized ${def.class||""}`,btn.onclick=()=>{def.onclick(input.value)||list.close()},btnContainer.appendChild(btn)}),document.querySelector(".screen-wrapper").appendChild(list),input.focus(),list},displayEmpty:function(addClass){let display=document.querySelector(".cloneables .generic-empty-container").cloneNode(!0);return addClass&&(display.className+=" "+addClass),document.querySelector(".screen-wrapper").appendChild(display),display.close=function(){display.remove()},display},displayUiModal:function(content){let modal=document.createElement("div");modal.className="modal",modal.innerHTML=content,document.body.appendChild(modal)},getBadge:function(text,color,expirationDate){return text||""===text||(text="новое!"),color||(color="red"),expirationDate&&moment(expirationDate).isBefore(moment())?"":`<span class="badge ${color}">${text}</span>`},drawUI:function(){App.drawer.drawImmediate({x:5,y:50,width:25,height:25,text:"HEY"})},initSound:function(){try{this.audioChannel=new AudioChannel({preloadList:SOUNDS})}catch(e){}const clickSoundClassNames=["click-sound","list-item","tab-title"],backSoundClassNames=["back-btn","back-sound"];document.addEventListener("click",e=>{if((clickSoundClassNames.some(n=>e.target.classList.contains(n))||"button"===e.target.nodeName.toLowerCase()||"button"===e.target.parentElement?.nodeName.toLowerCase())&&(App.vibrate(),e.target.classList.contains("mute")||e.target.parentElement?.classList.contains("mute")||(backSoundClassNames.some(n=>e.target.classList.contains(n))||"back"==e.target.textContent.toLowerCase()?this.playSound("resources/sounds/ui_click_02.ogg",!0):this.playSound("resources/sounds/ui_click_01.ogg",!0))),e.target.classList.contains("back-btn")||e.target.parentElement?.classList.contains("back-btn")){const previousListItem=[...document.querySelectorAll(".screen-wrapper .generic-list-container")].at(-1);previousListItem&&(previousListItem.transitionAnim?.(),[...previousListItem.children].forEach(child=>child?._mount?.(child))),UI.lastClickedButton=null}})},formatTo12Hours:function(hour){return hour>12?hour-12+"pm":hour+"am"},getDayId:function(forCurrentUser){if(forCurrentUser)return+(App.getDayId()+(App.userId||1234)).toString().slice(0,10);const date=new Date;return+`${date.getFullYear()}${date.getMonth()}${date.getDate()+2}`},isSalesDay:function(){let day=(new Date).getDate();return[7,12,18,20,25,29,30].includes(day)},isDuringChristmas:function(){return moment().isBetween(moment(App.constants.CHRISTMAS_TIME.start,"MM-DD"),moment(App.constants.CHRISTMAS_TIME.end,"MM-DD"),null,"[]")},isChristmasDay:function(){return moment().isSame(moment(App.constants.CHRISTMAS_TIME.absDay,"MM-DD"),"day")},isSleepHour:function(hour=(new Date).getHours()){return App.isWithinHour(hour,App.constants.SLEEP_START+App.settings.sleepingHoursOffset,App.constants.SLEEP_END+App.settings.sleepingHoursOffset)},getSeason:function(date=moment()){if("auto"!==App.settings.season)return App.settings.season;const month=date.month();return month>=2&&month<=4?"spring":month>=5&&month<=7?"summer":month>=8&&month<=10?"autumn":"winter"},getSeasonColor:function(name){const{SEASON_COLORS:SEASON_COLORS}=App.constants,{source:source}=SEASON_COLORS,currentSeason=SEASON_COLORS[name]||SEASON_COLORS.spring,[shadow,base,highlight]=currentSeason;return[[source.shadow0,shadow],[source.shadow1,shadow],[source.base,base],[source.highlight,highlight]]},isWithinHour:function(current,start,end){return start=App.clampWithin24HourFormat(start),end=App.clampWithin24HourFormat(end),current=App.clampWithin24HourFormat(current),start<=end?current>=start&&current<end:current>=start||current<end},getOutOfStockCounter:(seed=random(1,999999999))=>{pRandom.save(),pRandom.seed=seed;const randomArray=new Array(100).fill(50).map(()=>pRandom.getIntBetween(0,100)).reverse();pRandom.load();let pointer=0;return percent=>(pointer+=1,pointer>=randomArray.length&&(pointer=0),(randomArray.at(pointer)||50)<percent)},clampWithin24HourFormat:function(hour){return(hour%24+24)%24},getFoodCSprite:function(index){const{FOOD_SPRITESHEET_DIMENSIONS:FOOD_SPRITESHEET_DIMENSIONS,FOOD_SPRITESHEET:FOOD_SPRITESHEET}=App.constants,size=FOOD_SPRITESHEET_DIMENSIONS.rows*FOOD_SPRITESHEET_DIMENSIONS.cellSize;return`<c-sprite \n            naturalWidth="${size}" \n            naturalHeight="${size}" \n            width="${FOOD_SPRITESHEET_DIMENSIONS.cellSize}" height="${FOOD_SPRITESHEET_DIMENSIONS.cellSize}" \n            index="${index-1}"\n            src="${FOOD_SPRITESHEET}"></c-sprite>`},getItemCSprite:function(index){const{ITEM_SPRITESHEET_DIMENSIONS:ITEM_SPRITESHEET_DIMENSIONS,ITEM_SPRITESHEET:ITEM_SPRITESHEET}=App.constants,size=ITEM_SPRITESHEET_DIMENSIONS.rows*ITEM_SPRITESHEET_DIMENSIONS.cellSize;return`<c-sprite \n            naturalWidth="${size}" \n            naturalHeight="${size}" \n            width="${ITEM_SPRITESHEET_DIMENSIONS.cellSize}" \n            height="${ITEM_SPRITESHEET_DIMENSIONS.cellSize}" \n            index="${index-1}" \n            src="${ITEM_SPRITESHEET}"></c-sprite>`},getAccessoryCSprite:function(name){const current=App.definitions.accessories[name],image=App.checkResourceOverride(current.icon||current.image);return current.icon?`<div style="width: 1"><img style="width: 36px; outline: none" src="${image}"></img></div>`:`<c-sprite width="64" height="36" index="0" src="${image}"></c-sprite>`},getGenericCSprite:function(index,spritesheet,dimensions,className="",additional=""){const size=dimensions.rows*dimensions.cellSize;return`<c-sprite \n            naturalWidth="${size}" \n            naturalHeight="${size}" \n            width="${dimensions.cellSize}" \n            height="${dimensions.cellSize}" \n            index="${index-1}" \n            class="${className}"\n            src="${spritesheet}"\n            ${additional}></c-sprite>`},getPersona:function(name,image){return`\n            <img style="height: inherit; width: 32px; object-fit: contain; margin-right: 10px" src="${image}"></img>\n            <span class="overflow-hidden ellipsis">${name}<span>\n        `},getHarvestIcons:function(plantNameList,delimiter=" + ",disabledClassName=""){return plantNameList.map(plantName=>{const hasInInventory=App.pet.inventory.harvests[plantName];return Plant.getCSprite(plantName,void 0,hasInInventory?"enabled":disabledClassName)}).join(delimiter)},getHarvestInventoryUI:function(filterFn=()=>!0){const harvestsToShow=Object.keys(App.pet.inventory.harvests).map(name=>({amount:App.pet.inventory.harvests[name],name:name,def:Plant.getDefinitionByName(name)})).filter(item=>item.amount).filter(filterFn);return harvestsToShow.length?`\n        ${harvestsToShow.map(item=>`<div onclick="App.displayPopup('${item.name} <div><b>x${item.amount}</b></div>')" class="flex align-center flex-gap-05">${Plant.getCSprite(item.name)} <span><small>x</small>${item.amount}</span></div>`).join("")}\n        `:App.getEmptyStateUI("Инвентарь пуст")},getEmptyStateUI:function(text,icon="fa-ghost"){return`<small class="flex-center width-full flex-gap-05 opacity-half">\n            <i class="fa-solid ${icon}"></i>\n            <i>${text}</i>\n        </small>`},getUidUI:()=>{const UID=App.userName?""+((App.userName??"")+"-"+App.userId?.toString().slice(0,5)):"";return`\n            <div class="user-id surface-stylized inner-padding text-transform-none">\n                <div class="flex flex-dir-col">\n                    <small>uid:</small>\n                    <span>${UID}</span>\n                </div>\n                <small onclick="App.handlers.copyToClipboard('${UID}')" class="${"clipboard"in navigator&&!App.isOnItch&&UID?"flex":"hidden"} justify-end"> \n                    <button class="generic-btn stylized uppercase" id="copy-btn"> \n                        <i class="fa-solid fa-copy"></i>\n                    </button> \n                </small>\n            </div>\n        `},isCompanionAllowed:function(room){room||(room=App.currentScene);return[App.scene.home,App.scene.bathroom,App.scene.kitchen,App.scene.graveyard,App.scene.parentsHome].includes(room)},getRandomGameplayBuff:()=>randomFromArray(Object.values(App.definitions.gameplay_buffs)).key,isGameplayBuffActive:buffKey=>App.animals.list.some(a=>a.stats.buff===buffKey),getGameplayBuffDefinitionFromKey:buffKey=>App.definitions.gameplay_buffs[buffKey],getGameplayBuffUI:buff=>{"string"==typeof buff&&(buff=App.getGameplayBuffDefinitionFromKey(buff));return`\n            <div class="font-small flex flex-dir-col gameplay-buff-container">\n                <div style="opacity: 0.75;"> ${(()=>{let color="";if("garden"===buff.type)color="green";return`<span style="color: ${color}"> <i class="fa-solid fa-arrow-circle-up icon"></i> ${buff.type}</span> Buff`})()} </div>\n                <b style="color: #3d00ff"> ${buff.name}</b>\n                <i>${buff.description}</i>\n            </div>\n        `},playSound:function(path,force){App.settings.playSound&&this.audioChannel?.play(path,force)},playAdvancedSound:function(config){const audioElement=new Audio;return Object.keys(config).map(key=>audioElement[key]=config[key]),audioElement.play(),audioElement.muted=!App.settings.playSound||!App.settings.playMusic,config.loopTime&&audioElement.addEventListener("timeupdate",()=>{audioElement.currentTime>=config.loopTime&&(audioElement.currentTime=0,audioElement.play())}),{element:audioElement,stop:()=>{const fadeOutEvent=App.registerOnDrawEvent(()=>{const volume=audioElement.volume-5e-4*App.deltaTime;audioElement.volume=clamp(volume,0,1),audioElement.volume<=0&&(audioElement.pause(),App.unregisterOnDrawEvent(fadeOutEvent))})}}},takeScreenshot:()=>{if(App.haveAnyDisplays())return;const overlay=document.querySelector(".screenshot-overlay");UI.show(overlay),setTimeout(()=>UI.hide(overlay),250),App.playSound("resources/sounds/camera_shutter_01.ogg");const name="Tamaweb_"+moment().format("D-M-YY_h-m-s");downloadUpscaledCanvasAsImage(App.drawer.canvas,name,5)},handleSequentiallyLoad:async function(loaders){const isValid=data=>Boolean(data?.lastTime&&data.pet?.name);let mainData;try{for(const loader of loaders){const data=await loader();if(mainData||(mainData=data),data.hasLoadError)throw"LoadError7520";if(isValid(data))return data}}catch(e){const _save=App.save;App.save=()=>{};const display=App.displayConfirm(`${App.getIcon("warning")} Ошибка при загрузке системы сохранений.`,[{name:"Перезагрузить",class:"back-btn",onclick:()=>(window.location.reload(),!0)},{name:"Continue (Unsafe)",onclick:()=>App.displayConfirm("Можно потерять прогресс, если продолжить!",[{name:"Продолжить",onclick:()=>(App.save=_save,display.close(),!1)},{name:"Отмена",class:"back-btn",onclick:()=>{}}])},{name:"Показать ошибку",onclick:()=>App.displayConfirm(e,[{name:"Ок",onclick:()=>{}}])}]);console.error(e),App.sendAnalytics("LoaderError",`${e} - ${navigator?.userAgent}`),UI.fadeOut(document.querySelector(".loading-text"))}return mainData},save:function(noIndicator){if(!App.pet||!App.loadingEnded)return;const timeElapsedSinceLastSave=App.time-(App.temp.lastSaved??0);if(noIndicator&&timeElapsedSinceLastSave<App.constants.AUTO_SAVE_INTERVAL_SECS/2*1e3)return;App.temp.lastSaved=1/0;const localStorageItemKeys=["user_name","user_id","pet","records","ingame_events_history","missions","furniture","plants","animals","play_time","last_time","settings"];let savingData=[];const setItem=(key,value)=>{savingData=[...savingData,[key,value]],localStorageItemKeys.includes(key)&&window.localStorage?.setItem(key,JSON.stringify(value))};if(setItem("pet",App.pet.serializeStats()),setItem("settings",App.settings),setItem("last_time",Date.now()),setItem("user_id",App.userId),setItem("user_name",App.userName),setItem("ingame_events_history",App.gameEventsHistory),setItem("play_time",App.playTime),setItem("shell_background_v2.2",App.shellBackground),setItem("mods",App.mods),setItem("records",App.records),setItem("room_customization",{home:{image:App.scene.home.image},bathroom:{image:App.scene.bathroom.image},kitchen:{image:App.scene.kitchen.image}}),setItem("missions",{current:Missions.current,currentStep:Missions.currentStep,currentPts:Missions.currentPts,refreshTime:Missions.refreshTime}),setItem("furniture",App.ownedFurniture),setItem("plants",App.plants),setItem("animals",{...App.animals,list:[...App.animals.list.map(a=>a.serialize())]}),!noIndicator){const saveIcon=document.querySelector(".save-indicator");saveIcon.style.display="",setTimeout(()=>saveIcon.style.display="none",2e3)}savingData?.length?window.idbKeyval?.setMany(savingData).then(()=>App.temp.lastSaved=App.time).catch(e=>{setTimeout(()=>App.temp.lastSaved=App.time,5e3),App.sendErrorLog(`idbKeyval-setMany: ${e}`)}):App.sendErrorLog(`savingData-no-length: ${savingData?.length}`)},load:async function(){let hasLoadError=!1;const getItem=async(key,defaultValue)=>{if(!window.idbKeyval)return hasLoadError=!0,defaultValue;const value=await window.idbKeyval.get(key),fallbackValue=(key=>{const item=window.localStorage?.getItem(key);try{return JSON.parse(item)}catch(e){}return!1})(key);return fallbackValue&&!value&&console.log("save data fallback",{key:key,value:value,fallbackValue:fallbackValue}),null!=value?value:fallbackValue||defaultValue},pet=await getItem("pet",{}),settings=await getItem("settings",null),lastTime=await getItem("last_time",!1),eventsHistory=await getItem("ingame_events_history",null),roomCustomizations=await getItem("room_customization",null),mods=await getItem("mods",App.mods),records=await getItem("records",App.records),userId=await getItem("user_id",random(1e11,999999999999));App.userId=userId;const userName=await getItem("user_name",null);App.userName="null"===userName?null:userName,App.playTime=parseInt(await getItem("play_time",0),10);const shellBackground=await getItem("shell_background_v2.2",App.definitions.shell_background.find(shell=>shell.isDefault).image||App.definitions.shell_background[1].image),missions=await getItem("missions",{}),furniture=await getItem("furniture",!1),plants=await getItem("plants",App.plants),animals=await getItem("animals",App.animals);return App.loadedData={pet:pet,settings:settings,lastTime:lastTime,eventsHistory:eventsHistory,roomCustomizations:roomCustomizations,shellBackground:shellBackground,playTime:App.playTime,mods:mods,records:records,missions:missions,furniture:furniture,plants:plants,animals:animals,hasLoadError:hasLoadError},App.loadedData},getDBItems:async function(){return(await window.idbKeyval.entries()).reduce((acc,[key,value])=>({...acc,[key]:value}),{})},loadFromJson:async function(json,callbackFn){const ignoreKeys=["user_name","user_id","play_time","last_time","mods","shell_background_v2.2"];App.save(),App.save=()=>{},json.animals?.list?.forEach(a=>{a.lastStatsUpdate=Date.now()}),json.pet&&(json.pet.birthday=Date.now());for(let key of Object.keys(json))ignoreKeys.includes(key)||await window.idbKeyval.set(key,json[key]);const allowedKeys=[...Object.keys(json),...ignoreKeys],currentKeys=await window.idbKeyval.keys();for(let key of currentKeys)allowedKeys.includes(key)||await window.idbKeyval.del(key);callbackFn?.()},getSaveCode:async function(providedStorage){const storage=providedStorage??await App.getDBItems(),serializableStorage=Object.assign({},storage);["shell_background_v2.2","mods"].forEach(attribute=>delete serializableStorage[attribute]);return`save:${btoa(encodeURIComponent(JSON.stringify(serializableStorage)))}:endsave`},exportSaveCode:async function(providedCode){const loadingPopup=App.displayPopup("Загрузка..."),code=providedCode??await App.getSaveCode();loadingPopup.close(),downloadTextFile(`${App.petDefinition.name}_${generateTimestamp()}.tws`,code)},vibrate:function(dur,force){(App.settings.vibrate||force)&&navigator?.vibrate&&navigator?.vibrate(dur||35)},sendAnalytics:function(type,value,force){if(!force&&"prod"!==App.ENV)return;type||(type="default"),rudderanalytics.track(type,{value:value}),App.isOnItch?type+="_itch":App.isOnElectronClient&&(type+="_electron");const url=`https://docs.google.com/forms/d/e/1FAIpQLSfzl5hhhnV3IAdxuA90ieEaeBAhCY9Bh4s151huzTMeByMwiw/formResponse?usp=pp_url&entry.1384465975=${(App.userName?App.userName+"-":"")+App.userId}&entry.1653037117=${App.petDefinition?.name||""}&entry.1322693089=${type}&entry.1403809294=${value||""}`;fetch(url).catch(e=>{})},sendFeedback:function(text){if(!text)return;const sendingText=`[game:${VERSION}-pl:${App.isOnItch?"itch":"web"}]: ${text}`,user=(App.userName?App.userName+"-":"")+App.userId;fetch(`https://docs.google.com/forms/d/e/1FAIpQLSenonpIhjHL8BYJbnOHqF2KudJiDciEveJG56BdGsvJ01-rTA/formResponse?usp=pp_url&entry.1753365981=${user}&entry.233513152=${sendingText}`).catch(e=>{})},sendErrorLog:function(error,force){if(!force&&"prod"!==App.ENV)return;if(!error)return;if(App.fullTime-App.temp.lastErrorSent<30*App.constants.ONE_SECOND)return;App.temp.lastErrorSent=App.fullTime,window?.Sentry?.captureException(error,{username:App.userName,userId:App.userId});const versionInfo=`[game:${VERSION}-pl:${App.isOnItch?"itch":"web"}]`,url=`https://docs.google.com/forms/d/e/1FAIpQLScSloIis4P1yyKQ3imYcaipOk2XS12Qj16ZeM4DicTHi3RSCQ/formResponse?usp=pp_url&entry.1957124188=${(App.userName?App.userName+"-":"")+App.userId}&entry.1587672397=${versionInfo} - ${navigator?.userAgent}&entry.36658531=${error}`;fetch(url).catch(e=>{})},installAsPWA:function(){if(!App.deferredInstallPrompt)return!1;App.deferredInstallPrompt.prompt(),App.deferredInstallPrompt.userChoice.then(choiceResult=>{"accepted"===choiceResult.outcome?App.sendAnalytics("pwa_install",navigator?.userAgent):App.sendAnalytics("pwa_install_cancel",navigator?.userAgent)})},setShellBackground:function(url){if(url)return document.querySelector("body > div.root > div.dom-shell").style.backgroundImage=`url(${url})`,document.querySelector(".background").style.backgroundImage=`url(${url})`,App.shellBackground=url,document.querySelector(".shell-btn.main").style.backgroundImage=`url(${App.shellBackground})`,document.querySelector(".shell-btn.right").style.backgroundImage=`url(${App.shellBackground})`,document.querySelector(".shell-btn.left").style.backgroundImage=`url(${App.shellBackground})`,!0},addNumToObject:function(obj,key,amount){obj[key]?obj[key]+=amount:obj[key]=amount},pay:function(amount){return App.pet.stats.gold<amount?(App.displayPopup("Недостаточно денег!"),!1):(App.pet.stats.gold-=amount,!0)},getPreciseTimeFromNow:time=>{const duration=moment.duration(moment(time).diff(moment())),hours=Math.floor(duration.asHours()),minutes=Math.floor(duration.asMinutes())%60;return hours>0?`${hours} hour${1!==hours?"s":""} and ${minutes} minute${1!==minutes?"s":""}`:`${minutes} minute${1!==minutes?"s":""}`},useWebcam:function(callback,facingMode,shutterDelay){facingMode||(facingMode="environment");const gameplayControlsState=App.getGameplayControlsState();let openStream;function unloadWebcam(){App.toggleGameplayControls(gameplayControlsState.state,gameplayControlsState.onclick),openStream?.getTracks().forEach(function(track){track.stop()}),videoContainer.remove()}function close(data){callback&&callback(data),unloadWebcam()}function showError(){App.displayConfirm("Камеру на этом устройстве загрузить нельзя",[{name:"Назад",onclick:()=>{close(-1)}}])}if(App.toggleGameplayControls(!1),!navigator?.mediaDevices)return showError();const videoContainer=document.querySelector(".webcam-container").cloneNode(!0),videoElement=videoContainer.querySelector(".webcam-video"),webcamButton=videoContainer.querySelector("#webcam-button"),webcamChangeButton=videoContainer.querySelector("#webcam-change-button"),canvas=document.createElement("canvas");document.querySelector(".screen-wrapper").appendChild(videoContainer),videoElement.onplaying=()=>{webcamButton.style.display="initial"},webcamButton.onclick=()=>{webcamButton.disabled=!0,videoElement.pause(),videoElement.classList.add("taken");const context=canvas.getContext("2d");canvas.width=document.querySelector(".screen-wrapper").clientWidth,canvas.height=document.querySelector(".screen-wrapper").clientHeight,context.drawImage(videoElement,0,0,canvas.width,canvas.height);const data=canvas.toDataURL("image/png");setTimeout(()=>{close(data)},shutterDelay||250)},webcamChangeButton.onclick=()=>{unloadWebcam(),App.useWebcam(callback,"user"==facingMode?"environment":"user")},navigator?.mediaDevices.getUserMedia({video:{facingMode:facingMode}}).then(stream=>{openStream=stream,videoElement.srcObject=stream,videoElement.addEventListener("loadedmetadata",()=>{videoElement.play()})}).catch(()=>{videoContainer.remove(),showError()})},createNotification:function(title,body){if(!App.settings.notifications)return!1;new Notification(title,{body:body,icon:"android-icon-48x48.png"})},checkPetStats:function(){if(!App.isTester())return setTimeout(()=>App.checkPetStats(),1e4);console.log("checking pet stat"),App.createNotification("this is on testing interval",`Hello my name is ${Math.random()}`),setTimeout(()=>{App.checkPetStats()},1e4)},getEncodedInputCode:code=>`${App.constants.INPUT_BASE_64}${btoa(code)}`,getIcon:function(iconName,noRightMargin,color){if(iconName.startsWith("special:")){const iconDef=App.definitions.icons[iconName.replace("special:","")];return App.getIcon(iconDef.icon,noRightMargin,iconDef.color)}return`<i class="fa-solid fa-${iconName}" style="${`${noRightMargin?"":"margin-right:10px;"}${color?`color:${color};`:""}`}"></i>`},wait:function(ms=0){return new Promise(resolve=>setTimeout(resolve,ms))},fadeScreen:function({middleFn:middleFn,endFn:endFn,speed:speed=.005}={}){let phase="fadeIn";new Object2d({image:App.getPreloadedResource("resources/img/misc/black_overlay_01.png"),opacity:0,x:0,y:0,z:1e3,onDraw:me=>{const step=speed*App.deltaTime;"fadeIn"===phase?(me.opacity+=step,me.opacity>=1.75&&(me.opacity=1.75,middleFn?.(),phase="fadeOut")):"fadeOut"===phase&&(me.opacity-=step,me.opacity<=0&&(endFn?.(),me.removeObject()))}})},apiService:{ENDPOINT:"https://script.google.com/macros/s/AKfycbxCa6Yo_VdK5t9T7ZCHabxT1EY-xACEC3VUDHgkkwGdduF2U5VMGlp0KXBu9CtE8cWv9Q/exec",ENDPOINT_TEST:"https://script.google.com/macros/s/AKfycbzvoH9j7Ia0Zc_dCBXXYI6dB9UlUR_tGGr1J5Gsu2DG/dev",_getUid:()=>App.userName+"-"+App.userId,sendRequest:async(params,handler)=>new Promise((resolve,reject)=>{fetch(`${App.apiService.ENDPOINT}?${params.toString()}`).then(response=>response.json()).then(json=>{const handledResult=handler?.(json,!1);resolve(handledResult??json)}).catch(e=>{const handledResult=handler?.(e,!0);resolve(handledResult??{error:e})})}),addPetDef:petDef=>{const params=new URLSearchParams({action:"addPetDef",userId:App.apiService._getUid(),data:JSON.stringify({name:App.petDefinition.name,sprite:App.petDefinition.sprite,accessories:App.petDefinition.accessories,is_ghost:0!==App.petDefinition.stats.is_ghost?App.petDefinition.stats.is_ghost:void 0})});return App.apiService.sendRequest(params)},getPetDef:userId=>{userId||(userId=App.apiService._getUid());const params=new URLSearchParams({action:"getPetDef",userId:userId});return App.apiService.sendRequest(params)},getRandomPetDefs:amount=>{const params=new URLSearchParams({action:"getRandomPetDefs",amount:amount??10});return App.apiService.sendRequest(params,(json,error)=>!error&&(json?json.data.filter(petDef=>petDef.owner!=App.userName).map(petDef=>new PetDefinition({...petDef,name:profanityCleaner.clean(sanitize(petDef.name)),owner:profanityCleaner.clean(sanitize(petDef.owner)),sprite:sanitize(petDef.sprite),ownerId:petDef.ownerId,interactions:petDef.interactions}).setStats({is_ghost:petDef.is_ghost||0})):void 0))},addInteraction:ownerId=>{const params=new URLSearchParams({action:"addUserInteraction",ownerId:ownerId,interactingUserId:App.apiService._getUid()});return App.apiService.sendRequest(params)}}};window.addEventListener("beforeinstallprompt",e=>{e.preventDefault(),App.deferredInstallPrompt=e;let checkTries=10;const checkForAwayTimeAndInit=()=>{checkTries--<0||(App.awayTime?App.addEvent("pwa_install_notice_01",()=>{App.displayConfirm("Установить <b>Tamaweb</b> как приложение?",[{name:"Установить",onclick:()=>{App.installAsPWA()}},{name:"cancel",class:"back-btn",onclick:()=>{App.displayPopup("Установить игру как приложение можно в любое время в <b>настройках</b>")}}])}):setTimeout(checkForAwayTimeAndInit,500))};checkForAwayTimeAndInit()});